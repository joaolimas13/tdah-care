<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TDAH Care</title>
<style>
/* Estilos existentes */
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --primary: #1565C0; --primary-light: #1976D2; --primary-dark: #0D47A1;
  --accent: #29B6F6; --bg: #F0F4F8; --text: #1A237E; --text-light: #546E7A;
  --success: #2E7D32; --shadow: 0 2px 12px rgba(21,101,192,0.10); --radius: 16px;
}
body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; max-width: 430px; margin: 0 auto; }
.header { background: linear-gradient(135deg, var(--primary-dark), var(--primary-light)); color: white; padding: 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.header h1 { font-size: 1.3rem; font-weight: 700; }
.header span { font-size: 0.8rem; opacity: 0.85; display: block; }
.nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: white; display: flex; box-shadow: 0 -2px 12px rgba(21,101,192,0.12); z-index: 100; }
.nav-btn { flex: 1; padding: 10px 2px; border: none; background: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 3px; font-size: 0.6rem; color: var(--text-light); transition: all 0.2s; }
.nav-btn .icon { font-size: 1.3rem; }
.nav-btn.active { color: var(--primary); }
.nav-btn.active .icon { transform: translateY(-2px); }
.nav-btn.caverna-nav { background: linear-gradient(135deg, #1A1A2E, #16213E); color: #E0E0FF; }
.nav-btn.caverna-nav.active { color: #A78BFA; }
.page { display: none; padding: 20px; padding-bottom: 85px; }
.page.active { display: block; }
.card { background: white; border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow); }
.card-title { font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 14px; }
.greeting { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
.greeting h2 { font-size: 1.2rem; margin-bottom: 4px; }
.greeting p { font-size: 0.85rem; opacity: 0.9; }
.stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.stat-card { background: white; border-radius: 12px; padding: 14px 10px; text-align: center; box-shadow: var(--shadow); }
.stat-icon { font-size: 1.5rem; margin-bottom: 4px; }
.stat-value { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
.stat-label { font-size: 0.65rem; color: var(--text-light); }
.form-group { margin-bottom: 16px; }
label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text); }
input, select, textarea { width: 100%; padding: 12px 14px; border: 2px solid #E3EAF2; border-radius: 10px; font-size: 0.95rem; outline: none; transition: border 0.2s; background: #F8FAFF; }
input:focus, select:focus, textarea:focus { border-color: var(--primary); background: white; }
textarea { resize: none; height: 80px; }
.btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
.btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; }
.btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
.remedio-card { background: linear-gradient(135deg, #E3F2FD, #F0F7FF); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; border: 2px solid #BBDEFB; }
.remedio-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
.remedio-title { font-weight: 700; color: var(--primary); font-size: 0.95rem; }
.remedio-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
.badge-ativo { background: #E8F5E9; color: #2E7D32; }
.badge-inativo { background: #FFEBEE; color: #C62828; }
.badge-encerrado { background: #FFF8E1; color: #F57F17; }
.remedio-progress-bar { height: 14px; background: #E3EAF2; border-radius: 7px; overflow: hidden; }
.remedio-progress-fill { height: 100%; border-radius: 7px; transition: width 1s ease; position: relative; }
.remedio-progress-fill::after { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent); animation: shimmer 2s infinite; }
@keyframes shimmer { 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }
.remedio-info-row { display: flex; justify-content: space-between; font-size: 0.78rem; color: var(--text-light); margin-top: 6px; }
.remedio-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
.remedio-stat { background: white; border-radius: 10px; padding: 10px; text-align: center; }
.remedio-stat .val { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
.remedio-stat .lbl { font-size: 0.7rem; color: var(--text-light); }
.aviso-encerrado { background: #FFF8E1; border: 2px solid #FFE082; border-radius: 12px; padding: 16px; margin-top: 12px; display: none; }
.aviso-encerrado h4 { color: #F57F17; font-size: 0.9rem; margin-bottom: 8px; }
.aviso-encerrado p { font-size: 0.82rem; color: #5D4037; line-height: 1.6; }
.aviso-encerrado.show { display: block; }
.time-input-wrap { display: flex; gap: 10px; align-items: flex-end; }
.time-input-wrap input[type="time"] { flex: 1; }
.time-input-wrap button { padding: 12px 18px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 0.9rem; font-weight: 700; cursor: pointer; white-space: nowrap; }
.sono-visual { display: flex; align-items: center; justify-content: center; gap: 16px; padding: 16px 0; }
.sono-circle { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-dark), var(--accent)); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 16px rgba(21,101,192,0.35); }
.sono-circle .horas { font-size: 1.8rem; font-weight: 800; }
.sono-circle .label { font-size: 0.65rem; opacity: 0.85; }
.sono-info p { font-size: 0.85rem; color: var(--text-light); margin-bottom: 4px; }
.sono-info strong { color: var(--primary); }
.hours-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 10px 0; }
.hour-btn { padding: 10px; border: 2px solid #E3EAF2; border-radius: 10px; background: #F8FAFF; font-size: 0.85rem; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s; color: var(--text); }
.hour-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
.custom-hours { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
.custom-hours input { flex: 1; }
.custom-hours span { font-size: 0.85rem; color: var(--text-light); white-space: nowrap; }
.meta-item { display: flex; align-items: center; gap: 12px; padding: 14px; background: #F8FAFF; border-radius: 12px; margin-bottom: 10px; border: 2px solid transparent; transition: all 0.2s; cursor: pointer; }
.meta-item.done { background: #E8F5E9; border-color: #A5D6A7; }
.meta-check { width: 26px; height: 26px; border-radius: 50%; border: 2px solid #B0BEC5; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0; }
.meta-item.done .meta-check { background: var(--success); border-color: var(--success); color: white; }
.meta-text { flex: 1; }
.meta-title { font-size: 0.9rem; font-weight: 600; }
.meta-sub { font-size: 0.75rem; color: var(--text-light); }
.progress-bar { height: 8px; background: #E3EAF2; border-radius: 4px; overflow: hidden; margin: 8px 0; }
.progress-fill { height: 100%; background: linear-gradient(to right, var(--primary), var(--accent)); border-radius: 4px; transition: width 0.4s; }
.progress-info { display: flex; justify-content: space-between; font-size: 0.78rem; color: var(--text-light); }
.add-meta { display: flex; gap: 8px; margin-bottom: 16px; }
.add-meta input { flex: 1; }
.add-meta button { padding: 12px 16px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1.2rem; cursor: pointer; }
.historico-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #EEF2F7; }
.historico-item:last-child { border-bottom: none; }
.historico-data { font-size: 0.8rem; color: var(--text-light); }
.badge { padding: 3px 10px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; }
.badge-good { background: #E8F5E9; color: #2E7D32; }
.badge-warn { background: #FFF8E1; color: #F57F17; }
.badge-bad { background: #FFEBEE; color: #C62828; }
.info-tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; }
.info-tab { padding: 8px 14px; border-radius: 20px; border: 2px solid #E3EAF2; background: white; font-size: 0.8rem; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
.info-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
.info-content { display: none; }
.info-content.active { display: block; }
.info-card { background: #F0F7FF; border-left: 4px solid var(--primary); border-radius: 0 12px 12px 0; padding: 16px; margin-bottom: 12px; }
.info-card h3 { font-size: 0.95rem; color: var(--primary); margin-bottom: 8px; }
.info-card p { font-size: 0.85rem; color: var(--text-light); line-height: 1.6; }
.info-tip { background: #FFF8E1; border-left: 4px solid #FFB300; border-radius: 0 12px 12px 0; padding: 12px 16px; margin-bottom: 10px; font-size: 0.83rem; color: #5D4037; line-height: 1.5; }
.toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #1A237E; color: white; padding: 12px 24px; border-radius: 24px; font-size: 0.85rem; font-weight: 600; z-index: 999; opacity: 0; transition: opacity 0.3s; white-space: nowrap; box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
.toast.show { opacity: 1; }
.section-title { font-size: 1rem; font-weight: 700; color: var(--text); margin-bottom: 12px; }
.divider { height: 1px; background: #EEF2F7; margin: 16px 0; }
.btn-danger { background: transparent; border: 2px solid #EF5350; color: #EF5350; border-radius: 12px; padding: 10px; font-size: 0.8rem; font-weight: 700; cursor: pointer; width: 100%; margin-top: 8px; }
.meta-hist-card { background: #F8FAFF; border-radius: 12px; padding: 12px 14px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #E3EAF2; }
/* CAVERNA */
#page-caverna { background: #0D0D1A; min-height: 100vh; padding: 20px; padding-bottom: 85px; color: #E0E0FF; }
.caverna-header { text-align: center; margin-bottom: 24px; }
.caverna-header h2 { font-size: 1.5rem; font-weight: 800; background: linear-gradient(135deg, #A78BFA, #60A5FA); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 4px; }
.caverna-header p { font-size: 0.8rem; color: #6B7280; }
.caverna-status-badge { display: block; padding: 6px 16px; border-radius: 20px; font-size: 0.78rem; font-weight: 700; margin-bottom: 24px; text-align: center; }
.status-foco { background: rgba(167,139,250,0.15); color: #A78BFA; border: 1px solid rgba(167,139,250,0.3); }
.status-pausa { background: rgba(96,165,250,0.15); color: #60A5FA; border: 1px solid rgba(96,165,250,0.3); }
.status-idle { background: rgba(107,114,128,0.15); color: #9CA3AF; border: 1px solid rgba(107,114,128,0.3); }
.caverna-timer-wrap { display: flex; justify-content: center; margin-bottom: 32px; }
.caverna-ring { position: relative; width: 220px; height: 220px; }
.caverna-ring svg { position: absolute; top: 0; left: 0; width: 220px; height: 220px; transform: rotate(-90deg); }
.caverna-ring-bg { fill: none; stroke: #1E1E3A; stroke-width: 12; }
.caverna-ring-fill { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 1s linear, stroke 0.5s; }
.caverna-center { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.caverna-time { font-size: 3.2rem; font-weight: 800; color: white; letter-spacing: -2px; line-height: 1; }
.caverna-phase { font-size: 0.75rem; color: #6B7280; margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }
.caverna-controls { display: flex; gap: 16px; justify-content: center; margin-bottom: 28px; }
.caverna-btn { width: 64px; height: 64px; border-radius: 50%; border: none; cursor: pointer; font-size: 1.6rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.caverna-btn-main { width: 80px; height: 80px; font-size: 2rem; background: linear-gradient(135deg, #7C3AED, #4F46E5); color: white; box-shadow: 0 0 30px rgba(124,58,237,0.4); }
.caverna-btn-skip, .caverna-btn-reset { background: rgba(30,30,58,0.8); color: #9CA3AF; border: 1px solid #2D2D4E; }
.caverna-stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.caverna-stat-box { background: rgba(30,30,58,0.6); border: 1px solid #2D2D4E; border-radius: 14px; padding: 14px 10px; text-align: center; }
.caverna-stat-box .v { font-size: 1.3rem; font-weight: 800; color: #A78BFA; display: block; }
.caverna-stat-box .l { font-size: 0.62rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
.caverna-card-dark { background: rgba(20,20,40,0.8); border: 1px solid #2D2D4E; border-radius: 14px; padding: 16px; margin-bottom: 16px; }
.caverna-card-title { font-size: 0.78rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
.session-dot-row { display: flex; gap: 8px; }
.session-dot { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; border: 2px solid #2D2D4E; color: #4B5563; }
.session-dot.completo { background: rgba(124,58,237,0.2); border-color: #7C3AED; color: #A78BFA; }
.session-dot.atual { background: rgba(124,58,237,0.4); border-color: #A78BFA; color: white; animation: pulse-dot 1.5s infinite; }
@keyframes pulse-dot { 0%,100%{box-shadow:0 0 0 0 rgba(167,139,250,0.4)} 50%{box-shadow:0 0 0 6px rgba(167,139,250,0)} }
.cav-input-row { display: flex; gap: 8px; align-items: center; }
.cav-input-row input { flex: 1; background: rgba(30,30,58,0.8); border: 1px solid #3D3D6E; color: #E0E0FF; border-radius: 10px; padding: 10px 14px; font-size: 0.95rem; }
.cav-input-row input::placeholder { color: #4B5563; }
.cav-input-row button { background: linear-gradient(135deg, #7C3AED, #4F46E5); color: white; border: none; border-radius: 10px; padding: 10px 14px; font-size: 0.85rem; font-weight: 700; cursor: pointer; }
.celular-home-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
.celular-home-row input { width: 70px; flex: none; }
.celular-home-row button { padding: 12px 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 0.85rem; font-weight: 700; cursor: pointer; }
.relatorio-btn { background: linear-gradient(135deg, #1565C0, #29B6F6); color: white; border: none; border-radius: 14px; padding: 16px; width: 100%; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 16px; box-shadow: 0 4px 16px rgba(21,101,192,0.3); }
.relatorio-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 200; align-items: flex-end; justify-content: center; }
.relatorio-modal.show { display: flex; }
.relatorio-content { background: white; border-radius: 24px 24px 0 0; padding: 24px; width: 100%; max-width: 430px; max-height: 88vh; overflow-y: auto; animation: slideUp 0.3s ease; }
@keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
.relatorio-title { font-size: 1.2rem; font-weight: 800; color: var(--text); margin-bottom: 4px; }
.relatorio-date { font-size: 0.8rem; color: var(--text-light); margin-bottom: 20px; }
.rel-section { background: #F8FAFF; border-radius: 14px; padding: 16px; margin-bottom: 12px; border-left: 4px solid var(--primary); }
.rel-section h3 { font-size: 0.9rem; font-weight: 700; color: var(--primary); margin-bottom: 10px; }
.rel-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #EEF2F7; font-size: 0.85rem; }
.rel-row:last-child { border-bottom: none; }
.rel-row .rl { color: var(--text-light); }
.rel-row .rv { font-weight: 700; color: var(--text); }
.rel-avaliacao { background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 14px; padding: 20px; text-align: center; color: white; margin-bottom: 12px; }
.rel-nota { font-size: 2.8rem; font-weight: 800; }
.rel-nota-label { font-size: 0.85rem; opacity: 0.9; }
.rel-close-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 8px; }

/* Novos estilos para o calend√°rio */
.calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.calendar-nav button { background: none; border: none; font-size: 1.5rem; color: var(--primary); cursor: pointer; padding: 5px; }
.calendar-nav h3 { font-size: 1.1rem; color: var(--text); }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
.calendar-day-header { font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; margin-bottom: 8px; }
.calendar-day { padding: 8px 4px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; background: #F8FAFF; color: var(--text); }
.calendar-day.inactive { color: #B0BEC5; cursor: default; background: #EEF2F7; }
.calendar-day.today { border: 2px solid var(--primary); background: var(--primary-light); color: white; }
.calendar-day.selected { background: var(--accent); color: white; }
.calendar-day:not(.inactive):hover { background: var(--primary-light); color: white; }
.calendar-day-metrics { font-size: 0.65rem; line-height: 1.2; margin-top: 2px; color: var(--text-light); }
.calendar-day.today .calendar-day-metrics, .calendar-day.selected .calendar-day-metrics { color: rgba(255,255,255,0.8); }
.calendar-day-metrics span { display: block; }
.calendar-day-metrics .metric-good { color: #A5D6A7; }
.calendar-day-metrics .metric-warn { color: #FFD54F; }
.calendar-day-metrics .metric-bad { color: #EF9A9A; }

/* Estilos para o relat√≥rio mensal */
.relatorio-mensal-card { background: white; border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow); }
.relatorio-mensal-card h3 { font-size: 1rem; font-weight: 700; color: var(--text); margin-bottom: 12px; }
.relatorio-mensal-card .summary-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #EEF2F7; }
.relatorio-mensal-card .summary-item:last-child { border-bottom: none; }
.relatorio-mensal-card .summary-label { font-size: 0.85rem; color: var(--text-light); }
.relatorio-mensal-card .summary-value { font-size: 0.95rem; font-weight: 700; color: var(--primary); }
.relatorio-mensal-card .summary-tip { font-size: 0.8rem; color: var(--text-light); margin-top: 10px; line-height: 1.5; }
</style>
</head>
<body>
<div class="header">
  <div><h1>üß† TDAH Care</h1><span id="header-date"></span></div>
  <div style="font-size:2rem;">üë§</div>
</div>

<!-- HOME -->
<div class="page active" id="page-home">
  <div class="greeting"><h2 id="greeting-text">Ol√°! üëã</h2><p>Acompanhe seu dia com TDAH</p></div>
  <div class="stats-row">
    <div class="stat-card"><div class="stat-icon">üò¥</div><div class="stat-value" id="stat-sono">‚Äî</div><div class="stat-label">Sono</div></div>
    <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-value" id="stat-metas">0/0</div><div class="stat-label">Metas</div></div>
    <div class="stat-card"><div class="stat-icon">üíä</div><div class="stat-value" id="stat-remedio">‚Äî</div><div class="stat-label">Rem√©dio</div></div>
  </div>
  <div class="remedio-card">
    <div class="remedio-header">
      <div><div class="remedio-title">üíä Venvanse (Lisdexanfetamina)</div><div style="font-size:0.75rem;color:var(--text-light);">Dura√ß√£o: 12 horas</div></div>
      <span class="remedio-badge badge-inativo" id="remedio-badge">N√£o registrado</span>
    </div>
    <div id="remedio-sem-registro">
      <p style="font-size:0.82rem;color:var(--text-light);margin-bottom:10px;">Registre o hor√°rio que tomou o rem√©dio:</p>
      <div class="time-input-wrap"><input type="time" id="hora-remedio"><button onclick="registrarRemedio()">üíä Tomei</button></div>
    </div>
    <div id="remedio-com-registro" style="display:none;">
      <div style="display:flex;justify-content:space-between;font-size:0.8rem;margin-bottom:8px;">
        <span style="color:var(--text-light);">Tomado √†s <strong id="hora-tomada-display">‚Äî</strong></span>
        <span style="color:var(--text-light);">Encerra √†s <strong id="hora-encerra-display">‚Äî</strong></span>
      </div>
      <div class="remedio-progress-bar"><div class="remedio-progress-fill" id="remedio-fill" style="width:0%"></div></div>
      <div class="remedio-info-row"><span id="tempo-ativo-label">0h no organismo</span><span id="tempo-restante-label">12h restantes</span></div>
      <div class="remedio-stats">
        <div class="remedio-stat"><div class="val" id="tempo-ativo-val">0h 00min</div><div class="lbl">Tempo ativo</div></div>
        <div class="remedio-stat"><div class="val" id="tempo-restante-val">12h 00min</div><div class="lbl">Tempo restante</div></div>
      </div>
      <div class="aviso-encerrado" id="aviso-encerrado">
        <h4>‚ö†Ô∏è Efeito do rem√©dio encerrado</h4>
        <p>O Venvanse completou suas 12h de a√ß√£o. √â normal sentir cansa√ßo, irritabilidade leve e retorno da fome.<br><br>üí° <strong>Dica:</strong> Evite tarefas de alto foco agora. Descanse e alimente-se bem.</p>
      </div>
      <button class="btn-danger" onclick="resetarRemedio()">üîÑ Registrar nova dose</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title">üìä Progresso de hoje</div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    <div class="progress-info"><span id="progress-text">0 de 0 metas conclu√≠das</span><span id="progress-pct">0%</span></div>
  </div>
  <div class="card">
    <div class="card-title">üì± Tempo de tela hoje</div>
    <div id="celular-home-display">
      <p style="color:var(--text-light);font-size:0.82rem;margin-bottom:8px;">Quanto tempo voc√™ usou o celular hoje?</p>
      <div class="celular-home-row">
        <input type="number" id="celular-horas" placeholder="0" min="0" max="24">
        <span style="color:var(--text-light);font-size:0.85rem;">h</span>
        <input type="number" id="celular-minutos" placeholder="0" min="0" max="59">
        <span style="color:var(--text-light);font-size:0.85rem;">min</span>
        <button onclick="salvarCelular()">üíæ Salvar</button>
      </div>
    </div>
    <div id="celular-registrado-home" style="display:none;"></div>
  </div>
  <div class="card">
    <div class="card-title">üìÖ √öltimo sono registrado</div>
    <div id="ultimo-sono-home"><p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:8px;">Nenhum registro ainda</p></div>
  </div>
  <button class="relatorio-btn" onclick="abrirRelatorio()">üìä Gerar Relat√≥rio do Dia</button>
</div>

<!-- SONO -->
<div class="page" id="page-sono">
  <div class="section-title">üò¥ Registrar Sono</div>
  <div class="card">
    <div class="sono-visual">
      <div class="sono-circle"><span class="horas" id="sono-display">‚Äî</span><span class="label">de sono</span></div>
      <div class="sono-info">
        <p>Recomendado: <strong>7-9 horas</strong></p>
        <p style="font-size:0.8rem;color:var(--text-light);margin-top:6px;">Sono regular melhora foco e resposta ao medicamento.</p>
      </div>
    </div>
    <div class="form-group">
      <label>‚è∞ Quantas horas dormiu?</label>
      <div class="hours-grid" id="hours-grid"></div>
      <div class="custom-hours"><input type="number" id="horas-custom" placeholder="Outro valor..." min="0" max="24" step="0.5" oninput="selecionarHoraCustom(this.value)"><span>horas</span></div>
    </div>
    <div class="form-group">
      <label>üò¥ Qualidade do sono</label>
      <select id="sono-qualidade">
        <option value="otima">üòä √ìtima ‚Äî Acordei muito descansado</option>
        <option value="boa" selected>üôÇ Boa ‚Äî Acordei bem</option>
        <option value="regular">üòê Regular ‚Äî Cansado mas ok</option>
        <option value="ruim">üòî Ruim ‚Äî Muito cansado</option>
        <option value="pessima">üò´ P√©ssima ‚Äî Mal consegui dormir</option>
      </select>
    </div>
    <div class="form-group"><label>üìù Observa√ß√µes (opcional)</label><textarea id="sono-obs" placeholder="Ex: Acordei v√°rias vezes..."></textarea></div>
    <button class="btn btn-primary" onclick="salvarSono()">üíæ Salvar Registro</button>
  </div>
  <div class="card"><div class="card-title">üìÖ √öltimos registros</div><div id="historico-sono"><p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">Nenhum registro ainda</p></div></div>
</div>

<!-- METAS -->
<div class="page" id="page-metas">
  <div class="section-title">üéØ Minhas Metas</div>
  <div class="card"><div class="card-title">‚ûï Nova meta</div>
    <div class="add-meta"><input type="text" id="nova-meta-input" placeholder="Ex: Beber √°gua, Meditar..."><button onclick="adicionarMeta()">+</button></div>
  </div>
  <div class="card">
    <div class="card-title">üìã Metas de hoje</div>
    <div class="progress-bar" style="margin-bottom:8px;"><div class="progress-fill" id="meta-progress" style="width:0%"></div></div>
    <div class="progress-info" style="margin-bottom:16px;"><span id="meta-info">0 conclu√≠das</span><span id="meta-pct">0%</span></div>
    <div id="lista-metas"></div>
    <div class="divider"></div>
    <button class="btn btn-outline" onclick="limparConcluidas()" style="margin-top:8px;">üóëÔ∏è Limpar conclu√≠das</button>
  </div>
  <div class="card">
    <div class="card-title">üìÖ Hist√≥rico de metas (dias anteriores)</div>
    <div id="historico-metas-lista"><p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">O hist√≥rico aparecer√° aqui a partir de amanh√£.</p></div>
  </div>
  <div class="card"><div class="card-title">üí° Dica</div>
    <div style="background:#FFF8E1;border-left:4px solid #FFB300;border-radius:0 12px 12px 0;padding:12px 16px;font-size:0.83rem;color:#5D4037;line-height:1.5;"><strong>TDAH e metas:</strong> Divida tarefas grandes em passos pequenos. Cada ‚úÖ libera dopamina!</div>
  </div>
</div>

<!-- CALEND√ÅRIO -->
<div class="page" id="page-calendario">
  <div class="section-title">üóìÔ∏è Hist√≥rico Di√°rio</div>
  <div class="card">
    <div class="calendar-nav">
      <button onclick="changeMonth(-1)">‚óÄ</button>
      <h3 id="current-month-year"></h3>
      <button onclick="changeMonth(1)">‚ñ∂</button>
    </div>
    <div class="calendar-grid" id="calendar-grid-headers">
      <div class="calendar-day-header">Dom</div>
      <div class="calendar-day-header">Seg</div>
      <div class="calendar-day-header">Ter</div>
      <div class="calendar-day-header">Qua</div>
      <div class="calendar-day-header">Qui</div>
      <div class="calendar-day-header">Sex</div>
      <div class="calendar-day-header">S√°b</div>
    </div>
    <div class="calendar-grid" id="calendar-grid-days">
      <!-- Dias do calend√°rio ser√£o inseridos aqui -->
    </div>
  </div>
  <div class="card" id="daily-summary-card" style="display:none;">
    <div class="card-title">Sum√°rio do dia <span id="summary-date"></span></div>
    <div id="daily-summary-content">
      <!-- Conte√∫do do sum√°rio di√°rio ser√° inserido aqui -->
    </div>
  </div>
</div>

<!-- CAVERNA -->
<div class="page" id="page-caverna">
  <div class="caverna-header"><h2>üèîÔ∏è Modo Caverna</h2><p>Pomodoro 20min foco / 5min pausa</p></div>
  <div style="text-align:center;"><span class="caverna-status-badge status-idle" id="caverna-status-badge">‚è∏ Aguardando in√≠cio</span></div>
  <div class="caverna-timer-wrap">
    <div class="caverna-ring">
      <svg viewBox="0 0 220 220"><circle class="caverna-ring-bg" cx="110" cy="110" r="96"/><circle class="caverna-ring-fill" id="caverna-ring-fill" cx="110" cy="110" r="96" stroke="#A78BFA" stroke-dasharray="603.19" stroke-dashoffset="0"/></svg>
      <div class="caverna-center"><div class="caverna-time" id="caverna-time-display">20:00</div><div class="caverna-phase" id="caverna-phase-label">FOCO</div></div>
    </div>
  </div>
  <div class="caverna-controls">
    <button class="caverna-btn caverna-btn-reset" onclick="resetarPomodoro()" title="Reiniciar">üîÑ</button>
    <button class="caverna-btn caverna-btn-main" id="caverna-play-btn" onclick="togglePomodoro()">‚ñ∂</button>
    <button class="caverna-btn caverna-btn-skip" onclick="pularFase()" title="Pular fase">‚è≠</button>
  </div>
  <div class="caverna-stats-grid">
    <div class="caverna-stat-box"><span class="v" id="cav-sessoes">0</span><span class="l">Sess√µes</span></div>
    <div class="caverna-stat-box"><span class="v" id="cav-foco-total">0min</span><span class="l">Foco hoje</span></div>
    <div class="caverna-stat-box"><span class="v" id="cav-ciclos">0</span><span class="l">Ciclos</span></div>
  </div>
  <div class="caverna-card-dark"><div class="caverna-card-title">üîµ Sess√µes do ciclo atual (4 = 1 ciclo)</div><div class="session-dot-row" id="session-dots"></div></div>
  <div class="caverna-card-dark">
    <div class="caverna-card-title">üì± Tempo de celular hoje</div>
    <div id="cav-celular-form">
      <div class="cav-input-row">
        <input type="number" id="cav-cel-h" placeholder="Horas" min="0" max="24">
        <span style="color:#6B7280;font-size:0.85rem;">h</span>
        <input type="number" id="cav-cel-m" placeholder="Min" min="0" max="59">
        <span style="color:#6B7280;font-size:0.85rem;">min</span>
        <button onclick="salvarCelularCaverna()">üíæ</button>
      </div>
    </div>
    <div id="cav-celular-registrado" style="display:none;"></div>
  </div>
</div>

<!-- INFO -->
<div class="page" id="page-info">
  <div class="section-title">üìö Informa√ß√µes</div>
  <div class="info-tabs">
    <button class="info-tab active" onclick="switchInfo('sono',this)">üò¥ Sono</button>
    <button class="info-tab" onclick="switchInfo('eletrolitos',this)">üíß Eletr√≥litos</button>
    <button class="info-tab" onclick="switchInfo('remedio',this)">üíä Medica√ß√£o</button>
    <button class="info-tab" onclick="switchInfo('estrategias',this)">üß† Estrat√©gias</button>
    <button class="info-tab" onclick="switchInfo('mensal',this)">üìà Mensal</button> <!-- Nova aba -->
  </div>
  <div class="info-content active" id="info-sono">
    <div class="info-card"><h3>üåô Por que o sono √© crucial no TDAH?</h3><p>Priva√ß√£o de sono agrava desaten√ß√£o, impulsividade e regula√ß√£o emocional ‚Äî j√° comprometidas no TDAH.</p></div>
    <div class="info-tip"><strong>‚úÖ Recomenda√ß√£o:</strong> 7-9 horas com hor√°rios consistentes, mesmo nos fins de semana.</div>
    <div class="info-card"><h3>üì± Higiene do sono</h3><p>Evite telas 1 hora antes de dormir. A luz azul inibe a melatonina. Crie rotina: banho morno, leitura leve, ambiente fresco.</p></div>
    <div class="info-tip"><strong>‚ö†Ô∏è Aten√ß√£o:</strong> Estimulantes tomados tarde dificultam o sono. Converse com seu m√©dico.</div>
  </div>
  <div class="info-content" id="info-eletrolitos">
    <div class="info-card"><h3>üíß Hidrata√ß√£o e TDAH</h3><p>Desidrata√ß√£o leve (1-2%) j√° impacta concentra√ß√£o e mem√≥ria ‚Äî fun√ß√µes comprometidas no TDAH.</p></div>
    <div class="info-tip"><strong>‚úÖ Meta:</strong> 2-3 litros de √°gua por dia.</div>
    <div class="info-card"><h3>üßÇ Eletr√≥litos importantes</h3><p><strong>Magn√©sio:</strong> Reduz hiperatividade, melhora sono.<br><br><strong>Zinco:</strong> Relacionado √† s√≠ntese de dopamina.<br><br><strong>Ferro:</strong> Defici√™ncia agrava TDAH. Avalie com seu m√©dico.</p></div>
    <div class="info-tip"><strong>‚ö†Ô∏è Importante:</strong> N√£o inicie suplementa√ß√£o sem orienta√ß√£o m√©dica.</div>
  </div>
  <div class="info-content" id="info-remedio">
    <div class="info-card"><h3>üíä Venvanse ‚Äî Como funciona</h3><p>Pr√≥-f√°rmaco ativado no organismo. In√≠cio em 1-2h, pico entre 3-5h, dura√ß√£o total de at√© 12h.</p></div>
    <div class="info-tip"><strong>‚úÖ Hor√°rio ideal:</strong> Tome ao acordar. Consist√™ncia maximiza o efeito terap√™utico.</div>
    <div class="info-card"><h3>üçΩÔ∏è Alimenta√ß√£o e medica√ß√£o</h3><p>Estimulantes reduzem apetite. Tome caf√© da manh√£ nutritivo ANTES da dose.</p></div>
    <div class="info-tip"><strong>‚ö†Ô∏è Nunca</strong> ajuste doses sem consultar seu m√©dico.</div>
    <div class="info-card"><h3>üåô Rebote ao fim do efeito</h3><p>Retorno dos sintomas, irritabilidade leve e fome s√£o normais. Planeje atividades de menor demanda cognitiva para esse per√≠odo.</p></div>
  </div>
  <div class="info-content" id="info-estrategias">
    <div class="info-card"><h3>‚è±Ô∏è Modo Caverna ‚Äî Pomodoro 20/5</h3><p>20min de foco + 5min de pausa. Para TDAH, sess√µes mais curtas s√£o mais eficazes que longas. Ap√≥s 4 sess√µes (1 ciclo), fa√ßa uma pausa maior de 15-20min.</p></div>
    <div class="info-card"><h3>üìù Body doubling</h3><p>Estudar na presen√ßa de outra pessoa (mesmo virtual) aumenta foco no TDAH.</p></div>
    <div class="info-tip"><strong>‚úÖ Organiza√ß√£o:</strong> Listas curtas de 3-5 itens. Muitas tarefas vis√≠veis sobrecarregam.</p></div>
    <div class="info-card"><h3>üéµ M√∫sica e foco</h3><p>Lo-fi, instrumentais ou ru√≠do branco melhoram concentra√ß√£o. Evite letras em tarefas de leitura.</p></div>
  </div>
  <!-- Novo conte√∫do para o relat√≥rio mensal -->
  <div class="info-content" id="info-mensal">
    <div class="relatorio-mensal-card">
      <h3>üìà Relat√≥rio Mensal (√öltimos 30 dias)</h3>
      <div id="relatorio-mensal-content">
        <p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">Gerando relat√≥rio...</p>
      </div>
      <div class="summary-tip">
        Este relat√≥rio mostra suas m√©dias e progressos nos √∫ltimos 30 dias. Use-o para identificar padr√µes e ajustar suas estrat√©gias.
      </div>
    </div>
  </div>
</div>

<!-- RELAT√ìRIO MODAL -->
<div class="relatorio-modal" id="relatorio-modal" onclick="fecharRelatorio(event)">
  <div class="relatorio-content">
    <div class="relatorio-title">üìä Relat√≥rio do Dia</div>
    <div class="relatorio-date" id="relatorio-date"></div>
    <div id="relatorio-body"></div>
    <button class="rel-close-btn" onclick="document.getElementById('relatorio-modal').classList.remove('show')">‚úï Fechar</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<div class="nav">
  <button class="nav-btn active" onclick="navigate('home',this)"><span class="icon">üè†</span><span>In√≠cio</span></button>
  <button class="nav-btn" onclick="navigate('sono',this)"><span class="icon">üò¥</span><span>Sono</span></button>
  <button class="nav-btn" onclick="navigate('metas',this)"><span class="icon">üéØ</span><span>Metas</span></button>
  <button class="nav-btn" onclick="navigate('calendario',this)"><span class="icon">üóìÔ∏è</span><span>Hist√≥rico</span></button> <!-- Novo bot√£o -->
  <button class="nav-btn caverna-nav" onclick="navigate('caverna',this)"><span class="icon">üèîÔ∏è</span><span>Caverna</span></button>
  <button class="nav-btn" onclick="navigate('info',this)"><span class="icon">üìö</span><span>Info</span></button>
</div>

<script>
const DUR_REM = 12*60, POM_FOCO = 20*60, POM_PAUSA = 5*60, SESS_CICLO = 4;
const CIRC = 2*Math.PI*96;
const METAS_DEF = [
  {id:1,texto:'Tomar medica√ß√£o',done:false},
  {id:2,texto:'Beber 2L de √°gua',done:false},
  {id:3,texto:'Fazer 30min de exerc√≠cio',done:false},
  {id:4,texto:'Dormir antes das 23h',done:false},
];

let state = {
  // dailyData armazenar√° todas as m√©tricas por data ISO
  dailyData: {}, // { 'YYYY-MM-DD': { sono: [], remedio: {}, metas: [], celular: {}, pom: {} } }
  currentDate: hojeISO(), // Data atualmente selecionada/exibida
  sono:[], horasSono:null, metas:[], metasHist:[],
  remedio:null, remedioTimer:null, celular:null,
  pom:{rodando:false,fase:'foco',seg:POM_FOCO,sessoes:0,ciclos:0,sessNoCiclo:0,minFoco:0,timer:null,data:null}
};

// Vari√°veis para o calend√°rio
let currentCalendarDate = new Date(); // Para controlar o m√™s exibido no calend√°rio

function hoje(){ return new Date().toLocaleDateString('pt-BR'); }
function hojeISO(date = new Date()){ return date.getFullYear()+'-'+pad(date.getMonth()+1)+'-'+pad(date.getDate()); }
function pad(n){ return String(n).padStart(2,'0'); }
function fmt(d){ return d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); }
function showToast(m){ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }

// --- Fun√ß√µes de Persist√™ncia de Dados ---
function salvar() {
  // Salva o estado atual do dia na dailyData
  state.dailyData[state.currentDate] = {
    sono: state.sono,
    remedio: state.remedio ? { ...state.remedio, horaRegistro: state.remedio.horaRegistro.toISOString() } : null,
    metas: state.metas,
    celular: state.celular,
    pom: {
      sessoes: state.pom.sessoes,
      ciclos: state.pom.ciclos,
      sessNoCiclo: state.pom.sessNoCiclo,
      minFoco: state.pom.minFoco,
      data: state.pom.data || hojeISO()
    }
  };
  localStorage.setItem('tdah_daily_data', JSON.stringify(state.dailyData));
  localStorage.setItem('tdah_mhist', JSON.stringify(state.metasHist)); // Hist√≥rico de metas √© global
}

function carregar() {
  try {
    const storedDailyData = localStorage.getItem('tdah_daily_data');
    if (storedDailyData) {
      state.dailyData = JSON.parse(storedDailyData);
      // Converte horaRegistro de volta para Date objects
      for (const date in state.dailyData) {
        if (state.dailyData[date].remedio && state.dailyData[date].remedio.horaRegistro) {
          state.dailyData[date].remedio.horaRegistro = new Date(state.dailyData[date].remedio.horaRegistro);
        }
      }
    }

    const hraw = localStorage.getItem('tdah_mhist');
    if (hraw) state.metasHist = JSON.parse(hraw);

    // L√≥gica para migrar metas do dia anterior para o hist√≥rico, se a data mudou
    const lastSavedDate = localStorage.getItem('tdah_last_saved_date');
    if (lastSavedDate && lastSavedDate !== hojeISO()) {
      const prevDayData = state.dailyData[lastSavedDate];
      if (prevDayData && prevDayData.metas && prevDayData.metas.length > 0) {
        const histEntry = {
          data: lastSavedDate,
          total: prevDayData.metas.length,
          concluidas: prevDayData.metas.filter(m => m.done).length,
          lista: prevDayData.metas.map(m => ({ t: m.texto, d: m.done }))
        };
        state.metasHist.unshift(histEntry);
        if (state.metasHist.length > 30) state.metasHist.splice(30); // Manter os √∫ltimos 30 dias
      }
    }
    localStorage.setItem('tdah_last_saved_date', hojeISO()); // Atualiza a √∫ltima data salva

    // Carrega os dados do dia atual
    loadDailyMetrics(hojeISO());

  } catch (e) {
    console.error("Erro ao carregar dados:", e);
  }
}

function loadDailyMetrics(dateISO) {
  state.currentDate = dateISO;
  const data = state.dailyData[dateISO] || {};

  state.sono = data.sono || [];
  state.remedio = data.remedio || null;
  state.metas = data.metas || [...METAS_DEF]; // Se n√£o houver metas, usa as default
  state.celular = data.celular || null;
  state.pom = data.pom || {rodando:false,fase:'foco',seg:POM_FOCO,sessoes:0,ciclos:0,sessNoCiclo:0,minFoco:0,timer:null,data:dateISO};
  if (!state.pom.data) state.pom.data = dateISO; // Garante que a data do pomodoro est√° correta

  // Reinicia o timer do rem√©dio se estiver ativo e for o dia atual
  if (state.remedioTimer) clearInterval(state.remedioTimer);
  if (state.remedio && dateISO === hojeISO()) {
    state.remedioTimer = setInterval(atualizarBarra, 30000);
  }
  // Reinicia o timer do pomodoro se estiver ativo e for o dia atual
  if (state.pom.timer) clearInterval(state.pom.timer);
  if (state.pom.rodando && dateISO === hojeISO()) {
    state.pom.timer = setInterval(tickPom, 1000);
  }

  // Atualiza a UI com os dados carregados
  updateUIForCurrentDay();
}

function updateUIForCurrentDay() {
  // Atualiza elementos da p√°gina Home
  const now = new Date();
  document.getElementById('header-date').textContent = now.toLocaleDateString('pt-BR', {weekday:'long',day:'numeric',month:'long'});
  const h = now.getHours();
  document.getElementById('greeting-text').textContent = h < 12 ? 'Bom dia! üëã' : h < 18 ? 'Boa tarde! üëã' : 'Boa noite! üëã';

  // Atualiza o estado do rem√©dio
  if (state.remedio) {
    document.getElementById('remedio-sem-registro').style.display = 'none';
    document.getElementById('remedio-com-registro').style.display = 'block';
    atualizarBarra();
  } else {
    document.getElementById('remedio-sem-registro').style.display = 'block';
    document.getElementById('remedio-com-registro').style.display = 'none';
    document.getElementById('remedio-badge').textContent = 'N√£o registrado';
    document.getElementById('remedio-badge').className = 'remedio-badge badge-inativo';
    document.getElementById('aviso-encerrado').classList.remove('show');
    document.getElementById('hora-remedio').value = '';
  }

  // Renderiza todas as se√ß√µes
  renderMetas();
  renderHistSono();
  renderHistMetas();
  updateStats();
  renderCelular();
  renderPom();
}

// --- Fun√ß√µes existentes (adaptadas para usar state.currentDate e salvar()) ---

function init(){
  carregar();
  buildHoursGrid();
  updateUIForCurrentDay(); // Atualiza a UI com os dados do dia atual
  renderCalendar(currentCalendarDate); // Renderiza o calend√°rio inicial
}

function navigate(p,btn){
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active'); btn.classList.add('active');

  if (p === 'calendario') {
    renderCalendar(currentCalendarDate);
    document.getElementById('daily-summary-card').style.display = 'none'; // Esconde o sum√°rio ao navegar
  }
  if (p === 'info') {
    // Garante que a aba 'sono' esteja ativa por padr√£o ou a √∫ltima ativa
    const activeTab = document.querySelector('.info-tab.active');
    if (!activeTab) {
      switchInfo('sono', document.querySelector('.info-tab'));
    }
    // For√ßa a atualiza√ß√£o do relat√≥rio mensal ao abrir a aba INFO
    if (activeTab && activeTab.dataset.tab === 'mensal') {
      gerarRelatorioMensal();
    }
  }
}

function registrarRemedio(){
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ √© poss√≠vel registrar o rem√©dio para o dia atual!'); return; }
  const val=document.getElementById('hora-remedio').value; if(!val){showToast('‚ö†Ô∏è Informe o hor√°rio!');return;}
  const [hh,mm]=val.split(':').map(Number); const now=new Date();
  const reg=new Date(now.getFullYear(),now.getMonth(),now.getDate(),hh,mm,0);
  state.remedio={horaRegistro:reg}; salvar();
  document.getElementById('remedio-sem-registro').style.display='none';
  document.getElementById('remedio-com-registro').style.display='block';
  atualizarBarra(); if(state.remedioTimer)clearInterval(state.remedioTimer);
  state.remedioTimer=setInterval(atualizarBarra,30000); showToast('üíä Medica√ß√£o registrada!'); updateStats();
}

function atualizarBarra(){
  if(!state.remedio)return;
  const agora=new Date(), minPass=Math.floor((agora-state.remedio.horaRegistro)/60000);
  const minRest=Math.max(0,DUR_REM-minPass), pct=Math.min(100,(minPass/DUR_REM)*100);
  const horaEnc=new Date(state.remedio.horaRegistro.getTime()+DUR_REM*60000);
  document.getElementById('hora-tomada-display').textContent=fmt(state.remedio.horaRegistro);
  document.getElementById('hora-encerra-display').textContent=fmt(horaEnc);
  document.getElementById('remedio-fill').style.width=pct+'%';
  const cor=pct<40?'linear-gradient(90deg,#1565C0,#42A5F5)':pct<75?'linear-gradient(90deg,#1976D2,#26C6DA)':pct<100?'linear-gradient(90deg,#F57F17,#FFCA28)':'linear-gradient(90deg,#C62828,#EF5350)';
  document.getElementById('remedio-fill').style.background=cor;
  const hA=Math.floor(minPass/60),mA=minPass%60,hR=Math.floor(minRest/60),mR=minRest%60;
  document.getElementById('tempo-ativo-val').textContent=hA+'h '+pad(mA)+'min';
  document.getElementById('tempo-restante-val').textContent=minRest>0?hR+'h '+pad(mR)+'min':'Encerrado';
  document.getElementById('tempo-ativo-label').textContent=hA+'h no organismo';
  document.getElementById('tempo-restante-label').textContent=minRest>0?hR+'h restantes':'Efeito encerrado';
  const badge=document.getElementById('remedio-badge');
  if(minRest<=0){badge.textContent='Encerrado';badge.className='remedio-badge badge-encerrado';document.getElementById('aviso-encerrado').classList.add('show');document.getElementById('stat-remedio').textContent='Enc.';}
  else{badge.textContent='Ativo';badge.className='remedio-badge badge-ativo';document.getElementById('aviso-encerrado').classList.remove('show');document.getElementById('stat-remedio').textContent=hA+'h';}
}

function resetarRemedio(){
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ √© poss√≠vel resetar o rem√©dio para o dia atual!'); return; }
  state.remedio=null;salvar();if(state.remedioTimer)clearInterval(state.remedioTimer);
  document.getElementById('remedio-sem-registro').style.display='block';
  document.getElementById('remedio-com-registro').style.display='none';
  document.getElementById('remedio-badge').textContent='N√£o registrado';
  document.getElementById('remedio-badge').className='remedio-badge badge-inativo';
  document.getElementById('aviso-encerrado').classList.remove('show');
  document.getElementById('hora-remedio').value='';document.getElementById('stat-remedio').textContent='‚Äî';showToast('üîÑ Pronto para nova dose');
}

function buildHoursGrid(){
  document.getElementById('hours-grid').innerHTML=[4,5,6,7,8,9,10,11].map(h=>`<button class="hour-btn" onclick="selecionarHora(${h},this)">${h}h</button>`).join('');
}

function selecionarHora(h,btn){
  document.querySelectorAll('.hour-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected'); state.horasSono=h;
  document.getElementById('sono-display').textContent=h+'h'; document.getElementById('horas-custom').value='';
}

function selecionarHoraCustom(val){
  document.querySelectorAll('.hour-btn').forEach(b=>b.classList.remove('selected'));
  state.horasSono=parseFloat(val)||null;
  if(state.horasSono){const h=Math.floor(state.horasSono),m=(state.horasSono%1)*60;document.getElementById('sono-display').textContent=m>0?h+'h'+m:h+'h';}
}

function salvarSono(){
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ √© poss√≠vel registrar o sono para o dia atual!'); return; }
  if(!state.horasSono){showToast('‚ö†Ô∏è Selecione quantas horas dormiu!');return;}
  state.sono.unshift({data:hoje(),horas:state.horasSono,qualidade:document.getElementById('sono-qualidade').value,obs:document.getElementById('sono-obs').value});
  if(state.sono.length>7)state.sono=state.sono.slice(0,7);
  salvar(); document.getElementById('sono-obs').value=''; state.horasSono=null;
  document.querySelectorAll('.hour-btn').forEach(b=>b.classList.remove('selected'));
  document.getElementById('sono-display').textContent='‚Äî'; document.getElementById('horas-custom').value='';
  renderHistSono(); updateStats(); showToast('‚úÖ Sono salvo!');
}

function renderHistSono(){
  const c=document.getElementById('historico-sono'), h=document.getElementById('ultimo-sono-home');
  const qM={otima:'üòä √ìtima',boa:'üôÇ Boa',regular:'üòê Regular',ruim:'üòî Ruim',pessima:'üò´ P√©ssima'};
  const bM={otima:'badge-good',boa:'badge-good',regular:'badge-warn',ruim:'badge-bad',pessima:'badge-bad'};
  if(!state.sono.length){const m='<p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">Nenhum registro ainda</p>';c.innerHTML=m;h.innerHTML=m;return;}
  const mk=r=>`<div class="historico-item"><div><div style="font-weight:600;font-size:0.88rem;">${r.data}</div><div class="historico-data">${qM[r.qualidade]}</div></div><div style="display:flex;align-items:center;gap:8px;"><span style="font-weight:700;color:var(--primary);"> ${r.horas}h</span><span class="badge ${bM[r.qualidade]}">${r.horas>=7?'OK':'Baixo'}</span></div></div>`;
  c.innerHTML=state.sono.map(mk).join(''); h.innerHTML=mk(state.sono[0]);
}

function renderMetas(){
  const c=document.getElementById('lista-metas');
  if(!state.metas.length){c.innerHTML='<p style="color:var(--text-light);text-align:center;font-size:0.85rem;padding:16px;">Nenhuma meta. Adicione acima!</p>';updateMetaProg();return;}
  c.innerHTML=state.metas.map(m=>`<div class="meta-item ${m.done?'done':''}" onclick="toggleMeta(${m.id})"><div class="meta-check">${m.done?'‚úì':''}</div><div class="meta-text"><div class="meta-title" style="${m.done?'text-decoration:line-through;color:var(--text-light)':''}">${m.texto}</div><div class="meta-sub">${m.done?'Conclu√≠da! üéâ':'Toque para concluir'}</div></div><div onclick="event.stopPropagation();removerMeta(${m.id})" style="font-size:1.1rem;color:#B0BEC5;padding:4px;">‚úï</div></div>`).join('');
  updateMetaProg();
}

function toggleMeta(id){
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ √© poss√≠vel alterar metas para o dia atual!'); return; }
  const m=state.metas.find(m=>m.id===id);if(m){m.done=!m.done;salvar();renderMetas();updateStats();if(m.done)showToast('üéâ Meta conclu√≠da!');}
}
function adicionarMeta(){
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ √© poss√≠vel adicionar metas para o dia atual!'); return; }
  const inp=document.getElementById('nova-meta-input');const txt=inp.value.trim();if(!txt){showToast('‚ö†Ô∏è Digite uma meta!');return;}state.metas.push({id:Date.now(),texto:txt,done:false});inp.value='';salvar();renderMetas();updateStats();showToast('‚úÖ Meta adicionada!');
}
function removerMeta(id){
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ √© poss√≠vel remover metas para o dia atual!'); return; }
  state.metas=state.metas.filter(m=>m.id!==id);salvar();renderMetas();updateStats();showToast('üóëÔ∏è Meta removida');
}
function limparConcluidas(){
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ √© poss√≠vel limpar metas para o dia atual!'); return; }
  state.metas=state.metas.filter(m=>!m.done);salvar();renderMetas();updateStats();showToast('üßπ Conclu√≠das removidas!');
}

function updateMetaProg(){
  const tot=state.metas.length,dn=state.metas.filter(m=>m.done).length,pct=tot>0?Math.round((dn/tot)*100):0;
  document.getElementById('meta-progress').style.width=pct+'%';
  document.getElementById('meta-info').textContent=dn+' conclu√≠da'+(dn!==1?'s':'');
  document.getElementById('meta-pct').textContent=pct+'%';
}

function renderHistMetas(){
  const c=document.getElementById('historico-metas-lista');
  if(!state.metasHist.length){c.innerHTML='<p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">O hist√≥rico aparecer√° aqui a partir de amanh√£.</p>';return;}
  const fmtD=iso=>{const p=iso.split('-');return p[2]+'/'+p[1]+'/'+p[0];};
  c.innerHTML=state.metasHist.slice(0,7).map(h=>{
    const pct=h.total>0?Math.round((h.concluidas/h.total)*100):0;
    const cls=pct>=80?'badge-good':pct>=50?'badge-warn':'badge-bad';
    return`<div class="meta-hist-card"><div><div style="font-weight:600;font-size:0.88rem;">${fmtD(h.data)}</div><div style="font-size:0.8rem;color:var(--text-light);"> ${h.concluidas} de ${h.total} metas conclu√≠das</div></div><span class="badge ${cls}">${pct}%</span></div>`;
  }).join('');
}

function updateStats(){
  const tot=state.metas.length,dn=state.metas.filter(m=>m.done).length,pct=tot>0?Math.round((dn/tot)*100):0;
  const ult=state.sono[0];
  document.getElementById('stat-sono').textContent=ult?ult.horas+'h':'‚Äî';
  document.getElementById('stat-metas').textContent=dn+'/'+tot;
  document.getElementById('progress-fill').style.width=pct+'%';
  document.getElementById('progress-text').textContent=dn+' de '+tot+' metas conclu√≠das';
  document.getElementById('progress-pct').textContent=pct+'%';
}

function avalCelular(h,m){const t=h*60+m;if(t<=120)return{msg:'Excelente controle!',badge:'badge-good',label:'√ìtimo'};if(t<=240)return{msg:'Uso moderado',badge:'badge-warn',label:'OK'};return{msg:'Uso elevado ‚Äî tente reduzir',badge:'badge-bad',label:'Alto'};}

function salvarCelular(){
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ √© poss√≠vel registrar o tempo de celular para o dia atual!'); return; }
  const h=parseInt(document.getElementById('celular-horas').value)||0;
  const m=parseInt(document.getElementById('celular-minutos').value)||0;
  if(h===0&&m===0){showToast('‚ö†Ô∏è Informe o tempo de celular!');return;}
  state.celular={horas:h,minutos:m,dataISO:hojeISO()};salvar();renderCelular();showToast('üì± Tempo de celular salvo!');
}

function salvarCelularCaverna(){
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ √© poss√≠vel registrar o tempo de celular para o dia atual!'); return; }
  const h=parseInt(document.getElementById('cav-cel-h').value)||0;
  const m=parseInt(document.getElementById('cav-cel-m').value)||0;
  if(h===0&&m===0){showToast('‚ö†Ô∏è Informe o tempo!');return;}
  state.celular={horas:h,minutos:m,dataISO:hojeISO()};salvar();renderCelular();showToast('üì± Tempo de celular salvo!');
}

function renderCelular(){
  const hD=document.getElementById('celular-home-display'),hR=document.getElementById('celular-registrado-home');
  const cF=document.getElementById('cav-celular-form'),cR=document.getElementById('cav-celular-registrado');
  if(state.celular){
    const txt=state.celular.horas+'h '+state.celular.minutos+'min';
    const av=avalCelular(state.celular.horas,state.celular.minutos);
    hD.style.display='none';hR.style.display='block';
    hR.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;"><div><div style="font-weight:700;font-size:1.1rem;color:var(--primary);">üì± ${txt}</div><div style="font-size:0.78rem;color:var(--text-light);">${av.msg}</div></div><span class="badge ${av.badge}">${av.label}</span></div><button onclick="resetarCelular()" style="margin-top:10px;font-size:0.78rem;color:var(--text-light);background:none;border:none;cursor:pointer;text-decoration:underline;">Editar registro</button>`;
    cF.style.display='none';cR.style.display='block';
    cR.innerHTML=`<div style="background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.3);border-radius:10px;padding:12px;margin-top:10px;color:#A78BFA;font-size:0.85rem;">üì± <strong style="color:#E0E0FF;">${txt}</strong> ‚Äî ${av.msg}</div><button onclick="resetarCelular()" style="margin-top:8px;font-size:0.75rem;color:#6B7280;background:none;border:none;cursor:pointer;text-decoration:underline;">Editar</button>`;
  } else {hD.style.display='block';hR.style.display='none';cF.style.display='block';cR.style.display='none';}
}

function resetarCelular(){
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ √© poss√≠vel resetar o tempo de celular para o dia atual!'); return; }
  state.celular=null;salvar();document.getElementById('celular-horas').value='';document.getElementById('celular-minutos').value='';renderCelular();
}

/* POMODORO */
function togglePomodoro(){
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è O Modo Caverna s√≥ pode ser usado para o dia atual!'); return; }
  state.pom.rodando?pausarPom():iniciarPom();
}

function iniciarPom(){
  state.pom.rodando=true; document.getElementById('caverna-play-btn').textContent='‚è∏';
  state.pom.timer=setInterval(tickPom,1000); atualizarUIPom();
}

function pausarPom(){
  state.pom.rodando=false; document.getElementById('caverna-play-btn').textContent='‚ñ∂';
  clearInterval(state.pom.timer);
  salvar(); // Salva o estado do pomodoro ao pausar
}

function tickPom(){
  state.pom.seg--;
  if(state.pom.seg<=0)concluirFase();
  else atualizarUIPom();
}

function concluirFase(){
  clearInterval(state.pom.timer); state.pom.rodando=false;
  if(state.pom.fase==='foco'){
    state.pom.sessoes++; state.pom.sessNoCiclo++; state.pom.minFoco+=20;
    if(state.pom.sessNoCiclo>=SESS_CICLO){state.pom.ciclos++;state.pom.sessNoCiclo=0;showToast('üèÜ Ciclo completo! Fa√ßa uma pausa maior.');}
    else showToast('‚úÖ Sess√£o de foco conclu√≠da! Hora de pausar!');
    state.pom.fase='pausa'; state.pom.seg=POM_PAUSA; state.pom.data=hojeISO(); salvar();
  } else {state.pom.fase='foco'; state.pom.seg=POM_FOCO; showToast('üéØ Hora de focar!');}
  document.getElementById('caverna-play-btn').textContent='‚ñ∂'; atualizarUIPom(); playBeep();
}

function pularFase(){
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è O Modo Caverna s√≥ pode ser usado para o dia atual!'); return; }
  clearInterval(state.pom.timer); state.pom.rodando=false; document.getElementById('caverna-play-btn').textContent='‚ñ∂';
  if(state.pom.fase==='foco'){state.pom.fase='pausa';state.pom.seg=POM_PAUSA;}else{state.pom.fase='foco';state.pom.seg=POM_FOCO;}
  atualizarUIPom(); salvar(); // Salva o estado ap√≥s pular fase
}

function resetarPomodoro(){
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è O Modo Caverna s√≥ pode ser usado para o dia atual!'); return; }
  clearInterval(state.pom.timer); state.pom.rodando=false; state.pom.fase='foco'; state.pom.seg=POM_FOCO;
  document.getElementById('caverna-play-btn').textContent='‚ñ∂'; atualizarUIPom(); showToast('üîÑ Timer reiniciado');
  salvar(); // Salva o estado ap√≥s resetar
}

function atualizarUIPom(){
  const p=state.pom;
  const total=p.fase==='foco'?POM_FOCO:POM_PAUSA;
  const prog=(total-p.seg)/total;
  document.getElementById('caverna-ring-fill').style.strokeDashoffset=CIRC*(1-prog);
  document.getElementById('caverna-ring-fill').style.stroke=p.fase==='foco'?'#A78BFA':'#60A5FA';
  const mm=Math.floor(p.seg/60),ss=p.seg%60;
  document.getElementById('caverna-time-display').textContent=pad(mm)+':'+pad(ss);
  document.getElementById('caverna-phase-label').textContent=p.fase==='foco'?'FOCO':'PAUSA';
  const badge=document.getElementById('caverna-status-badge');
  if(!p.rodando&&p.seg===(p.fase==='foco'?POM_FOCO:POM_PAUSA)){badge.textContent='‚è∏ Aguardando in√≠cio';badge.className='caverna-status-badge status-idle';}
  else if(p.fase==='foco'){badge.textContent=p.rodando?'üéØ Em foco':'‚è∏ Foco pausado';badge.className='caverna-status-badge status-foco';}
  else{badge.textContent=p.rodando?'‚òï Pausa ativa':'‚è∏ Pausa pausada';badge.className='caverna-status-badge status-pausa';}
  renderPom();
}

function renderPom(){
  const p=state.pom;
  document.getElementById('cav-sessoes').textContent=p.sessoes;
  const min=p.minFoco;
  document.getElementById('cav-foco-total').textContent=min>=60?Math.floor(min/60)+'h'+(min%60>0?min%60+'m':''):min+'min';
  document.getElementById('cav-ciclos').textContent=p.ciclos;
  let html='';
  for(let i=0;i<SESS_CICLO;i++){
    if(i<p.sessNoCiclo)html+=`<div class="session-dot completo">‚úì</div>`;
    else if(i===p.sessNoCiclo&&p.fase==='foco')html+=`<div class="session-dot atual">${i+1}</div>`;
    else html+=`<div class="session-dot">${i+1}</div>`;
  }
  document.getElementById('session-dots').innerHTML=html;
}

function playBeep(){
  try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.frequency.value=440;g.gain.setValueAtTime(0.3,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.6);o.start(ctx.currentTime);o.stop(ctx.currentTime+0.6);}catch(e){}
}

function abrirRelatorio(){
  const now=new Date();
  document.getElementById('relatorio-date').textContent=now.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  let pts=0,max=0;
  const sh=state.sono.find(s=>s.data===hoje());
  let sonoH='';
  if(sh){max+=25;const p=sh.horas>=7?25:sh.horas>=5?15:5;pts+=p;const qM={otima:'üòä √ìtima',boa:'üôÇ Boa',regular:'üòê Regular',ruim:'üòî Ruim',pessima:'üò´ P√©ssima'};sonoH=`<div class="rel-section" style="border-color:#1565C0;"><h3>üò¥ Sono</h3><div class="rel-row"><span>Horas dormidas</span><span class="rv">${sh.horas}h</span></div><div class="rel-row"><span>Qualidade</span><span class="rv">${qM[sh.qualidade]}</span></div><div class="rel-row"><span>Avalia√ß√£o</span><span class="rv">${sh.horas>=7?'‚úÖ Adequado':sh.horas>=5?'‚ö†Ô∏è Abaixo do ideal':'‚ùå Insuficiente'}</span></div></div>`;}
  else sonoH=`<div class="rel-section" style="border-color:#B0BEC5;"><h3>üò¥ Sono</h3><p style="font-size:0.83rem;color:var(--text-light);">N√£o registrado hoje.</p></div>`;
  const tot=state.metas.length,dn=state.metas.filter(m=>m.done).length,pctM=tot>0?Math.round((dn/tot)*100):0;
  max+=30;pts+=Math.round((pctM/100)*30);
  const metasH=`<div class="rel-section" style="border-color:#2E7D32;"><h3>üéØ Metas do Dia</h3><div class="rel-row"><span>Conclu√≠das</span><span class="rv">${dn} de ${tot}</span></div><div class="rel-row"><span>Taxa de conclus√£o</span><span class="rv">${pctM}%</span></div>${state.metas.map(m=>`<div class="rel-row"><span>${m.texto}</span><span class="rv">${m.done?'‚úÖ':'‚¨ú'}</span></div>`).join('')}</div>`;
  const p=state.pom; max+=25; pts+=Math.min(25,Math.round((p.minFoco/80)*25));
  const pomH=`<div class="rel-section" style="border-color:#7C3AED;"><h3>üèîÔ∏è Modo Caverna</h3><div class="rel-row"><span>Sess√µes de foco</span><span class="rv">${p.sessoes}</span></div><div class="rel-row"><span>Ciclos completos</span><span class="rv">${p.ciclos}</span></div><div class="rel-row"><span>Tempo total de foco</span><span class="rv">${p.minFoco}min</span></div></div>`;
  max+=20;
  let celH='';
  if(state.celular){const tm=state.celular.horas*60+state.celular.minutos;const pc=tm<=120?20:tm<=240?10:0;pts+=pc;const av=avalCelular(state.celular.horas,state.celular.minutos);celH=`<div class="rel-section" style="border-color:#F57F17;"><h3>üì± Tempo de Tela</h3><div class="rel-row"><span>Tempo usado</span><span class="rv">${state.celular.horas}h ${state.celular.minutos}min</span></div><div class="rel-row"><span>Avalia√ß√£o</span><span class="rv">${av.msg}</span></div></div>`;}
  else celH=`<div class="rel-section" style="border-color:#B0BEC5;"><h3>üì± Tempo de Tela</h3><p style="font-size:0.83rem;color:var(--text-light);">N√£o registrado hoje.</p></div>`;
  let remH='';
  if(state.remedio)remH=`<div class="rel-section" style="border-color:#29B6F6;"><h3>üíä Medica√ß√£o</h3><div class="rel-row"><span>Tomado √†s</span><span class="rv">${fmt(state.remedio.horaRegistro)}</span></div><div class="rel-row"><span>Status</span><span class="rv">‚úÖ Registrado</span></div></div>`;
  else remH=`<div class="rel-section" style="border-color:#B0BEC5;"><h3>üíä Medica√ß√£o</h3><p style="font-size:0.83rem;color:var(--text-light);">N√£o registrado hoje.</p></div>`;
  const nota=max>0?Math.round((pts/max)*100):0;
  const em=nota>=80?'üèÜ':nota>=60?'‚≠ê':nota>=40?'üí™':'üå±';
  const msg=nota>=80?'Dia excelente!':nota>=60?'Bom progresso!':nota>=40?'Continue tentando!':'Amanh√£ ser√° melhor!';
  document.getElementById('relatorio-body').innerHTML=`<div class="rel-avaliacao"><div style="font-size:2rem;">${em}</div><div class="rel-nota">${nota}</div><div class="rel-nota-label">/100 ‚Äî ${msg}</div></div>${sonoH}${metasH}${pomH}${celH}${remH}`;
  document.getElementById('relatorio-modal').classList.add('show');
}

function fecharRelatorio(e){if(e.target.id==='relatorio-modal')document.getElementById('relatorio-modal').classList.remove('show');}
function switchInfo(tab,btn){
  document.querySelectorAll('.info-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.info-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('info-'+tab).classList.add('active');
  btn.classList.add('active');
  btn.dataset.tab = tab; // Adiciona data-tab para identificar a aba ativa

  if (tab === 'mensal') {
    gerarRelatorioMensal();
  }
}

// --- Novas Fun√ß√µes para o Calend√°rio ---

function renderCalendar(date) {
  const year = date.getFullYear();
  const month = date.getMonth();
  document.getElementById('current-month-year').textContent = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

  const firstDayOfMonth = new Date(year, month, 1);
  const lastDayOfMonth = new Date(year, month + 1, 0);
  const daysInMonth = lastDayOfMonth.getDate();
  const startDayOfWeek = firstDayOfMonth.getDay(); // 0 = Sunday, 6 = Saturday

  let calendarHtml = '';

  // Dias do m√™s anterior
  const prevMonthLastDay = new Date(year, month, 0).getDate();
  for (let i = startDayOfWeek - 1; i >= 0; i--) {
    calendarHtml += `<div class="calendar-day inactive">${prevMonthLastDay - i}</div>`;
  }

  // Dias do m√™s atual
  for (let i = 1; i <= daysInMonth; i++) {
    const currentDay = new Date(year, month, i);
    const dayISO = hojeISO(currentDay);
    const isToday = dayISO === hojeISO();
    const isSelected = dayISO === state.currentDate; // Verifica se √© o dia atualmente carregado
    const dayData = state.dailyData[dayISO];

    let metricsHtml = '';
    if (dayData) {
      const sono = dayData.sono && dayData.sono.length > 0 ? dayData.sono[0].horas : null;
      const metasDone = dayData.metas ? dayData.metas.filter(m => m.done).length : 0;
      const metasTotal = dayData.metas ? dayData.metas.length : 0;
      const pomFoco = dayData.pom ? dayData.pom.minFoco : 0;

      let sonoClass = '';
      if (sono) {
        if (sono >= 7) sonoClass = 'metric-good';
        else if (sono >= 5) sonoClass = 'metric-warn';
        else sonoClass = 'metric-bad';
      }
      let metasClass = '';
      if (metasTotal > 0) {
        const pct = (metasDone / metasTotal) * 100;
        if (pct >= 80) metasClass = 'metric-good';
        else if (pct >= 50) metasClass = 'metric-warn';
        else metasClass = 'metric-bad';
      }
      let pomClass = '';
      if (pomFoco > 0) {
        if (pomFoco >= 60) pomClass = 'metric-good'; // 1h de foco
        else if (pomFoco >= 20) pomClass = 'metric-warn'; // 1 sess√£o
        else pomClass = 'metric-bad';
      }

      metricsHtml = `
        <div class="calendar-day-metrics">
          ${sono ? `<span class="${sonoClass}">üò¥ ${sono}h</span>` : ''}
          ${metasTotal > 0 ? `<span class="${metasClass}">‚úÖ ${metasDone}/${metasTotal}</span>` : ''}
          ${pomFoco > 0 ? `<span class="${pomClass}">üèîÔ∏è ${pomFoco}m</span>` : ''}
        </div>
      `;
    }

    calendarHtml += `
      <div class="calendar-day ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}" 
           onclick="selectCalendarDay('${dayISO}', this)">
        ${i}
        ${metricsHtml}
      </div>
    `;
  }

  // Dias do pr√≥ximo m√™s (para preencher a √∫ltima semana)
  const totalDaysDisplayed = startDayOfWeek + daysInMonth;
  const remainingCells = 42 - totalDaysDisplayed; // 6 semanas * 7 dias
  for (let i = 1; i <= remainingCells; i++) {
    calendarHtml += `<div class="calendar-day inactive">${i}</div>`;
  }

  document.getElementById('calendar-grid-days').innerHTML = calendarHtml;
}

function changeMonth(delta) {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
  renderCalendar(currentCalendarDate);
}

function selectCalendarDay(dayISO, element) {
  // Remove a sele√ß√£o de todos os dias
  document.querySelectorAll('.calendar-day').forEach(day => day.classList.remove('selected'));
  // Adiciona a sele√ß√£o ao dia clicado
  element.classList.add('selected');

  // Carrega e exibe os dados do dia selecionado
  loadDailyMetrics(dayISO);
  displayDailySummary(dayISO);
}

function displayDailySummary(dayISO) {
  const data = state.dailyData[dayISO];
  const summaryCard = document.getElementById('daily-summary-card');
  const summaryContent = document.getElementById('daily-summary-content');
  const summaryDate = document.getElementById('summary-date');

  summaryDate.textContent = new Date(dayISO + 'T12:00:00').toLocaleDateString('pt-BR', {weekday:'long',day:'numeric',month:'long',year:'numeric'});

  if (!data) {
    summaryContent.innerHTML = '<p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">Nenhum dado registrado para este dia.</p>';
    summaryCard.style.display = 'block';
    return;
  }

  let html = '';

  // Sono
  const sono = data.sono && data.sono.length > 0 ? data.sono[0] : null;
  if (sono) {
    const qM={otima:'üòä √ìtima',boa:'üôÇ Boa',regular:'üòê Regular',ruim:'üòî Ruim',pessima:'üò´ P√©ssima'};
    html += `<div class="rel-section" style="border-color:#1565C0;"><h3>üò¥ Sono</h3>
      <div class="rel-row"><span>Horas dormidas</span><span class="rv">${sono.horas}h</span></div>
      <div class="rel-row"><span>Qualidade</span><span class="rv">${qM[sono.qualidade]}</span></div>
      <div class="rel-row"><span>Observa√ß√µes</span><span class="rv">${sono.obs || 'N/A'}</span></div>
    </div>`;
  }

  // Metas
  const metas = data.metas || [];
  const metasDone = metas.filter(m => m.done).length;
  const metasTotal = metas.length;
  const pctMetas = metasTotal > 0 ? Math.round((metasDone / metasTotal) * 100) : 0;
  html += `<div class="rel-section" style="border-color:#2E7D32;"><h3>üéØ Metas</h3>
    <div class="rel-row"><span>Conclu√≠das</span><span class="rv">${metasDone} de ${metasTotal}</span></div>
    <div class="rel-row"><span>Taxa de conclus√£o</span><span class="rv">${pctMetas}%</span></div>
    ${metas.map(m => `<div class="rel-row"><span>${m.texto}</span><span class="rv">${m.done?'‚úÖ':'‚¨ú'}</span></div>`).join('')}
  </div>`;

  // Pomodoro
  const pom = data.pom || {};
  html += `<div class="rel-section" style="border-color:#7C3AED;"><h3>üèîÔ∏è Modo Caverna</h3>
    <div class="rel-row"><span>Sess√µes de foco</span><span class="rv">${pom.sessoes || 0}</span></div>
    <div class="rel-row"><span>Ciclos completos</span><span class="rv">${pom.ciclos || 0}</span></div>
    <div class="rel-row"><span>Tempo total de foco</span><span class="rv">${pom.minFoco || 0}min</span></div>
  </div>`;

  // Celular
  const celular = data.celular;
  if (celular) {
    const av = avalCelular(celular.horas, celular.minutos);
    html += `<div class="rel-section" style="border-color:#F57F17;"><h3>üì± Tempo de Tela</h3>
      <div class="rel-row"><span>Tempo usado</span><span class="rv">${celular.horas}h ${celular.minutos}min</span></div>
      <div class="rel-row"><span>Avalia√ß√£o</span><span class="rv">${av.msg}</span></div>
    </div>`;
  }

  // Rem√©dio
  const remedio = data.remedio;
  if (remedio) {
    html += `<div class="rel-section" style="border-color:#29B6F6;"><h3>üíä Medica√ß√£o</h3>
      <div class="rel-row"><span>Tomado √†s</span><span class="rv">${fmt(remedio.horaRegistro)}</span></div>
      <div class="rel-row"><span>Status</span><span class="rv">‚úÖ Registrado</span></div>
    </div>`;
  }

  summaryContent.innerHTML = html;
  summaryCard.style.display = 'block';
}

// --- Nova Fun√ß√£o para o Relat√≥rio Mensal ---

function gerarRelatorioMensal() {
  const relatorioContent = document.getElementById('relatorio-mensal-content');
  const today = new Date();
  const daysToAnalyze = 30;
  let totalSonoHoras = 0;
  let sonoCount = 0;
  let totalMetasConcluidas = 0;
  let totalMetasCriadas = 0;
  let totalFocoMinutos = 0;
  let focoCount = 0;
  let totalCelularMinutos = 0;
  let celularCount = 0;
  let remedioRegistradoCount = 0;
  let diasComDados = 0;

  for (let i = 0; i < daysToAnalyze; i++) {
    const date = new Date(today);
    date.setDate(today.getDate() - i);
    const dayISO = hojeISO(date);
    const data = state.dailyData[dayISO];

    if (data) {
      diasComDados++;
      // Sono
      if (data.sono && data.sono.length > 0) {
        totalSonoHoras += data.sono[0].horas;
        sonoCount++;
      }
      // Metas
      if (data.metas && data.metas.length > 0) {
        totalMetasConcluidas += data.metas.filter(m => m.done).length;
        totalMetasCriadas += data.metas.length;
      }
      // Pomodoro
      if (data.pom && data.pom.minFoco) {
        totalFocoMinutos += data.pom.minFoco;
        focoCount++;
      }
      // Celular
      if (data.celular) {
        totalCelularMinutos += (data.celular.horas * 60) + data.celular.minutos;
        celularCount++;
      }
      // Rem√©dio
      if (data.remedio) {
        remedioRegistradoCount++;
      }
    }
  }

  if (diasComDados === 0) {
    relatorioContent.innerHTML = '<p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">Nenhum dado dispon√≠vel para gerar o relat√≥rio mensal.</p>';
    return;
  }

  const avgSono = sonoCount > 0 ? (totalSonoHoras / sonoCount).toFixed(1) : 'N/A';
  const pctMetas = totalMetasCriadas > 0 ? ((totalMetasConcluidas / totalMetasCriadas) * 100).toFixed(0) : 'N/A';
  const avgFoco = focoCount > 0 ? (totalFocoMinutos / focoCount).toFixed(0) : 'N/A';
  const avgCelular = celularCount > 0 ? (totalCelularMinutos / celularCount).toFixed(0) : 'N/A';
  const pctRemedio = ((remedioRegistradoCount / diasComDados) * 100).toFixed(0);

  let html = `
    <div class="summary-item">
      <span class="summary-label">Dias com dados</span>
      <span class="summary-value">${diasComDados} de ${daysToAnalyze}</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">M√©dia de Sono</span>
      <span class="summary-value">${avgSono}h ${avgSono !== 'N/A' ? (avgSono >= 7 ? '‚úÖ' : '‚ö†Ô∏è') : ''}</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">Metas Conclu√≠das</span>
      <span class="summary-value">${pctMetas}% ${pctMetas !== 'N/A' ? (pctMetas >= 70 ? '‚úÖ' : '‚ö†Ô∏è') : ''}</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">M√©dia de Foco (Caverna)</span>
      <span class="summary-value">${avgFoco}min ${avgFoco !== 'N/A' ? (avgFoco >= 60 ? '‚úÖ' : '‚ö†Ô∏è') : ''}</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">M√©dia de Tempo de Tela</span>
      <span class="summary-value">${Math.floor(avgCelular / 60)}h ${avgCelular % 60}min ${avgCelular !== 'N/A' ? (avgCelular <= 180 ? '‚úÖ' : '‚ö†Ô∏è') : ''}</span>
    </div>
    <div class="summary-item">
      <span class="summary-label">Frequ√™ncia Medica√ß√£o</span>
      <span class="summary-value">${pctRemedio}% ${pctRemedio >= 80 ? '‚úÖ' : '‚ö†Ô∏è'}</span>
    </div>
  `;

  relatorioContent.innerHTML = html;
}


init();
</script>
</body>
</html>
