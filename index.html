<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Clean TDAH</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --primary: #1565C0; --primary-light: #1976D2; --primary-dark: #0D47A1;
  --accent: #29B6F6; --bg: #F0F4F8; --text: #1A237E; --text-light: #546E7A;
  --success: #2E7D32; --shadow: 0 2px 12px rgba(21,101,192,0.10); --radius: 16px;
}
body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; max-width: 430px; margin: 0 auto; }
.header { background: linear-gradient(135deg, var(--primary-dark), var(--primary-light)); color: white; padding: 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.header h1 { font-size: 1.3rem; font-weight: 700; }
.header span { font-size: 0.8rem; opacity: 0.85; display: block; }
.nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: white; display: flex; box-shadow: 0 -2px 12px rgba(21,101,192,0.12); z-index: 100; }
.nav-btn { flex: 1; padding: 10px 2px; border: none; background: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 3px; font-size: 0.58rem; color: var(--text-light); transition: all 0.2s; }
.nav-btn .icon { font-size: 1.25rem; }
.nav-btn.active { color: var(--primary); }
.nav-btn.active .icon { transform: translateY(-2px); }
.nav-btn.caverna-nav { background: linear-gradient(135deg, #1A1A2E, #16213E); color: #E0E0FF; }
.nav-btn.caverna-nav.active { color: #A78BFA; }
.page { display: none; padding: 20px; padding-bottom: 85px; }
.page.active { display: block; }
.card { background: white; border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow); }
.card-title { font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 14px; }
.greeting { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
.greeting h2 { font-size: 1.2rem; margin-bottom: 4px; }
.greeting p { font-size: 0.85rem; opacity: 0.9; }
.stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.stat-card { background: white; border-radius: 12px; padding: 14px 10px; text-align: center; box-shadow: var(--shadow); }
.stat-icon { font-size: 1.5rem; margin-bottom: 4px; }
.stat-value { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
.stat-label { font-size: 0.65rem; color: var(--text-light); }
.form-group { margin-bottom: 16px; }
label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text); }
input, select, textarea { width: 100%; padding: 12px 14px; border: 2px solid #E3EAF2; border-radius: 10px; font-size: 0.95rem; outline: none; transition: border 0.2s; background: #F8FAFF; }
input:focus, select:focus, textarea:focus { border-color: var(--primary); background: white; }
textarea { resize: none; height: 80px; }
.btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
.btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; }
.btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

/* REM√âDIO */
.remedio-card { background: linear-gradient(135deg, #E3F2FD, #F0F7FF); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; border: 2px solid #BBDEFB; }
.remedio-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
.remedio-title { font-weight: 700; color: var(--primary); font-size: 0.95rem; }
.remedio-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
.badge-ativo { background: #E8F5E9; color: #2E7D32; }
.badge-inativo { background: #FFEBEE; color: #C62828; }
.badge-encerrado { background: #FFF8E1; color: #F57F17; }
.remedio-progress-bar { height: 14px; background: #E3EAF2; border-radius: 7px; overflow: hidden; }
.remedio-progress-fill { height: 100%; border-radius: 7px; transition: width 1s ease; position: relative; }
.remedio-progress-fill::after { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent); animation: shimmer 2s infinite; }
@keyframes shimmer { 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }
.remedio-info-row { display: flex; justify-content: space-between; font-size: 0.78rem; color: var(--text-light); margin-top: 6px; }
.remedio-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
.remedio-stat { background: white; border-radius: 10px; padding: 10px; text-align: center; }
.remedio-stat .val { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
.remedio-stat .lbl { font-size: 0.7rem; color: var(--text-light); }
/* FASE DO REM√âDIO - novo */
.remedio-fase-box { background: white; border-radius: 10px; padding: 12px 14px; margin-top: 12px; border-left: 4px solid var(--primary); }
.remedio-fase-titulo { font-size: 0.72rem; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.remedio-fase-desc { font-size: 0.82rem; color: var(--text-light); line-height: 1.5; }
.aviso-encerrado { background: #FFF8E1; border: 2px solid #FFE082; border-radius: 12px; padding: 16px; margin-top: 12px; display: none; }
.aviso-encerrado h4 { color: #F57F17; font-size: 0.9rem; margin-bottom: 8px; }
.aviso-encerrado p { font-size: 0.82rem; color: #5D4037; line-height: 1.6; }
.aviso-encerrado.show { display: block; }
.time-input-wrap { display: flex; gap: 10px; align-items: flex-end; }
.time-input-wrap input[type="time"] { flex: 1; }
.time-input-wrap button { padding: 12px 18px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 0.9rem; font-weight: 700; cursor: pointer; white-space: nowrap; }

/* SONO */
.sono-visual { display: flex; align-items: center; justify-content: center; gap: 16px; padding: 16px 0; }
.sono-circle { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-dark), var(--accent)); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 16px rgba(21,101,192,0.35); }
.sono-circle .horas { font-size: 1.8rem; font-weight: 800; }
.sono-circle .label { font-size: 0.65rem; opacity: 0.85; }
.sono-info p { font-size: 0.85rem; color: var(--text-light); margin-bottom: 4px; }
.sono-info strong { color: var(--primary); }
.hours-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 10px 0; }
.hour-btn { padding: 10px; border: 2px solid #E3EAF2; border-radius: 10px; background: #F8FAFF; font-size: 0.85rem; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s; color: var(--text); }
.hour-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
.custom-hours { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
.custom-hours input { flex: 1; }
.custom-hours span { font-size: 0.85rem; color: var(--text-light); white-space: nowrap; }

/* METAS */
.meta-secao-titulo { font-size: 0.82rem; font-weight: 700; color: var(--text); margin: 14px 0 8px; display: flex; align-items: center; gap: 6px; }
.meta-secao-titulo .tag { font-size: 0.68rem; padding: 2px 8px; border-radius: 10px; font-weight: 700; }
.tag-fixa { background: #E8EAF6; color: #3949AB; }
.tag-diaria { background: #E8F5E9; color: #2E7D32; }
.meta-item { display: flex; align-items: center; gap: 12px; padding: 14px; background: #F8FAFF; border-radius: 12px; margin-bottom: 10px; border: 2px solid transparent; transition: all 0.2s; cursor: pointer; }
.meta-item.done { background: #E8F5E9; border-color: #A5D6A7; }
.meta-item.fixa { border-left: 3px solid #7986CB; }
.prio-tag { font-size: 0.65rem; padding: 2px 7px; border-radius: 8px; font-weight: 700; margin-left: 4px; flex-shrink: 0; }
.prio-alta { background: #FFEBEE; color: #C62828; }
.prio-media { background: #FFF8E1; color: #F57F17; }
.prio-baixa { background: #E8F5E9; color: #2E7D32; }
.meta-item.prio-alta-item { border-top: 2px solid #EF9A9A; }
.meta-item.prio-media-item { border-top: 2px solid #FFE082; }
.meta-item.prio-baixa-item { border-top: 2px solid #A5D6A7; }
.meta-check { width: 26px; height: 26px; border-radius: 50%; border: 2px solid #B0BEC5; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0; }
.meta-item.done .meta-check { background: var(--success); border-color: var(--success); color: white; }
.meta-text { flex: 1; }
.meta-title { font-size: 0.9rem; font-weight: 600; }
.meta-sub { font-size: 0.75rem; color: var(--text-light); }
.progress-bar { height: 8px; background: #E3EAF2; border-radius: 4px; overflow: hidden; margin: 8px 0; }
.progress-fill { height: 100%; background: linear-gradient(to right, var(--primary), var(--accent)); border-radius: 4px; transition: width 0.4s; }
.progress-info { display: flex; justify-content: space-between; font-size: 0.78rem; color: var(--text-light); }
.add-meta-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
.add-meta-row input { flex: 1; }
.add-meta-row select { width: auto; padding: 12px 10px; font-size: 0.82rem; }
.add-meta-row button { padding: 12px 16px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1.2rem; cursor: pointer; flex-shrink: 0; }
.historico-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #EEF2F7; }
.historico-item:last-child { border-bottom: none; }
.historico-data { font-size: 0.8rem; color: var(--text-light); }
.badge { padding: 3px 10px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; }
.badge-good { background: #E8F5E9; color: #2E7D32; }
.badge-warn { background: #FFF8E1; color: #F57F17; }
.badge-bad { background: #FFEBEE; color: #C62828; }
.meta-hist-card { background: #F8FAFF; border-radius: 12px; padding: 12px 14px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #E3EAF2; }

/* P√ÅGINAS LIDAS */
.leitura-row { display: flex; gap: 8px; align-items: center; }
.leitura-row input { flex: 1; }
.leitura-row button { padding: 12px 16px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 0.85rem; font-weight: 700; cursor: pointer; white-space: nowrap; }

/* INFO */
.info-tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; }
.info-tab { padding: 8px 14px; border-radius: 20px; border: 2px solid #E3EAF2; background: white; font-size: 0.8rem; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
.info-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
.info-content { display: none; }
.info-content.active { display: block; }
.info-card { background: #F0F7FF; border-left: 4px solid var(--primary); border-radius: 0 12px 12px 0; padding: 16px; margin-bottom: 12px; }
.info-card h3 { font-size: 0.95rem; color: var(--primary); margin-bottom: 8px; }
.info-card p { font-size: 0.85rem; color: var(--text-light); line-height: 1.6; }
.info-tip { background: #FFF8E1; border-left: 4px solid #FFB300; border-radius: 0 12px 12px 0; padding: 12px 16px; margin-bottom: 10px; font-size: 0.83rem; color: #5D4037; line-height: 1.5; }
.toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #1A237E; color: white; padding: 12px 24px; border-radius: 24px; font-size: 0.85rem; font-weight: 600; z-index: 999; opacity: 0; transition: opacity 0.3s; white-space: nowrap; box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
.toast.show { opacity: 1; }
.section-title { font-size: 1rem; font-weight: 700; color: var(--text); margin-bottom: 12px; }
.divider { height: 1px; background: #EEF2F7; margin: 16px 0; }
.btn-danger { background: transparent; border: 2px solid #EF5350; color: #EF5350; border-radius: 12px; padding: 10px; font-size: 0.8rem; font-weight: 700; cursor: pointer; width: 100%; margin-top: 8px; }

/* CAVERNA */
#page-caverna { background: #0D0D1A; min-height: 100vh; padding: 20px; padding-bottom: 85px; color: #E0E0FF; }
.caverna-header { text-align: center; margin-bottom: 24px; }
.caverna-header h2 { font-size: 1.5rem; font-weight: 800; background: linear-gradient(135deg, #A78BFA, #60A5FA); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 4px; }
.caverna-header p { font-size: 0.8rem; color: #6B7280; }
.caverna-status-badge { display: block; padding: 6px 16px; border-radius: 20px; font-size: 0.78rem; font-weight: 700; margin-bottom: 24px; text-align: center; }
.status-foco { background: rgba(167,139,250,0.15); color: #A78BFA; border: 1px solid rgba(167,139,250,0.3); }
.status-pausa { background: rgba(96,165,250,0.15); color: #60A5FA; border: 1px solid rgba(96,165,250,0.3); }
.status-idle { background: rgba(107,114,128,0.15); color: #9CA3AF; border: 1px solid rgba(107,114,128,0.3); }
.caverna-timer-wrap { display: flex; justify-content: center; margin-bottom: 32px; }
.caverna-ring { position: relative; width: 220px; height: 220px; }
.caverna-ring svg { position: absolute; top: 0; left: 0; width: 220px; height: 220px; transform: rotate(-90deg); }
.caverna-ring-bg { fill: none; stroke: #1E1E3A; stroke-width: 12; }
.caverna-ring-fill { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 1s linear, stroke 0.5s; }
.caverna-center { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.caverna-time { font-size: 3.2rem; font-weight: 800; color: white; letter-spacing: -2px; line-height: 1; font-variant-numeric: tabular-nums; }
.caverna-phase { font-size: 0.75rem; color: #6B7280; margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }
.caverna-controls { display: flex; gap: 16px; justify-content: center; margin-bottom: 28px; }
.caverna-btn { width: 64px; height: 64px; border-radius: 50%; border: none; cursor: pointer; font-size: 1.6rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.caverna-btn-main { width: 80px; height: 80px; font-size: 2rem; background: linear-gradient(135deg, #7C3AED, #4F46E5); color: white; box-shadow: 0 0 30px rgba(124,58,237,0.4); }
.caverna-btn-skip, .caverna-btn-reset { background: rgba(30,30,58,0.8); color: #9CA3AF; border: 1px solid #2D2D4E; }
.caverna-stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.caverna-stat-box { background: rgba(30,30,58,0.6); border: 1px solid #2D2D4E; border-radius: 14px; padding: 14px 10px; text-align: center; }
.caverna-stat-box .v { font-size: 1.3rem; font-weight: 800; color: #A78BFA; display: block; }
.caverna-stat-box .l { font-size: 0.62rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
.caverna-card-dark { background: rgba(20,20,40,0.8); border: 1px solid #2D2D4E; border-radius: 14px; padding: 16px; margin-bottom: 16px; }
.caverna-card-title { font-size: 0.78rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
.session-dot-row { display: flex; gap: 8px; }
.session-dot { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; border: 2px solid #2D2D4E; color: #4B5563; }
.session-dot.completo { background: rgba(124,58,237,0.2); border-color: #7C3AED; color: #A78BFA; }
.session-dot.atual { background: rgba(124,58,237,0.4); border-color: #A78BFA; color: white; animation: pulse-dot 1.5s infinite; }
@keyframes pulse-dot { 0%,100%{box-shadow:0 0 0 0 rgba(167,139,250,0.4)} 50%{box-shadow:0 0 0 6px rgba(167,139,250,0)} }
.cav-input-row { display: flex; gap: 8px; align-items: center; }
.cav-input-row input { flex: 1; background: rgba(30,30,58,0.8); border: 1px solid #3D3D6E; color: #E0E0FF; border-radius: 10px; padding: 10px 14px; font-size: 0.95rem; }
.cav-input-row input::placeholder { color: #4B5563; }
.cav-input-row button { background: linear-gradient(135deg, #7C3AED, #4F46E5); color: white; border: none; border-radius: 10px; padding: 10px 14px; font-size: 0.85rem; font-weight: 700; cursor: pointer; }
.celular-home-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
.celular-home-row input { width: 70px; flex: none; }
.celular-home-row button { padding: 12px 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 0.85rem; font-weight: 700; cursor: pointer; }
/* Ciclos manuais caverna */
.ciclos-manual-row { display: flex; gap: 8px; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid #2D2D4E; }
.ciclos-manual-row input { width: 70px; flex: none; background: rgba(30,30,58,0.8); border: 1px solid #3D3D6E; color: #E0E0FF; border-radius: 10px; padding: 10px 12px; font-size: 0.95rem; }
.ciclos-manual-row span { color: #9CA3AF; font-size: 0.82rem; flex: 1; }
.ciclos-manual-row button { background: rgba(124,58,237,0.4); color: #A78BFA; border: 1px solid #7C3AED; border-radius: 10px; padding: 10px 14px; font-size: 0.85rem; font-weight: 700; cursor: pointer; }

/* RELAT√ìRIO */
.relatorio-btn { background: linear-gradient(135deg, #1565C0, #29B6F6); color: white; border: none; border-radius: 14px; padding: 16px; width: 100%; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 16px; box-shadow: 0 4px 16px rgba(21,101,192,0.3); }
.relatorio-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 200; align-items: flex-end; justify-content: center; }
.relatorio-modal.show { display: flex; }
.relatorio-content { background: white; border-radius: 24px 24px 0 0; padding: 24px; width: 100%; max-width: 430px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
@keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
.relatorio-title { font-size: 1.2rem; font-weight: 800; color: var(--text); margin-bottom: 4px; }
.relatorio-date { font-size: 0.8rem; color: var(--text-light); margin-bottom: 20px; }
.rel-section { background: #F8FAFF; border-radius: 14px; padding: 16px; margin-bottom: 12px; border-left: 4px solid var(--primary); }
.rel-section h3 { font-size: 0.9rem; font-weight: 700; color: var(--primary); margin-bottom: 10px; }
.rel-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #EEF2F7; font-size: 0.85rem; }
.rel-row:last-child { border-bottom: none; }
.rel-row .rl { color: var(--text-light); }
.rel-row .rv { font-weight: 700; color: var(--text); }
.rel-avaliacao { background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 14px; padding: 20px; text-align: center; color: white; margin-bottom: 12px; }
.rel-nota { font-size: 2.8rem; font-weight: 800; }
.rel-nota-label { font-size: 0.85rem; opacity: 0.9; }
.rel-close-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 8px; }

/* RELAT√ìRIO MENSAL CL√çNICO */
.rel-clinico { background: white; border-radius: 14px; overflow: hidden; margin-bottom: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
.rel-clinico-header { background: linear-gradient(135deg, #0D47A1, #1565C0); color: white; padding: 16px 20px; }
.rel-clinico-header h4 { font-size: 0.9rem; font-weight: 700; margin-bottom: 2px; }
.rel-clinico-header p { font-size: 0.75rem; opacity: 0.8; }
.rel-clinico-body { padding: 16px 20px; }
.rel-clinico-body .row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #EEF2F7; font-size: 0.85rem; align-items: center; }
.rel-clinico-body .row:last-child { border-bottom: none; }
.rel-clinico-body .row .lbl { color: var(--text-light); flex: 1; }
.rel-clinico-body .row .val { font-weight: 700; color: var(--text); }
.rel-clinico-body .row .status { font-size: 0.72rem; padding: 2px 8px; border-radius: 10px; font-weight: 700; margin-left: 8px; }
.status-norm { background: #E8F5E9; color: #2E7D32; }
.status-atenc { background: #FFF8E1; color: #F57F17; }
.status-criti { background: #FFEBEE; color: #C62828; }
.rel-parecer { background: #F0F7FF; border-left: 4px solid var(--primary); border-radius: 0 12px 12px 0; padding: 14px 16px; margin-top: 12px; font-size: 0.84rem; color: #37474F; line-height: 1.6; }
.rel-parecer strong { color: var(--primary-dark); }

/* CALEND√ÅRIO */
.calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.calendar-nav button { background: none; border: none; font-size: 1.5rem; color: var(--primary); cursor: pointer; padding: 5px; }
.calendar-nav h3 { font-size: 1rem; color: var(--text); text-transform: capitalize; }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
.calendar-day-header { font-size: 0.68rem; color: var(--text-light); text-transform: uppercase; padding-bottom: 8px; }
.calendar-day { padding: 6px 2px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s; background: #F8FAFF; color: var(--text); min-height: 44px; }
.calendar-day.inactive { color: #B0BEC5; cursor: default; background: transparent; }
.calendar-day.today { border: 2px solid var(--primary); background: #EEF2FF; }
.calendar-day.selected { background: var(--primary); color: white; }
.calendar-day:not(.inactive):not(.selected):hover { background: #DBEAFE; }
.calendar-day-metrics { font-size: 0.6rem; line-height: 1.3; margin-top: 2px; }
.calendar-day-metrics span { display: block; }
.m-ok { color: #2E7D32; }
.m-warn { color: #F57F17; }
.m-bad { color: #C62828; }
.calendar-day.selected .calendar-day-metrics span { color: rgba(255,255,255,0.85); }

/* SUM√ÅRIO DIA */
.daily-sum-card { background: white; border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow); }
</style>
</head>
<body>
<div class="header">
  <div><h1>üß† TDAH Care</h1><span id="header-date"></span></div>
  <div style="font-size:2rem;">üë§</div>
</div>

<!-- HOME -->
<div class="page active" id="page-home">
  <div class="greeting"><h2 id="greeting-text">Ol√°! üëã</h2><p>Acompanhe seu dia com TDAH</p></div>
  <div class="stats-row">
    <div class="stat-card"><div class="stat-icon">üò¥</div><div class="stat-value" id="stat-sono">‚Äî</div><div class="stat-label">Sono</div></div>
    <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-value" id="stat-metas">0/0</div><div class="stat-label">Metas</div></div>
    <div class="stat-card"><div class="stat-icon">üíä</div><div class="stat-value" id="stat-remedio">‚Äî</div><div class="stat-label">Rem√©dio</div></div>
  </div>
  <div class="remedio-card">
    <div class="remedio-header">
      <div><div class="remedio-title">üíä Venvanse (Lisdexanfetamina)</div><div style="font-size:0.75rem;color:var(--text-light);">Dura√ß√£o: 12 horas</div></div>
      <span class="remedio-badge badge-inativo" id="remedio-badge">N√£o registrado</span>
    </div>
    <div id="remedio-sem-registro">
      <p style="font-size:0.82rem;color:var(--text-light);margin-bottom:10px;">Registre o hor√°rio que tomou o rem√©dio:</p>
      <div class="time-input-wrap"><input type="time" id="hora-remedio"><button onclick="registrarRemedio()">üíä Tomei</button></div>
    </div>
    <div id="remedio-com-registro" style="display:none;">
      <div style="display:flex;justify-content:space-between;font-size:0.8rem;margin-bottom:8px;">
        <span style="color:var(--text-light);">Tomado √†s <strong id="hora-tomada-display">‚Äî</strong></span>
        <span style="color:var(--text-light);">Encerra √†s <strong id="hora-encerra-display">‚Äî</strong></span>
      </div>
      <div class="remedio-progress-bar"><div class="remedio-progress-fill" id="remedio-fill" style="width:0%"></div></div>
      <div class="remedio-info-row"><span id="tempo-ativo-label">0h no organismo</span><span id="tempo-restante-label">12h restantes</span></div>
      <div class="remedio-stats">
        <div class="remedio-stat"><div class="val" id="tempo-ativo-val">0h 00min</div><div class="lbl">Tempo ativo</div></div>
        <div class="remedio-stat"><div class="val" id="tempo-restante-val">12h 00min</div><div class="lbl">Tempo restante</div></div>
      </div>
      <!-- NOVO: caixa de fase do rem√©dio -->
      <div class="remedio-fase-box" id="remedio-fase-box">
        <div class="remedio-fase-titulo" id="remedio-fase-titulo">üìä Fase atual</div>
        <div class="remedio-fase-desc" id="remedio-fase-desc">Calculando...</div>
      </div>
      <div class="aviso-encerrado" id="aviso-encerrado">
        <h4>‚ö†Ô∏è Efeito do rem√©dio encerrado</h4>
        <p>O Venvanse completou suas 12h de a√ß√£o. √â normal sentir cansa√ßo, irritabilidade leve e retorno da fome.<br><br>üí° <strong>Dica:</strong> Evite tarefas de alto foco agora. Descanse e alimente-se bem.</p>
      </div>
      <button class="btn-danger" onclick="resetarRemedio()">üîÑ Registrar nova dose</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title">üìä Progresso de hoje</div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    <div class="progress-info"><span id="progress-text">0 de 0 metas conclu√≠das</span><span id="progress-pct">0%</span></div>
  </div>
  <div class="card">
    <div class="card-title">üì± Tempo de tela hoje</div>
    <div id="celular-home-display">
      <p style="color:var(--text-light);font-size:0.82rem;margin-bottom:8px;">Quanto tempo voc√™ usou o celular hoje?</p>
      <div class="celular-home-row">
        <input type="number" id="celular-horas" placeholder="0" min="0" max="24">
        <span style="color:var(--text-light);font-size:0.85rem;">h</span>
        <input type="number" id="celular-minutos" placeholder="0" min="0" max="59">
        <span style="color:var(--text-light);font-size:0.85rem;">min</span>
        <button onclick="salvarCelular()">üíæ Salvar</button>
      </div>
    </div>
    <div id="celular-registrado-home" style="display:none;"></div>
  </div>
  <div class="card">
    <div class="card-title">üìÖ √öltimo sono registrado</div>
    <div id="ultimo-sono-home"><p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:8px;">Nenhum registro ainda</p></div>
  </div>
  <button class="relatorio-btn" onclick="abrirRelatorio()">üìä Gerar Relat√≥rio do Dia</button>
</div>

<!-- SONO -->
<div class="page" id="page-sono">
  <div class="section-title">üò¥ Registrar Sono</div>
  <div class="card">
    <div class="sono-visual">
      <div class="sono-circle"><span class="horas" id="sono-display">‚Äî</span><span class="label">de sono</span></div>
      <div class="sono-info">
        <p>Recomendado: <strong>7-9 horas</strong></p>
        <p style="font-size:0.8rem;color:var(--text-light);margin-top:6px;">Sono regular melhora foco e resposta ao medicamento.</p>
      </div>
    </div>
    <div class="form-group">
      <label>‚è∞ Quantas horas dormiu?</label>
      <div class="hours-grid" id="hours-grid"></div>
      <div class="custom-hours"><input type="number" id="horas-custom" placeholder="Outro valor..." min="0" max="24" step="0.5" oninput="selecionarHoraCustom(this.value)"><span>horas</span></div>
    </div>
    <div class="form-group">
      <label>üò¥ Qualidade do sono</label>
      <select id="sono-qualidade">
        <option value="otima">üòä √ìtima ‚Äî Acordei muito descansado</option>
        <option value="boa" selected>üôÇ Boa ‚Äî Acordei bem</option>
        <option value="regular">üòê Regular ‚Äî Cansado mas ok</option>
        <option value="ruim">üòî Ruim ‚Äî Muito cansado</option>
        <option value="pessima">üò´ P√©ssima ‚Äî Mal consegui dormir</option>
      </select>
    </div>
    <div class="form-group"><label>üìù Observa√ß√µes (opcional)</label><textarea id="sono-obs" placeholder="Ex: Acordei v√°rias vezes..."></textarea></div>
    <button class="btn btn-primary" onclick="salvarSono()">üíæ Salvar Registro</button>
  </div>
  <div class="card"><div class="card-title">üìÖ √öltimos registros</div><div id="historico-sono"><p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">Nenhum registro ainda</p></div></div>
</div>

<!-- METAS -->
<div class="page" id="page-metas">
  <div class="section-title">üéØ Minhas Metas</div>
  <div class="card">
    <div class="card-title">‚ûï Nova meta</div>
    <div class="add-meta-row">
      <input type="text" id="nova-meta-input" placeholder="Ex: Estudar 1h, Meditar...">
      <select id="nova-meta-tipo">
        <option value="diaria">üìÖ Di√°ria</option>
        <option value="fixa">üìå Fixa</option>
      </select>
      <button onclick="adicionarMeta()">+</button>
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
      <label style="font-size:0.78rem;margin-bottom:0;font-weight:500;color:var(--text-light);white-space:nowrap;">Prioridade:</label>
      <select id="nova-meta-prio" style="padding:6px 10px;font-size:0.78rem;border-radius:8px;border:2px solid #E3EAF2;background:#F8FAFF;flex:1;">
        <option value="alta">üî¥ Alta</option>
        <option value="media" selected>üü° M√©dia</option>
        <option value="baixa">üü¢ Baixa</option>
      </select>
    </div>
    <p style="font-size:0.75rem;color:var(--text-light);">üìå Fixas se repetem todo dia. üìÖ Di√°rias somem √† meia-noite. Ordenadas por prioridade.</p>
  </div>
  <div class="card">
    <div class="card-title">üìã Metas de hoje</div>
    <div class="progress-bar" style="margin-bottom:8px;"><div class="progress-fill" id="meta-progress" style="width:0%"></div></div>
    <div class="progress-info" style="margin-bottom:16px;"><span id="meta-info">0 conclu√≠das</span><span id="meta-pct">0%</span></div>
    <div id="lista-metas"></div>
    <div class="divider"></div>
    <button class="btn btn-outline" onclick="limparConcluidas()" style="margin-top:8px;">üóëÔ∏è Limpar di√°rias conclu√≠das</button>
  </div>
  <!-- NOVO: p√°ginas lidas -->
  <div class="card">
    <div class="card-title">üìö P√°ginas lidas hoje</div>
    <div id="leitura-form">
      <p style="font-size:0.82rem;color:var(--text-light);margin-bottom:10px;">Quantas p√°ginas voc√™ leu hoje?</p>
      <div class="leitura-row">
        <input type="number" id="paginas-input" placeholder="Ex: 30" min="0">
        <button onclick="salvarLeitura()">üíæ Salvar</button>
      </div>
    </div>
    <div id="leitura-registrada" style="display:none;"></div>
  </div>
  <div class="card">
    <div class="card-title">üìÖ Hist√≥rico de metas</div>
    <div id="historico-metas-lista"><p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">O hist√≥rico aparecer√° aqui a partir de amanh√£.</p></div>
  </div>
  <div class="card"><div class="card-title">üí° Dica</div>
    <div style="background:#FFF8E1;border-left:4px solid #FFB300;border-radius:0 12px 12px 0;padding:12px 16px;font-size:0.83rem;color:#5D4037;line-height:1.5;"><strong>TDAH e metas:</strong> Divida tarefas grandes em passos pequenos. Cada ‚úÖ libera dopamina!</div>
  </div>
</div>

<!-- CALEND√ÅRIO -->
<div class="page" id="page-calendario">
  <div class="section-title">üóìÔ∏è Hist√≥rico Di√°rio</div>
  <div class="card">
    <div class="calendar-nav">
      <button onclick="changeMonth(-1)">‚óÄ</button>
      <h3 id="current-month-year"></h3>
      <button onclick="changeMonth(1)">‚ñ∂</button>
    </div>
    <div class="calendar-grid">
      <div class="calendar-day-header">Dom</div><div class="calendar-day-header">Seg</div>
      <div class="calendar-day-header">Ter</div><div class="calendar-day-header">Qua</div>
      <div class="calendar-day-header">Qui</div><div class="calendar-day-header">Sex</div>
      <div class="calendar-day-header">S√°b</div>
    </div>
    <div class="calendar-grid" id="calendar-grid-days"></div>
  </div>
  <div id="daily-summary-card" style="display:none;"></div>
</div>

<!-- CAVERNA -->
<div class="page" id="page-caverna">
  <div class="caverna-header"><h2>üèîÔ∏è Modo Caverna</h2><p>Pomodoro 20min foco / 5min pausa</p></div>
  <div style="text-align:center;"><span class="caverna-status-badge status-idle" id="caverna-status-badge">‚è∏ Aguardando in√≠cio</span></div>
  <div class="caverna-timer-wrap">
    <div class="caverna-ring">
      <svg viewBox="0 0 220 220"><circle class="caverna-ring-bg" cx="110" cy="110" r="96"/><circle class="caverna-ring-fill" id="caverna-ring-fill" cx="110" cy="110" r="96" stroke="#A78BFA" stroke-dasharray="603.19" stroke-dashoffset="0"/></svg>
      <div class="caverna-center"><div class="caverna-time" id="caverna-time-display">20:00</div><div class="caverna-phase" id="caverna-phase-label">FOCO</div></div>
    </div>
  </div>
  <div class="caverna-controls">
    <button class="caverna-btn caverna-btn-reset" onclick="resetarPomodoro()" title="Reiniciar">üîÑ</button>
    <button class="caverna-btn caverna-btn-main" id="caverna-play-btn" onclick="togglePomodoro()">‚ñ∂</button>
    <button class="caverna-btn caverna-btn-skip" onclick="pularFase()" title="Pular fase">‚è≠</button>
  </div>
  <div class="caverna-stats-grid">
    <div class="caverna-stat-box"><span class="v" id="cav-sessoes">0</span><span class="l">Sess√µes</span></div>
    <div class="caverna-stat-box"><span class="v" id="cav-foco-total">0min</span><span class="l">Foco hoje</span></div>
    <div class="caverna-stat-box"><span class="v" id="cav-ciclos">0</span><span class="l">Ciclos</span></div>
  </div>
  <div class="caverna-card-dark">
    <div class="caverna-card-title">üîµ Sess√µes do ciclo atual (4 = 1 ciclo)</div>
    <div class="session-dot-row" id="session-dots"></div>
    <!-- NOVO: adicionar ciclos manualmente -->
    <div class="ciclos-manual-row">
      <span style="color:#9CA3AF;font-size:0.82rem;">Celular desligou? Adicione ciclos:</span>
      <input type="number" id="ciclos-manual-input" placeholder="0" min="0" max="20" style="width:60px;">
      <button onclick="adicionarCiclosManuais()">+ Ciclos</button>
    </div>
  </div>
  <div class="caverna-card-dark">
    <div class="caverna-card-title">üì± Tempo de celular hoje</div>
    <div id="cav-celular-form">
      <div class="cav-input-row">
        <input type="number" id="cav-cel-h" placeholder="Horas" min="0" max="24">
        <span style="color:#6B7280;font-size:0.85rem;">h</span>
        <input type="number" id="cav-cel-m" placeholder="Min" min="0" max="59">
        <span style="color:#6B7280;font-size:0.85rem;">min</span>
        <button onclick="salvarCelularCaverna()">üíæ</button>
      </div>
    </div>
    <div id="cav-celular-registrado" style="display:none;"></div>
  </div>
</div>

<!-- INFO -->
<div class="page" id="page-info">
  <div class="section-title">üìö Informa√ß√µes</div>
  <div class="info-tabs">
    <button class="info-tab active" onclick="switchInfo('sono',this)">üò¥ Sono</button>
    <button class="info-tab" onclick="switchInfo('eletrolitos',this)">üíß Eletr√≥litos</button>
    <button class="info-tab" onclick="switchInfo('remedio',this)">üíä Medica√ß√£o</button>
    <button class="info-tab" onclick="switchInfo('estrategias',this)">üß† Estrat√©gias</button>
    <button class="info-tab" onclick="switchInfo('mensal',this)">üìà Mensal</button>
  </div>
  <div class="info-content active" id="info-sono">
    <div class="info-card"><h3>üåô Por que o sono √© crucial no TDAH?</h3><p>Priva√ß√£o de sono agrava desaten√ß√£o, impulsividade e regula√ß√£o emocional ‚Äî j√° comprometidas no TDAH.</p></div>
    <div class="info-tip"><strong>‚úÖ Recomenda√ß√£o:</strong> 7-9 horas com hor√°rios consistentes, mesmo nos fins de semana.</div>
    <div class="info-card"><h3>üì± Higiene do sono</h3><p>Evite telas 1 hora antes de dormir. A luz azul inibe a melatonina. Crie rotina: banho morno, leitura leve, ambiente fresco.</p></div>
    <div class="info-tip"><strong>‚ö†Ô∏è Aten√ß√£o:</strong> Estimulantes tomados tarde dificultam o sono. Converse com seu m√©dico.</div>
  </div>
  <div class="info-content" id="info-eletrolitos">
    <div class="info-card"><h3>üíß Hidrata√ß√£o e TDAH</h3><p>Desidrata√ß√£o leve (1-2%) j√° impacta concentra√ß√£o e mem√≥ria ‚Äî fun√ß√µes comprometidas no TDAH.</p></div>
    <div class="info-tip"><strong>‚úÖ Meta:</strong> 2-3 litros de √°gua por dia.</div>
    <div class="info-card"><h3>üßÇ Eletr√≥litos importantes</h3><p><strong>Magn√©sio:</strong> Reduz hiperatividade, melhora sono.<br><br><strong>Zinco:</strong> Relacionado √† s√≠ntese de dopamina.<br><br><strong>Ferro:</strong> Defici√™ncia agrava TDAH. Avalie com seu m√©dico.</p></div>
    <div class="info-tip"><strong>‚ö†Ô∏è Importante:</strong> N√£o inicie suplementa√ß√£o sem orienta√ß√£o m√©dica.</div>
  </div>
  <div class="info-content" id="info-remedio">
    <div class="info-card"><h3>üíä Venvanse ‚Äî Como funciona</h3><p>Pr√≥-f√°rmaco ativado no organismo. In√≠cio em 1-2h, pico entre 3-5h, dura√ß√£o total de at√© 12h.</p></div>
    <div class="info-tip"><strong>‚úÖ Hor√°rio ideal:</strong> Tome ao acordar. Consist√™ncia maximiza o efeito terap√™utico.</div>
    <div class="info-card"><h3>üçΩÔ∏è Alimenta√ß√£o e medica√ß√£o</h3><p>Estimulantes reduzem apetite. Tome caf√© da manh√£ nutritivo ANTES da dose.</p></div>
    <div class="info-tip"><strong>‚ö†Ô∏è Nunca</strong> ajuste doses sem consultar seu m√©dico.</div>
    <div class="info-card"><h3>üåô Rebote ao fim do efeito</h3><p>Retorno dos sintomas, irritabilidade leve e fome s√£o normais. Planeje atividades de menor demanda cognitiva para esse per√≠odo.</p></div>
  </div>
  <div class="info-content" id="info-estrategias">
    <div class="info-card"><h3>‚è±Ô∏è Modo Caverna ‚Äî Pomodoro 20/5</h3><p>20min de foco + 5min de pausa. Para TDAH, sess√µes mais curtas s√£o mais eficazes. Ap√≥s 4 sess√µes (1 ciclo), fa√ßa uma pausa maior de 15-20min.</p></div>
    <div class="info-card"><h3>üìù Body doubling</h3><p>Estudar na presen√ßa de outra pessoa (mesmo virtual) aumenta foco no TDAH.</p></div>
    <div class="info-tip"><strong>‚úÖ Organiza√ß√£o:</strong> Listas curtas de 3-5 itens. Muitas tarefas vis√≠veis sobrecarregam.</div>
    <div class="info-card"><h3>üéµ M√∫sica e foco</h3><p>Lo-fi, instrumentais ou ru√≠do branco melhoram concentra√ß√£o. Evite letras em tarefas de leitura.</p></div>
  </div>
  <div class="info-content" id="info-mensal">
    <div id="relatorio-mensal-wrap"></div>
  </div>
</div>

<!-- RELAT√ìRIO MODAL -->
<div class="relatorio-modal" id="relatorio-modal" onclick="fecharRelatorio(event)">
  <div class="relatorio-content">
    <div class="relatorio-title">üìä Relat√≥rio do Dia</div>
    <div class="relatorio-date" id="relatorio-date"></div>
    <div id="relatorio-body"></div>
    <button class="rel-close-btn" onclick="document.getElementById('relatorio-modal').classList.remove('show')">‚úï Fechar</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<div class="nav">
  <button class="nav-btn active" onclick="navigate('home',this)"><span class="icon">üè†</span><span>In√≠cio</span></button>
  <button class="nav-btn" onclick="navigate('sono',this)"><span class="icon">üò¥</span><span>Sono</span></button>
  <button class="nav-btn" onclick="navigate('metas',this)"><span class="icon">üéØ</span><span>Metas</span></button>
  <button class="nav-btn" onclick="navigate('calendario',this)"><span class="icon">üóìÔ∏è</span><span>Hist√≥rico</span></button>
  <button class="nav-btn caverna-nav" onclick="navigate('caverna',this)"><span class="icon">üèîÔ∏è</span><span>Caverna</span></button>
  <button class="nav-btn" onclick="navigate('info',this)"><span class="icon">üìö</span><span>Info</span></button>
</div>

<script>
// ========== CONSTANTES ==========
const DUR_REM = 12*60, POM_FOCO = 20*60, POM_PAUSA = 5*60, SESS_CICLO = 4;
const CIRC = 2*Math.PI*96;

// Metas fixas padr√£o (sempre aparecem todo dia)
const METAS_FIXAS_DEFAULT = [
  {id:'f1', texto:'Tomar medica√ß√£o', done:false, tipo:'fixa'},
  {id:'f2', texto:'Beber 2L de √°gua', done:false, tipo:'fixa'},
  {id:'f3', texto:'Fazer 30min de exerc√≠cio', done:false, tipo:'fixa'},
  {id:'f4', texto:'Dormir antes das 23h', done:false, tipo:'fixa'},
];

// Fases do rem√©dio Venvanse com efeitos esperados
const FASES_REMEDIO = [
  { min: 0,  max: 60,  titulo:'üåÖ Fase de absor√ß√£o (0‚Äì1h)', cor:'#1565C0',
    desc:'O rem√©dio est√° sendo absorvido. Voc√™ pode n√£o sentir efeito ainda. Evite refei√ß√µes pesadas agora.' },
  { min: 60, max: 180, titulo:'üìà In√≠cio da a√ß√£o (1‚Äì3h)', cor:'#1976D2',
    desc:'O f√°rmaco come√ßa a agir. Voc√™ pode sentir leve aumento de alerta, redu√ß√£o do apetite e melhora no foco. √â normal sentir a boca seca.' },
  { min: 180,max: 300, titulo:'üöÄ Pico terap√™utico (3‚Äì5h)', cor:'#00897B',
    desc:'Este √© o momento de maior efic√°cia. Aproveite para tarefas de alto foco. Concentra√ß√£o e controle de impulsos est√£o no m√°ximo.' },
  { min: 300,max: 480, titulo:'‚ö° A√ß√£o plena (5‚Äì8h)', cor:'#2E7D32',
    desc:'O rem√©dio continua em plena a√ß√£o. Foco sustentado ainda presente. Lembre-se de se alimentar mesmo sem fome.' },
  { min: 480,max: 600, titulo:'üìâ Decl√≠nio gradual (8‚Äì10h)', cor:'#F57F17',
    desc:'O efeito come√ßa a declinar suavemente. Voc√™ pode notar leve retorno da agita√ß√£o ou dificuldade de foco. Normal nesta fase.' },
  { min: 600,max: 720, titulo:'üåô Fase de rebote (10‚Äì12h)', cor:'#E65100',
    desc:'Aproximando-se do fim da a√ß√£o. Pode sentir irritabilidade leve, fome e retorno dos sintomas. Evite decis√µes importantes agora.' },
  { min: 720,max: Infinity, titulo:'‚èπÔ∏è Efeito encerrado', cor:'#C62828',
    desc:'O Venvanse completou sua dura√ß√£o. Descanse, alimente-se bem e prepare-se para a pr√≥xima dose amanh√£.' },
];

// ========== STATE ==========
let state = {
  dailyData: {},
  currentDate: hojeISO(),
  sono: [], horasSono: null,
  metas: [], metasFixas: [],
  metasHist: [],
  remedio: null, remedioTimer: null,
  celular: null,
  leitura: null,
  pom: {rodando:false,fase:'foco',seg:POM_FOCO,sessoes:0,ciclos:0,sessNoCiclo:0,minFoco:0,timer:null,data:null}
};
let currentCalendarDate = new Date();

// ========== UTILS ==========
function hoje() { return new Date().toLocaleDateString('pt-BR'); }
function hojeISO(date = new Date()) {
  return date.getFullYear()+'-'+pad(date.getMonth()+1)+'-'+pad(date.getDate());
}
function pad(n) { return String(n).padStart(2,'0'); }
function fmt(d) {
  if (!(d instanceof Date) || isNaN(d)) return '--:--';
  return d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
}
function showToast(m) {
  const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

// ========== STORAGE ==========
function salvar() {
  // Salva estado do dia atual em dailyData
  state.dailyData[state.currentDate] = {
    sono: state.sono,
    remedio: state.remedio ? {
      ...state.remedio,
      horaRegistro: state.remedio.horaRegistro instanceof Date
        ? state.remedio.horaRegistro.toISOString()
        : state.remedio.horaRegistro
    } : null,
    metas: state.metas,
    metasFixas: state.metasFixas,
    celular: state.celular,
    leitura: state.leitura,
    pom: {
      sessoes: state.pom.sessoes, ciclos: state.pom.ciclos,
      sessNoCiclo: state.pom.sessNoCiclo, minFoco: state.pom.minFoco,
      data: state.pom.data || state.currentDate
    }
  };
  try {
    localStorage.setItem('tdah_daily', JSON.stringify(state.dailyData));
    localStorage.setItem('tdah_mhist', JSON.stringify(state.metasHist));
    localStorage.setItem('tdah_fixas', JSON.stringify(state.metasFixas));
    localStorage.setItem('tdah_last_date', hojeISO());
  } catch(e) {}
}

function carregar() {
  try {
    const raw = localStorage.getItem('tdah_daily');
    if (raw) {
      state.dailyData = JSON.parse(raw);
      // Converte datas de string para Date
      for (const d in state.dailyData) {
        const dd = state.dailyData[d];
        if (dd.remedio && dd.remedio.horaRegistro) {
          dd.remedio.horaRegistro = new Date(dd.remedio.horaRegistro);
        }
      }
    }
    const mh = localStorage.getItem('tdah_mhist');
    if (mh) state.metasHist = JSON.parse(mh);

    // Carrega metas fixas globais (persistem entre dias)
    const mf = localStorage.getItem('tdah_fixas');
    if (mf) state.metasFixas = JSON.parse(mf);
    else state.metasFixas = METAS_FIXAS_DEFAULT.map(m => ({...m}));

    // Verifica se mudou de dia ‚Äî salva hist√≥rico do dia anterior
    const lastDate = localStorage.getItem('tdah_last_date');
    if (lastDate && lastDate !== hojeISO()) {
      const prevData = state.dailyData[lastDate];
      if (prevData && prevData.metas && prevData.metas.length > 0) {
        const entry = {
          data: lastDate,
          total: prevData.metas.length,
          concluidas: prevData.metas.filter(m=>m.done).length,
          lista: prevData.metas.map(m=>({t:m.texto,d:m.done,tipo:m.tipo}))
        };
        if (!state.metasHist.find(h=>h.data===lastDate)) {
          state.metasHist.unshift(entry);
          if (state.metasHist.length > 60) state.metasHist.splice(60);
        }
      }
      // Reseta check das metas fixas para o novo dia
      state.metasFixas = state.metasFixas.map(m=>({...m, done:false}));
      localStorage.setItem('tdah_fixas', JSON.stringify(state.metasFixas));
    }
  } catch(e) { console.error(e); }
}

function carregarDia(dateISO) {
  state.currentDate = dateISO;
  const data = state.dailyData[dateISO] || {};
  state.sono = data.sono || [];
  state.remedio = data.remedio || null;
  // Metas: se for hoje, carrega metas di√°rias salvas + metas fixas do estado global
  // Se for outro dia, carrega do hist√≥rico
  if (dateISO === hojeISO()) {
    state.metas = data.metas || [];
  } else {
    state.metas = data.metas || [];
  }
  state.celular = data.celular || null;
  state.leitura = data.leitura || null;
  state.pom = {
    rodando: false, fase: 'foco', seg: POM_FOCO, timer: null,
    sessoes: data.pom ? data.pom.sessoes : 0,
    ciclos: data.pom ? data.pom.ciclos : 0,
    sessNoCiclo: data.pom ? data.pom.sessNoCiclo : 0,
    minFoco: data.pom ? data.pom.minFoco : 0,
    data: dateISO
  };
  if (state.remedioTimer) clearInterval(state.remedioTimer);
  if (state.remedio && dateISO === hojeISO()) {
    state.remedioTimer = setInterval(atualizarBarra, 30000);
  }
  renderUI();
}

function renderUI() {
  const now = new Date();
  document.getElementById('header-date').textContent = now.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'});
  const h = now.getHours();
  document.getElementById('greeting-text').textContent = h<12?'Bom dia! üëã':h<18?'Boa tarde! üëã':'Boa noite! üëã';

  // Rem√©dio
  if (state.remedio) {
    document.getElementById('remedio-sem-registro').style.display='none';
    document.getElementById('remedio-com-registro').style.display='block';
    atualizarBarra();
  } else {
    document.getElementById('remedio-sem-registro').style.display='block';
    document.getElementById('remedio-com-registro').style.display='none';
    document.getElementById('remedio-badge').textContent='N√£o registrado';
    document.getElementById('remedio-badge').className='remedio-badge badge-inativo';
    document.getElementById('aviso-encerrado').classList.remove('show');
    document.getElementById('hora-remedio').value='';
  }

  renderMetas();
  renderHistSono();
  renderHistMetas();
  updateStats();
  renderCelular();
  renderLeitura();
  renderPom();
}

// ========== INIT ==========
function init() {
  carregar();
  buildHoursGrid();
  carregarDia(hojeISO());
  renderCalendar(currentCalendarDate);
}

// ========== NAV ==========
function navigate(p,btn) {
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active');
  btn.classList.add('active');
  if (p==='calendario') { renderCalendar(currentCalendarDate); document.getElementById('daily-summary-card').style.display='none'; }
  if (p==='info') { /* relat√≥rio mensal √© gerado ao clicar na aba */ }
}

// ========== REM√âDIO ==========
function registrarRemedio() {
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ registra para o dia atual'); return; }
  const val = document.getElementById('hora-remedio').value;
  if (!val) { showToast('‚ö†Ô∏è Informe o hor√°rio!'); return; }
  const [hh,mm] = val.split(':').map(Number);
  const now = new Date();
  const reg = new Date(now.getFullYear(),now.getMonth(),now.getDate(),hh,mm,0);
  state.remedio = { horaRegistro: reg };
  salvar();
  document.getElementById('remedio-sem-registro').style.display='none';
  document.getElementById('remedio-com-registro').style.display='block';
  atualizarBarra();
  if (state.remedioTimer) clearInterval(state.remedioTimer);
  state.remedioTimer = setInterval(atualizarBarra, 30000);
  showToast('üíä Medica√ß√£o registrada!');
  updateStats();
}

function atualizarBarra() {
  if (!state.remedio) return;
  const hr = state.remedio.horaRegistro;
  if (!(hr instanceof Date) || isNaN(hr)) return;
  const agora = new Date();
  const minPass = Math.floor((agora - hr) / 60000);
  const minRest = Math.max(0, DUR_REM - minPass);
  const pct = Math.min(100, (minPass / DUR_REM) * 100);
  const horaEnc = new Date(hr.getTime() + DUR_REM*60000);

  document.getElementById('hora-tomada-display').textContent = fmt(hr);
  document.getElementById('hora-encerra-display').textContent = fmt(horaEnc);
  document.getElementById('remedio-fill').style.width = pct+'%';

  const cor = pct<40?'linear-gradient(90deg,#1565C0,#42A5F5)':
              pct<75?'linear-gradient(90deg,#1976D2,#26C6DA)':
              pct<100?'linear-gradient(90deg,#F57F17,#FFCA28)':
              'linear-gradient(90deg,#C62828,#EF5350)';
  document.getElementById('remedio-fill').style.background = cor;

  const hA=Math.floor(minPass/60), mA=minPass%60, hR=Math.floor(minRest/60), mR=minRest%60;
  document.getElementById('tempo-ativo-val').textContent = hA+'h '+pad(mA)+'min';
  document.getElementById('tempo-restante-val').textContent = minRest>0?hR+'h '+pad(mR)+'min':'Encerrado';
  document.getElementById('tempo-ativo-label').textContent = hA+'h no organismo';
  document.getElementById('tempo-restante-label').textContent = minRest>0?hR+'h restantes':'Efeito encerrado';

  const badge = document.getElementById('remedio-badge');
  if (minRest<=0) {
    badge.textContent='Encerrado'; badge.className='remedio-badge badge-encerrado';
    document.getElementById('aviso-encerrado').classList.add('show');
    document.getElementById('stat-remedio').textContent='Enc.';
  } else {
    badge.textContent='Ativo'; badge.className='remedio-badge badge-ativo';
    document.getElementById('aviso-encerrado').classList.remove('show');
    document.getElementById('stat-remedio').textContent=hA+'h';
  }

  // NOVO: atualiza fase do rem√©dio
  atualizarFaseRemedio(minPass);
}

function atualizarFaseRemedio(minPass) {
  const fase = FASES_REMEDIO.find(f => minPass >= f.min && minPass < f.max) || FASES_REMEDIO[FASES_REMEDIO.length-1];
  const box = document.getElementById('remedio-fase-box');
  const tit = document.getElementById('remedio-fase-titulo');
  const desc = document.getElementById('remedio-fase-desc');
  if (box && tit && desc) {
    box.style.borderLeftColor = fase.cor;
    tit.textContent = fase.titulo;
    tit.style.color = fase.cor;
    desc.textContent = fase.desc;
  }
}

function resetarRemedio() {
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ reseta para o dia atual'); return; }
  state.remedio = null; salvar();
  if (state.remedioTimer) clearInterval(state.remedioTimer);
  document.getElementById('remedio-sem-registro').style.display='block';
  document.getElementById('remedio-com-registro').style.display='none';
  document.getElementById('remedio-badge').textContent='N√£o registrado';
  document.getElementById('remedio-badge').className='remedio-badge badge-inativo';
  document.getElementById('aviso-encerrado').classList.remove('show');
  document.getElementById('hora-remedio').value='';
  document.getElementById('stat-remedio').textContent='‚Äî';
  showToast('üîÑ Pronto para nova dose');
}

// ========== SONO ==========
function buildHoursGrid() {
  document.getElementById('hours-grid').innerHTML = [4,5,6,7,8,9,10,11].map(h=>
    `<button class="hour-btn" onclick="selecionarHora(${h},this)">${h}h</button>`
  ).join('');
}
function selecionarHora(h,btn) {
  document.querySelectorAll('.hour-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected'); state.horasSono=h;
  document.getElementById('sono-display').textContent=h+'h';
  document.getElementById('horas-custom').value='';
}
function selecionarHoraCustom(val) {
  document.querySelectorAll('.hour-btn').forEach(b=>b.classList.remove('selected'));
  state.horasSono = parseFloat(val)||null;
  if (state.horasSono) {
    const h=Math.floor(state.horasSono), m=(state.horasSono%1)*60;
    document.getElementById('sono-display').textContent = m>0?h+'h'+m:h+'h';
  }
}
function salvarSono() {
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ registra sono para o dia atual'); return; }
  if (!state.horasSono) { showToast('‚ö†Ô∏è Selecione quantas horas dormiu!'); return; }
  state.sono.unshift({data:hoje(),horas:state.horasSono,qualidade:document.getElementById('sono-qualidade').value,obs:document.getElementById('sono-obs').value});
  if (state.sono.length>7) state.sono=state.sono.slice(0,7);
  salvar();
  document.getElementById('sono-obs').value=''; state.horasSono=null;
  document.querySelectorAll('.hour-btn').forEach(b=>b.classList.remove('selected'));
  document.getElementById('sono-display').textContent='‚Äî'; document.getElementById('horas-custom').value='';
  renderHistSono(); updateStats(); showToast('‚úÖ Sono salvo!');
}
function renderHistSono() {
  const c=document.getElementById('historico-sono'), hEl=document.getElementById('ultimo-sono-home');
  const qM={otima:'üòä √ìtima',boa:'üôÇ Boa',regular:'üòê Regular',ruim:'üòî Ruim',pessima:'üò´ P√©ssima'};
  const bM={otima:'badge-good',boa:'badge-good',regular:'badge-warn',ruim:'badge-bad',pessima:'badge-bad'};
  if (!state.sono.length) {
    const m='<p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">Nenhum registro ainda</p>';
    c.innerHTML=m; hEl.innerHTML=m; return;
  }
  const mk=r=>`<div class="historico-item"><div><div style="font-weight:600;font-size:0.88rem;">${r.data}</div><div class="historico-data">${qM[r.qualidade]}</div></div><div style="display:flex;align-items:center;gap:8px;"><span style="font-weight:700;color:var(--primary);">${r.horas}h</span><span class="badge ${bM[r.qualidade]}">${r.horas>=7?'OK':'Baixo'}</span></div></div>`;
  c.innerHTML=state.sono.map(mk).join('');
  hEl.innerHTML=mk(state.sono[0]);
}

// ========== METAS (FIXAS + DI√ÅRIAS) ==========
function renderMetas() {
  const c = document.getElementById('lista-metas');
  const prioOrder = {alta:0, media:1, baixa:2};
  const prioLabel = {alta:'üî¥ Alta', media:'üü° M√©dia', baixa:'üü¢ Baixa'};
  const prioClass = {alta:'prio-alta', media:'prio-media', baixa:'prio-baixa'};
  const prioItemClass = {alta:'prio-alta-item', media:'prio-media-item', baixa:'prio-baixa-item'};

  // Ordena por: pendentes primeiro, depois por prioridade
  const sortFn = (a,b) => {
    if (a.done !== b.done) return a.done ? 1 : -1;
    return (prioOrder[a.prioridade||'media']||1) - (prioOrder[b.prioridade||'media']||1);
  };

  const fixas = [...state.metasFixas].sort(sortFn);
  const diarias = state.metas.filter(m => m.tipo==='diaria' || !m.tipo).sort(sortFn);

  const mkMeta = (m, isFixa) => {
    const prio = m.prioridade || 'media';
    const toggleFn = isFixa ? `toggleMetaFixa('${m.id}')` : `toggleMeta(${m.id})`;
    const removeFn = isFixa ? `removerMetaFixa('${m.id}')` : `removerMeta(${m.id})`;
    return `
      <div class="meta-item ${isFixa?'fixa':''} ${prioItemClass[prio]} ${m.done?'done':''}" onclick="${toggleFn}">
        <div class="meta-check">${m.done?'‚úì':''}</div>
        <div class="meta-text">
          <div class="meta-title" style="${m.done?'text-decoration:line-through;color:var(--text-light)':''}">
            ${m.texto}
            <span class="prio-tag ${prioClass[prio]}">${prioLabel[prio]}</span>
          </div>
          <div class="meta-sub">${m.done?'Conclu√≠da! üéâ':'Toque para concluir'}</div>
        </div>
        <div onclick="event.stopPropagation();${removeFn}" style="font-size:1.1rem;color:#B0BEC5;padding:4px;">‚úï</div>
      </div>`;
  };

  let html = '';
  if (fixas.length) {
    html += `<div class="meta-secao-titulo">üìå Metas Fixas <span class="tag tag-fixa">se repetem todo dia</span></div>`;
    html += fixas.map(m => mkMeta(m, true)).join('');
  }
  if (diarias.length) {
    html += `<div class="meta-secao-titulo">üìÖ Metas Di√°rias <span class="tag tag-diaria">somem amanh√£</span></div>`;
    html += diarias.map(m => mkMeta(m, false)).join('');
  }
  if (!fixas.length && !diarias.length) {
    html = '<p style="color:var(--text-light);text-align:center;font-size:0.85rem;padding:16px;">Nenhuma meta. Adicione acima!</p>';
  }
  c.innerHTML = html;
  updateMetaProg();
}

function toggleMeta(id) {
  const m = state.metas.find(m=>m.id===id);
  if (m) { m.done=!m.done; salvar(); renderMetas(); updateStats(); if(m.done) showToast('üéâ Meta conclu√≠da!'); }
}
function toggleMetaFixa(id) {
  const m = state.metasFixas.find(m=>m.id===id);
  if (m) { m.done=!m.done; salvar(); renderMetas(); updateStats(); if(m.done) showToast('üéâ Meta conclu√≠da!'); }
}
function adicionarMeta() {
  const inp = document.getElementById('nova-meta-input');
  const tipo = document.getElementById('nova-meta-tipo').value;
  const prio = document.getElementById('nova-meta-prio').value;
  const txt = inp.value.trim();
  if (!txt) { showToast('‚ö†Ô∏è Digite uma meta!'); return; }
  if (tipo === 'fixa') {
    state.metasFixas.push({id:'f'+Date.now(), texto:txt, done:false, tipo:'fixa', prioridade:prio});
  } else {
    state.metas.push({id:Date.now(), texto:txt, done:false, tipo:'diaria', prioridade:prio});
  }
  inp.value=''; salvar(); renderMetas(); updateStats();
  const prioEmoji = prio==='alta'?'üî¥':prio==='media'?'üü°':'üü¢';
  showToast(tipo==='fixa'?`üìå Meta fixa ${prioEmoji} adicionada!`:`‚úÖ Meta di√°ria ${prioEmoji} adicionada!`);
}
function removerMeta(id) {
  state.metas=state.metas.filter(m=>m.id!==id); salvar(); renderMetas(); updateStats(); showToast('üóëÔ∏è Meta removida');
}
function removerMetaFixa(id) {
  state.metasFixas=state.metasFixas.filter(m=>m.id!==id); salvar(); renderMetas(); updateStats(); showToast('üóëÔ∏è Meta fixa removida');
}
function limparConcluidas() {
  state.metas=state.metas.filter(m=>!m.done); salvar(); renderMetas(); updateStats(); showToast('üßπ Di√°rias conclu√≠das removidas!');
}
function updateMetaProg() {
  const fixasDone = state.metasFixas.filter(m=>m.done).length;
  const diariasDone = state.metas.filter(m=>m.done && (m.tipo==='diaria'||!m.tipo)).length;
  const tot = state.metasFixas.length + state.metas.filter(m=>m.tipo==='diaria'||!m.tipo).length;
  const dn = fixasDone + diariasDone;
  const pct = tot>0?Math.round((dn/tot)*100):0;
  document.getElementById('meta-progress').style.width=pct+'%';
  document.getElementById('meta-info').textContent=dn+' conclu√≠da'+(dn!==1?'s':'');
  document.getElementById('meta-pct').textContent=pct+'%';
}
function renderHistMetas() {
  const c=document.getElementById('historico-metas-lista');
  if (!state.metasHist.length) {
    c.innerHTML='<p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">O hist√≥rico aparecer√° aqui a partir de amanh√£.</p>';
    return;
  }
  const fmtD=iso=>{const p=iso.split('-');return p[2]+'/'+p[1]+'/'+p[0];};
  c.innerHTML=state.metasHist.slice(0,7).map(h=>{
    const pct=h.total>0?Math.round((h.concluidas/h.total)*100):0;
    const cls=pct>=80?'badge-good':pct>=50?'badge-warn':'badge-bad';
    return`<div class="meta-hist-card"><div><div style="font-weight:600;font-size:0.88rem;">${fmtD(h.data)}</div><div style="font-size:0.8rem;color:var(--text-light);">${h.concluidas} de ${h.total} metas conclu√≠das</div></div><span class="badge ${cls}">${pct}%</span></div>`;
  }).join('');
}

// ========== LEITURA (NOVO) ==========
function salvarLeitura() {
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ registra leitura para hoje'); return; }
  const val = parseInt(document.getElementById('paginas-input').value);
  if (!val || val < 0) { showToast('‚ö†Ô∏è Informe um n√∫mero v√°lido de p√°ginas!'); return; }
  state.leitura = { paginas: val, data: hojeISO() };
  salvar(); renderLeitura(); showToast('üìö Leitura registrada!');
}
function renderLeitura() {
  const form = document.getElementById('leitura-form');
  const reg = document.getElementById('leitura-registrada');
  if (state.leitura) {
    form.style.display='none'; reg.style.display='block';
    const cls = state.leitura.paginas>=20?'badge-good':state.leitura.paginas>=5?'badge-warn':'badge-bad';
    const msg = state.leitura.paginas>=20?'Excelente! üèÜ':state.leitura.paginas>=5?'Bom progresso! üëç':'Leia mais amanh√£! üí™';
    reg.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
      <div><div style="font-weight:700;font-size:1.2rem;color:var(--primary);">üìñ ${state.leitura.paginas} p√°ginas</div><div style="font-size:0.78rem;color:var(--text-light);">${msg}</div></div>
      <span class="badge ${cls}">${state.leitura.paginas>=20?'√ìtimo':state.leitura.paginas>=5?'Ok':'Baixo'}</span>
    </div><button onclick="resetarLeitura()" style="margin-top:10px;font-size:0.78rem;color:var(--text-light);background:none;border:none;cursor:pointer;text-decoration:underline;">Editar registro</button>`;
  } else {
    form.style.display='block'; reg.style.display='none';
  }
}
function resetarLeitura() {
  state.leitura=null; salvar();
  document.getElementById('paginas-input').value='';
  renderLeitura();
}

// ========== CELULAR ==========
function avalCelular(h,m) {
  const t=h*60+m;
  if(t<=120) return{msg:'Excelente controle!',badge:'badge-good',label:'√ìtimo'};
  if(t<=240) return{msg:'Uso moderado',badge:'badge-warn',label:'OK'};
  return{msg:'Uso elevado ‚Äî tente reduzir',badge:'badge-bad',label:'Alto'};
}
function salvarCelular() {
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ registra para hoje'); return; }
  const h=parseInt(document.getElementById('celular-horas').value)||0;
  const m=parseInt(document.getElementById('celular-minutos').value)||0;
  if(h===0&&m===0){showToast('‚ö†Ô∏è Informe o tempo de celular!');return;}
  state.celular={horas:h,minutos:m}; salvar(); renderCelular(); showToast('üì± Tempo de celular salvo!');
}
function salvarCelularCaverna() {
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ registra para hoje'); return; }
  const h=parseInt(document.getElementById('cav-cel-h').value)||0;
  const m=parseInt(document.getElementById('cav-cel-m').value)||0;
  if(h===0&&m===0){showToast('‚ö†Ô∏è Informe o tempo!');return;}
  state.celular={horas:h,minutos:m}; salvar(); renderCelular(); showToast('üì± Tempo salvo!');
}
function renderCelular() {
  const hD=document.getElementById('celular-home-display');
  const hR=document.getElementById('celular-registrado-home');
  const cF=document.getElementById('cav-celular-form');
  const cR=document.getElementById('cav-celular-registrado');
  if (state.celular) {
    const txt=state.celular.horas+'h '+state.celular.minutos+'min';
    const av=avalCelular(state.celular.horas,state.celular.minutos);
    hD.style.display='none'; hR.style.display='block';
    hR.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;"><div><div style="font-weight:700;font-size:1.1rem;color:var(--primary);">üì± ${txt}</div><div style="font-size:0.78rem;color:var(--text-light);">${av.msg}</div></div><span class="badge ${av.badge}">${av.label}</span></div><button onclick="resetarCelular()" style="margin-top:10px;font-size:0.78rem;color:var(--text-light);background:none;border:none;cursor:pointer;text-decoration:underline;">Editar registro</button>`;
    cF.style.display='none'; cR.style.display='block';
    cR.innerHTML=`<div style="background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.3);border-radius:10px;padding:12px;margin-top:10px;color:#A78BFA;font-size:0.85rem;">üì± <strong style="color:#E0E0FF;">${txt}</strong> ‚Äî ${av.msg}</div><button onclick="resetarCelular()" style="margin-top:8px;font-size:0.75rem;color:#6B7280;background:none;border:none;cursor:pointer;text-decoration:underline;">Editar</button>`;
  } else {
    hD.style.display='block'; hR.style.display='none';
    cF.style.display='block'; cR.style.display='none';
  }
}
function resetarCelular() {
  state.celular=null; salvar();
  document.getElementById('celular-horas').value='';
  document.getElementById('celular-minutos').value='';
  renderCelular();
}

// ========== STATS ==========
function updateStats() {
  const fixasDone=state.metasFixas.filter(m=>m.done).length;
  const diariasDone=state.metas.filter(m=>m.done&&(m.tipo==='diaria'||!m.tipo)).length;
  const tot=state.metasFixas.length+state.metas.filter(m=>m.tipo==='diaria'||!m.tipo).length;
  const dn=fixasDone+diariasDone;
  const pct=tot>0?Math.round((dn/tot)*100):0;
  const ult=state.sono[0];
  document.getElementById('stat-sono').textContent=ult?ult.horas+'h':'‚Äî';
  document.getElementById('stat-metas').textContent=dn+'/'+tot;
  document.getElementById('progress-fill').style.width=pct+'%';
  document.getElementById('progress-text').textContent=dn+' de '+tot+' metas conclu√≠das';
  document.getElementById('progress-pct').textContent=pct+'%';
}

// ========== POMODORO (BUG CORRIGIDO) ==========
function togglePomodoro() {
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è Modo Caverna s√≥ para hoje'); return; }
  if (state.pom.rodando) pausarPom(); else iniciarPom();
}
function iniciarPom() {
  state.pom.rodando=true;
  document.getElementById('caverna-play-btn').textContent='‚è∏';
  // CORRE√á√ÉO: garante que seg tem valor v√°lido antes de iniciar
  if (!state.pom.seg || isNaN(state.pom.seg) || state.pom.seg <= 0) {
    state.pom.seg = state.pom.fase==='foco' ? POM_FOCO : POM_PAUSA;
  }
  atualizarUIPom(); // Atualiza display antes de iniciar o intervalo
  state.pom.timer = setInterval(tickPom, 1000);
}
function pausarPom() {
  state.pom.rodando=false;
  document.getElementById('caverna-play-btn').textContent='‚ñ∂';
  clearInterval(state.pom.timer);
  salvar();
}
function tickPom() {
  state.pom.seg--;
  if (state.pom.seg <= 0) concluirFase();
  else atualizarUIPom();
}
function concluirFase() {
  clearInterval(state.pom.timer); state.pom.rodando=false;
  if (state.pom.fase==='foco') {
    state.pom.sessoes++; state.pom.sessNoCiclo++; state.pom.minFoco+=20;
    if (state.pom.sessNoCiclo>=SESS_CICLO) {
      state.pom.ciclos++; state.pom.sessNoCiclo=0; showToast('üèÜ Ciclo completo! Fa√ßa uma pausa maior.');
    } else {
      showToast('‚úÖ Sess√£o conclu√≠da! Hora de pausar!');
    }
    state.pom.fase='pausa'; state.pom.seg=POM_PAUSA;
  } else {
    state.pom.fase='foco'; state.pom.seg=POM_FOCO; showToast('üéØ Hora de focar!');
  }
  state.pom.data=hojeISO(); salvar();
  document.getElementById('caverna-play-btn').textContent='‚ñ∂';
  atualizarUIPom(); playBeep();
}
function pularFase() {
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è Modo Caverna s√≥ para hoje'); return; }
  clearInterval(state.pom.timer); state.pom.rodando=false;
  document.getElementById('caverna-play-btn').textContent='‚ñ∂';
  if (state.pom.fase==='foco') { state.pom.fase='pausa'; state.pom.seg=POM_PAUSA; }
  else { state.pom.fase='foco'; state.pom.seg=POM_FOCO; }
  atualizarUIPom(); salvar();
}
function resetarPomodoro() {
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è Modo Caverna s√≥ para hoje'); return; }
  clearInterval(state.pom.timer); state.pom.rodando=false;
  state.pom.fase='foco'; state.pom.seg=POM_FOCO;
  document.getElementById('caverna-play-btn').textContent='‚ñ∂';
  atualizarUIPom(); showToast('üîÑ Timer reiniciado'); salvar();
}

// NOVO: adicionar ciclos manualmente
function adicionarCiclosManuais() {
  if (state.currentDate !== hojeISO()) { showToast('‚ö†Ô∏è S√≥ para hoje'); return; }
  const val = parseInt(document.getElementById('ciclos-manual-input').value)||0;
  if (val <= 0) { showToast('‚ö†Ô∏è Informe quantos ciclos!'); return; }
  state.pom.ciclos += val;
  state.pom.sessoes += val * SESS_CICLO;
  state.pom.minFoco += val * SESS_CICLO * 20;
  document.getElementById('ciclos-manual-input').value='';
  salvar(); renderPom();
  showToast(`‚úÖ +${val} ciclo${val>1?'s':''} adicionado${val>1?'s':''}!`);
}

function atualizarUIPom() {
  const p = state.pom;
  // CORRE√á√ÉO: garante valores num√©ricos v√°lidos
  const seg = (typeof p.seg === 'number' && !isNaN(p.seg) && p.seg >= 0) ? p.seg : (p.fase==='foco'?POM_FOCO:POM_PAUSA);
  const total = p.fase==='foco' ? POM_FOCO : POM_PAUSA;
  const prog = (total - seg) / total;

  document.getElementById('caverna-ring-fill').style.strokeDashoffset = CIRC*(1-prog);
  document.getElementById('caverna-ring-fill').style.stroke = p.fase==='foco'?'#A78BFA':'#60A5FA';

  // CORRE√á√ÉO: usa Math.floor e Math.floor explicitamente ‚Äî corrige NaN:NaN
  const mm = Math.floor(seg / 60);
  const ss = Math.floor(seg % 60);
  document.getElementById('caverna-time-display').textContent = pad(mm)+':'+pad(ss);
  document.getElementById('caverna-phase-label').textContent = p.fase==='foco'?'FOCO':'PAUSA';

  const badge = document.getElementById('caverna-status-badge');
  const isFull = seg === (p.fase==='foco'?POM_FOCO:POM_PAUSA);
  if (!p.rodando && isFull) { badge.textContent='‚è∏ Aguardando in√≠cio'; badge.className='caverna-status-badge status-idle'; }
  else if (p.fase==='foco') { badge.textContent=p.rodando?'üéØ Em foco':'‚è∏ Foco pausado'; badge.className='caverna-status-badge status-foco'; }
  else { badge.textContent=p.rodando?'‚òï Pausa ativa':'‚è∏ Pausa pausada'; badge.className='caverna-status-badge status-pausa'; }

  renderPom();
}
function renderPom() {
  const p=state.pom;
  document.getElementById('cav-sessoes').textContent=p.sessoes;
  const min=p.minFoco;
  document.getElementById('cav-foco-total').textContent=min>=60?Math.floor(min/60)+'h'+(min%60>0?min%60+'m':''):min+'min';
  document.getElementById('cav-ciclos').textContent=p.ciclos;
  let html='';
  for(let i=0;i<SESS_CICLO;i++){
    if(i<p.sessNoCiclo) html+=`<div class="session-dot completo">‚úì</div>`;
    else if(i===p.sessNoCiclo&&p.fase==='foco'&&p.rodando) html+=`<div class="session-dot atual">${i+1}</div>`;
    else html+=`<div class="session-dot">${i+1}</div>`;
  }
  document.getElementById('session-dots').innerHTML=html;
}
function playBeep() {
  try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.frequency.value=440;g.gain.setValueAtTime(0.3,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.6);o.start(ctx.currentTime);o.stop(ctx.currentTime+0.6);}catch(e){}
}

// ========== RELAT√ìRIO DI√ÅRIO ==========
function abrirRelatorio() {
  const now=new Date();
  document.getElementById('relatorio-date').textContent=now.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

  // Sistema de pontos com detalhamento
  let pts=0, max=0;
  const pontosDetalhe = [];
  const dicas = [];

  // SONO (0-25pts)
  const sh=state.sono.find(s=>s.data===hoje());
  let sonoH='';
  max+=25;
  if(sh){
    const qM={otima:'üòä √ìtima',boa:'üôÇ Boa',regular:'üòê Regular',ruim:'üòî Ruim',pessima:'üò´ P√©ssima'};
    const p=sh.horas>=7?25:sh.horas>=5?15:5; pts+=p;
    pontosDetalhe.push({label:'üò¥ Sono', pts:p, max:25, ok:sh.horas>=7});
    if(sh.horas<7) dicas.push(`Tente dormir ${7-sh.horas<=1?'mais 1 hora':'pelo menos 7h'} ‚Äî sono adequado potencializa o foco e o efeito do tratamento.`);
    sonoH=`<div class="rel-section" style="border-color:#1565C0;"><h3>üò¥ Sono</h3><div class="rel-row"><span>Horas dormidas</span><span class="rv">${sh.horas}h</span></div><div class="rel-row"><span>Qualidade</span><span class="rv">${qM[sh.qualidade]}</span></div><div class="rel-row"><span>Avalia√ß√£o</span><span class="rv">${sh.horas>=7?'‚úÖ Adequado':sh.horas>=5?'‚ö†Ô∏è Abaixo do ideal':'‚ùå Insuficiente'}</span></div></div>`;
  } else {
    pontosDetalhe.push({label:'üò¥ Sono', pts:0, max:25, ok:false});
    dicas.push('Registre seu sono diariamente ‚Äî √© um dos dados mais importantes para acompanhar o TDAH.');
    sonoH=`<div class="rel-section" style="border-color:#B0BEC5;"><h3>üò¥ Sono</h3><p style="font-size:0.83rem;color:var(--text-light);">N√£o registrado hoje.</p></div>`;
  }

  // METAS (0-30pts)
  const fixasDone=state.metasFixas.filter(m=>m.done).length;
  const tot=state.metasFixas.length+state.metas.filter(m=>m.tipo==='diaria'||!m.tipo).length;
  const dn=fixasDone+state.metas.filter(m=>m.done&&(m.tipo==='diaria'||!m.tipo)).length;
  const pctM=tot>0?Math.round((dn/tot)*100):0;
  max+=30; const ptsMetas=Math.round((pctM/100)*30); pts+=ptsMetas;
  pontosDetalhe.push({label:'üéØ Metas', pts:ptsMetas, max:30, ok:pctM>=70});
  if(pctM<70 && tot>0) {
    const pendentes=tot-dn;
    dicas.push(`Ficaram ${pendentes} meta${pendentes>1?'s':''} pendente${pendentes>1?'s':''}. Tente come√ßar pelas de üî¥ alta prioridade ‚Äî dividir em etapas menores pode ajudar.`);
  }
  const todasMetas=[...state.metasFixas,...state.metas.filter(m=>m.tipo==='diaria'||!m.tipo)];
  const metasH=`<div class="rel-section" style="border-color:#2E7D32;"><h3>üéØ Metas do Dia</h3><div class="rel-row"><span>Conclu√≠das</span><span class="rv">${dn} de ${tot}</span></div><div class="rel-row"><span>Taxa de conclus√£o</span><span class="rv">${pctM}%</span></div>${todasMetas.map(m=>`<div class="rel-row"><span>${m.tipo==='fixa'?'üìå ':''}<span style="font-size:0.7rem;margin-right:3px;">${m.prioridade==='alta'?'üî¥':m.prioridade==='baixa'?'üü¢':'üü°'}</span>${m.texto}</span><span class="rv">${m.done?'‚úÖ':'‚¨ú'}</span></div>`).join('')}</div>`;

  // MODO CAVERNA (0-25pts)
  const p=state.pom; max+=25;
  const ptsPom=Math.min(25,Math.round((p.minFoco/80)*25)); pts+=ptsPom;
  pontosDetalhe.push({label:'üèîÔ∏è Caverna', pts:ptsPom, max:25, ok:p.minFoco>=40});
  if(p.minFoco<40) dicas.push('Tente completar ao menos 2 sess√µes de Modo Caverna amanh√£ (40min de foco). Pequenas sess√µes j√° fazem diferen√ßa no TDAH.');
  const pomH=`<div class="rel-section" style="border-color:#7C3AED;"><h3>üèîÔ∏è Modo Caverna</h3><div class="rel-row"><span>Sess√µes de foco</span><span class="rv">${p.sessoes}</span></div><div class="rel-row"><span>Ciclos completos</span><span class="rv">${p.ciclos}</span></div><div class="rel-row"><span>Tempo de foco</span><span class="rv">${p.minFoco}min</span></div></div>`;

  // CELULAR (0-20pts)
  max+=20;
  let celH='';
  if(state.celular){
    const tm=state.celular.horas*60+state.celular.minutos;
    const ptsCel=tm<=120?20:tm<=240?10:0; pts+=ptsCel;
    pontosDetalhe.push({label:'üì± Tela', pts:ptsCel, max:20, ok:ptsCel>=15});
    if(ptsCel<15) dicas.push('O tempo de tela foi elevado. Tente reduzir em 30min amanh√£ ‚Äî use o Modo Caverna para criar blocos sem celular.');
    const av=avalCelular(state.celular.horas,state.celular.minutos);
    celH=`<div class="rel-section" style="border-color:#F57F17;"><h3>üì± Tempo de Tela</h3><div class="rel-row"><span>Tempo usado</span><span class="rv">${state.celular.horas}h ${state.celular.minutos}min</span></div><div class="rel-row"><span>Avalia√ß√£o</span><span class="rv">${av.msg}</span></div></div>`;
  } else {
    pontosDetalhe.push({label:'üì± Tela', pts:0, max:20, ok:false});
    dicas.push('Registre o tempo de tela amanh√£ para obter uma vis√£o completa do seu dia.');
    celH=`<div class="rel-section" style="border-color:#B0BEC5;"><h3>üì± Tempo de Tela</h3><p style="font-size:0.83rem;color:var(--text-light);">N√£o registrado hoje.</p></div>`;
  }

  // REM√âDIO (informativo, sem pontua√ß√£o obrigat√≥ria)
  let remH='';
  if(state.remedio){
    remH=`<div class="rel-section" style="border-color:#29B6F6;"><h3>üíä Medica√ß√£o</h3><div class="rel-row"><span>Tomado √†s</span><span class="rv">${fmt(state.remedio.horaRegistro)}</span></div><div class="rel-row"><span>Status</span><span class="rv">‚úÖ Registrado hoje</span></div></div>`;
  } else {
    remH=`<div class="rel-section" style="border-color:#B0BEC5;"><h3>üíä Medica√ß√£o</h3><p style="font-size:0.83rem;color:var(--text-light);">N√£o tomada hoje ‚Äî tudo bem, registre quando necess√°rio.</p></div>`;
  }

  // LEITURA (informativa)
  let leitH='';
  if(state.leitura) leitH=`<div class="rel-section" style="border-color:#6A1B9A;"><h3>üìö Leitura</h3><div class="rel-row"><span>P√°ginas lidas</span><span class="rv">${state.leitura.paginas} p√°ginas</span></div></div>`;

  // Pontua√ß√£o final
  const nota=max>0?Math.round((pts/max)*100):0;
  const em=nota>=80?'üèÜ':nota>=60?'‚≠ê':nota>=40?'üí™':'üå±';
  const msg=nota>=80?'Dia excelente!':nota>=60?'Bom progresso!':nota>=40?'Continue tentando!':'Amanh√£ ser√° melhor!';

  // Card de pontos detalhado
  const pontosBar = pontosDetalhe.map(pd=>`
    <div style="margin-bottom:8px;">
      <div style="display:flex;justify-content:space-between;font-size:0.82rem;margin-bottom:3px;">
        <span>${pd.label}</span>
        <span style="font-weight:700;color:${pd.ok?'#2E7D32':'#F57F17'};">${pd.pts}/${pd.max}pts</span>
      </div>
      <div style="height:6px;background:#E3EAF2;border-radius:3px;overflow:hidden;">
        <div style="height:100%;width:${Math.round((pd.pts/pd.max)*100)}%;background:${pd.ok?'linear-gradient(to right,#2E7D32,#66BB6A)':'linear-gradient(to right,#F57F17,#FFA726)'};border-radius:3px;transition:width 0.5s;"></div>
      </div>
    </div>`).join('');

  // Se√ß√£o de dicas
  const dicasH = dicas.length>0 ? `
    <div class="rel-section" style="border-color:#FFB300;background:#FFFDE7;">
      <h3 style="color:#F57F17;">üí° O que melhorar amanh√£</h3>
      ${dicas.map((d,i)=>`<div style="padding:8px 0;border-bottom:${i<dicas.length-1?'1px solid #FFF8E1':'none'};font-size:0.84rem;color:#5D4037;line-height:1.5;">‚Ä¢ ${d}</div>`).join('')}
    </div>` : `<div class="rel-section" style="border-color:#2E7D32;background:#F1F8E9;"><h3 style="color:#2E7D32;">üèÜ Parab√©ns!</h3><p style="font-size:0.84rem;color:#33691E;">Voc√™ teve um dia excelente em todas as categorias. Continue assim!</p></div>`;

  document.getElementById('relatorio-body').innerHTML=`
    <div class="rel-avaliacao">
      <div style="font-size:2rem;">${em}</div>
      <div class="rel-nota">${pts}<span style="font-size:1.2rem;opacity:0.7;">/${max}</span></div>
      <div class="rel-nota-label">${nota}/100 pontos ‚Äî ${msg}</div>
    </div>
    <div class="rel-section" style="border-color:#1565C0;">
      <h3>üìä Pontos por categoria</h3>
      ${pontosBar}
    </div>
    ${dicasH}
    ${sonoH}${metasH}${pomH}${celH}${remH}${leitH}
  `;
  document.getElementById('relatorio-modal').classList.add('show');
}
function fecharRelatorio(e){if(e.target.id==='relatorio-modal')document.getElementById('relatorio-modal').classList.remove('show');}

// ========== RELAT√ìRIO MENSAL CL√çNICO (NOVO) ==========
function gerarRelatorioMensal() {
  const wrap = document.getElementById('relatorio-mensal-wrap');
  const today = new Date();
  const daysN = 30;
  let sonoTotal=0,sonoN=0,sonoAbaixo=0;
  let metasConcl=0,metasTotal=0,diasMeta=0;
  let focoTotal=0,focoN=0;
  let celularTotal=0,celularN=0;
  let remedioN=0,leituraTotal=0,leituraN=0;
  let diasDados=0;

  for (let i=0;i<daysN;i++) {
    const d=new Date(today); d.setDate(today.getDate()-i);
    const iso=hojeISO(d);
    const dd=state.dailyData[iso];
    // Metas fixas: usa check de hoje apenas (n√£o hist√≥rico)
    // Usa o hist√≥rico de metas para dias passados
    const histDia=state.metasHist.find(h=>h.data===iso);
    const metaDia=dd ? (dd.metas||[]) : [];
    const fixaDia=dd ? (dd.metasFixas||[]) : [];

    if (dd || histDia) diasDados++;

    if (dd) {
      if (dd.sono&&dd.sono.length>0) { sonoTotal+=dd.sono[0].horas; sonoN++; if(dd.sono[0].horas<7)sonoAbaixo++; }
      const allMetas=[...metaDia,...fixaDia];
      if (allMetas.length>0) { metasConcl+=allMetas.filter(m=>m.done).length; metasTotal+=allMetas.length; diasMeta++; }
      if (dd.pom&&dd.pom.minFoco>0) { focoTotal+=dd.pom.minFoco; focoN++; }
      if (dd.celular) { celularTotal+=dd.celular.horas*60+dd.celular.minutos; celularN++; }
      if (dd.remedio) remedioN++;
      if (dd.leitura) { leituraTotal+=dd.leitura.paginas; leituraN++; }
    }
  }

  if (diasDados===0) {
    wrap.innerHTML=`<div class="rel-clinico"><div class="rel-clinico-header"><h4>üìã Relat√≥rio Mensal ‚Äî TDAH Care</h4><p>Dados insuficientes</p></div><div class="rel-clinico-body"><p style="color:var(--text-light);font-size:0.85rem;padding:8px;">Registre dados diariamente para gerar o relat√≥rio mensal.</p></div></div>`;
    return;
  }

  const avgSono = sonoN>0 ? (sonoTotal/sonoN).toFixed(1) : null;
  const pctMetas = metasTotal>0 ? Math.round((metasConcl/metasTotal)*100) : null;
  const avgFoco = focoN>0 ? Math.round(focoTotal/focoN) : null;
  const avgCelular = celularN>0 ? Math.round(celularTotal/celularN) : null;
  const pctRemedio = Math.round((remedioN/diasDados)*100);
  const avgLeitura = leituraN>0 ? Math.round(leituraTotal/leituraN) : null;
  const dataRef = today.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});

  // Parecer cl√≠nico autom√°tico
  let pareceres=[];
  if(avgSono!==null){
    if(avgSono<6) pareceres.push('O padr√£o de sono apresenta-se <strong>abaixo do limiar terap√™utico recomendado</strong> (7‚Äì9h), podendo comprometer a efic√°cia do tratamento farmacol√≥gico e agravar sintomas de desaten√ß√£o.');
    else if(avgSono<7) pareceres.push('O tempo m√©dio de sono est√° <strong>lim√≠trofe ao adequado</strong>. Recomenda-se buscar consist√™ncia nos hor√°rios para otimizar a resposta ao medicamento.');
    else pareceres.push('O padr√£o de sono encontra-se <strong>dentro dos par√¢metros recomendados</strong> para potencializa√ß√£o do tratamento do TDAH.');
  }
  if(pctMetas!==null){
    if(pctMetas<50) pareceres.push('A taxa de conclus√£o de metas indica <strong>dificuldade persistente na execu√ß√£o de planejamento</strong>. Considere estrat√©gias de divis√£o de tarefas ou ajuste de metas com o profissional de sa√∫de.');
    else if(pctMetas<80) pareceres.push('A taxa de conclus√£o de metas √© <strong>moderada</strong>, com espa√ßo para melhora. O refor√ßo positivo e a t√©cnica de body doubling podem ser ben√©ficos.');
    else pareceres.push('A taxa de conclus√£o de metas √© <strong>satisfat√≥ria</strong>, indicando boa capacidade de planejamento e execu√ß√£o no per√≠odo analisado.');
  }
  if(pctRemedio<70) pareceres.push('O <strong>registro de uso de medica√ß√£o foi baixo</strong> no per√≠odo. Caso o tratamento farmacol√≥gico fa√ßa parte do plano terap√™utico, registrar os dias de uso auxilia o acompanhamento cl√≠nico. Se o medicamento n√£o √© de uso di√°rio, desconsidere este item.');
  else pareceres.push('O <strong>registro de uso de medica√ß√£o foi frequente</strong> no per√≠odo, o que facilita o acompanhamento da ades√£o ao plano terap√™utico individual.');

  const row=(lbl,val,status,statusTxt)=>`<div class="row"><span class="lbl">${lbl}</span><span class="val">${val}</span><span class="status ${status}">${statusTxt}</span></div>`;

  const sonoStatus=avgSono===null?null:avgSono>=7?'status-norm':avgSono>=6?'status-atenc':'status-criti';
  const metasStatus=pctMetas===null?null:pctMetas>=70?'status-norm':pctMetas>=50?'status-atenc':'status-criti';
  const focoStatus=avgFoco===null?null:avgFoco>=40?'status-norm':avgFoco>=20?'status-atenc':'status-criti';
  const celStatus=avgCelular===null?null:avgCelular<=180?'status-norm':avgCelular<=300?'status-atenc':'status-criti';
  const remStatus=pctRemedio>=80?'status-norm':pctRemedio>=60?'status-atenc':'status-criti';

  wrap.innerHTML=`
    <div class="rel-clinico">
      <div class="rel-clinico-header">
        <h4>üìã Relat√≥rio Cl√≠nico ‚Äî TDAH Care</h4>
        <p>Per√≠odo de refer√™ncia: ${dataRef} ¬∑ ${diasDados} dias com registros</p>
      </div>
      <div class="rel-clinico-body">
        <p style="font-size:0.75rem;color:var(--text-light);margin-bottom:10px;font-style:italic;">An√°lise comportamental e de ades√£o terap√™utica dos √∫ltimos 30 dias.</p>
        ${avgSono!==null?row('M√©dia de sono di√°rio', avgSono+'h', sonoStatus, avgSono>=7?'Normal':avgSono>=6?'Aten√ß√£o':'Cr√≠tico'):''}
        ${sonoN>0?row('Noites abaixo de 7h', sonoAbaixo+' de '+sonoN, sonoAbaixo>sonoN/2?'status-criti':'status-norm', sonoAbaixo>sonoN/2?'Frequente':'Raro'):''}
        ${pctMetas!==null?row('Taxa de conclus√£o de metas', pctMetas+'%', metasStatus, pctMetas>=70?'Adequada':pctMetas>=50?'Moderada':'Baixa'):''}
        ${avgFoco!==null?row('M√©dia de foco di√°rio (Caverna)', avgFoco+'min', focoStatus, avgFoco>=40?'Adequado':avgFoco>=20?'Moderado':'Baixo'):''}
        ${avgCelular!==null?row('M√©dia de tempo de tela', Math.floor(avgCelular/60)+'h '+avgCelular%60+'min', celStatus, avgCelular<=180?'Controlado':avgCelular<=300?'Moderado':'Elevado'):''}
        ${row('Dias com registro de medica√ß√£o', remedioN+' de '+diasDados, remStatus, pctRemedio>=80?'Frequente':pctRemedio>=60?'Moderado':'Baixo')}
        ${avgLeitura!==null?row('M√©dia de leitura di√°ria', avgLeitura+' p√°ginas', avgLeitura>=10?'status-norm':'status-atenc', avgLeitura>=10?'Regular':'Abaixo da meta'):''}
      </div>
    </div>
    <div class="rel-parecer">
      <strong>üìù Parecer cl√≠nico-comportamental:</strong><br><br>
      ${pareceres.join('<br><br>')}
      <br><br>
      <em style="font-size:0.78rem;color:#90A4AE;">‚ö†Ô∏è Este relat√≥rio √© gerado automaticamente com base nos dados registrados e tem car√°ter informativo. N√£o substitui avalia√ß√£o profissional.</em>
    </div>
  `;
}

// ========== CALEND√ÅRIO ==========
function renderCalendar(date) {
  const yr=date.getFullYear(), mo=date.getMonth();
  document.getElementById('current-month-year').textContent=date.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  const firstDay=new Date(yr,mo,1).getDay();
  const daysInMonth=new Date(yr,mo+1,0).getDate();
  const prevLast=new Date(yr,mo,0).getDate();
  let html='';
  for(let i=firstDay-1;i>=0;i--) html+=`<div class="calendar-day inactive">${prevLast-i}</div>`;
  for(let i=1;i<=daysInMonth;i++){
    const d=new Date(yr,mo,i);
    const iso=hojeISO(d);
    const isToday=iso===hojeISO();
    const isSel=iso===state.currentDate&&state.currentDate!==hojeISO();
    const dd=state.dailyData[iso];
    let met='';
    if(dd){
      const s=dd.sono&&dd.sono.length>0?dd.sono[0].horas:null;
      const mTot=(dd.metas||[]).length+(dd.metasFixas||[]).length;
      const mDone=(dd.metas||[]).filter(m=>m.done).length+(dd.metasFixas||[]).filter(m=>m.done).length;
      const pf=dd.pom?dd.pom.minFoco:0;
      if(s) met+=`<span class="${s>=7?'m-ok':s>=5?'m-warn':'m-bad'}">üò¥${s}h</span>`;
      if(mTot>0) met+=`<span class="${mDone/mTot>=0.8?'m-ok':mDone/mTot>=0.5?'m-warn':'m-bad'}">‚úÖ${mDone}/${mTot}</span>`;
      if(pf>0) met+=`<span class="${pf>=40?'m-ok':'m-warn'}">üèîÔ∏è${pf}m</span>`;
    }
    html+=`<div class="calendar-day${isToday?' today':''}${isSel?' selected':''}" onclick="selectDay('${iso}',this)">${i}${met?`<div class="calendar-day-metrics">${met}</div>`:''}</div>`;
  }
  const rem=42-(firstDay+daysInMonth);
  for(let i=1;i<=rem;i++) html+=`<div class="calendar-day inactive">${i}</div>`;
  document.getElementById('calendar-grid-days').innerHTML=html;
}
function changeMonth(d){
  currentCalendarDate.setMonth(currentCalendarDate.getMonth()+d);
  renderCalendar(currentCalendarDate);
}
function selectDay(iso,el){
  document.querySelectorAll('.calendar-day').forEach(d=>d.classList.remove('selected'));
  el.classList.add('selected');
  carregarDia(iso);
  mostrarSumarioDia(iso);
}
function mostrarSumarioDia(iso){
  const card=document.getElementById('daily-summary-card');
  const dd=state.dailyData[iso];
  const dataFmt=new Date(iso+'T12:00:00').toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  if(!dd){card.innerHTML=`<div class="daily-sum-card"><div class="card-title">Sum√°rio ‚Äî ${dataFmt}</div><p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">Nenhum dado registrado para este dia.</p></div>`;card.style.display='block';return;}
  const qM={otima:'üòä √ìtima',boa:'üôÇ Boa',regular:'üòê Regular',ruim:'üòî Ruim',pessima:'üò´ P√©ssima'};
  let html=`<div class="daily-sum-card"><div class="card-title">Sum√°rio ‚Äî ${dataFmt}</div>`;
  const s=dd.sono&&dd.sono.length>0?dd.sono[0]:null;
  if(s) html+=`<div class="rel-section" style="border-color:#1565C0"><h3>üò¥ Sono</h3><div class="rel-row"><span>Horas</span><span class="rv">${s.horas}h</span></div><div class="rel-row"><span>Qualidade</span><span class="rv">${qM[s.qualidade]}</span></div></div>`;
  const mAll=[...(dd.metasFixas||[]),...(dd.metas||[])];
  if(mAll.length>0){const dn=mAll.filter(m=>m.done).length;html+=`<div class="rel-section" style="border-color:#2E7D32"><h3>üéØ Metas</h3><div class="rel-row"><span>Conclu√≠das</span><span class="rv">${dn}/${mAll.length}</span></div>${mAll.map(m=>`<div class="rel-row"><span>${m.tipo==='fixa'?'üìå ':''}${m.texto}</span><span class="rv">${m.done?'‚úÖ':'‚¨ú'}</span></div>`).join('')}</div>`;}
  if(dd.pom&&(dd.pom.sessoes>0||dd.pom.ciclos>0))html+=`<div class="rel-section" style="border-color:#7C3AED"><h3>üèîÔ∏è Caverna</h3><div class="rel-row"><span>Sess√µes</span><span class="rv">${dd.pom.sessoes}</span></div><div class="rel-row"><span>Ciclos</span><span class="rv">${dd.pom.ciclos}</span></div><div class="rel-row"><span>Foco total</span><span class="rv">${dd.pom.minFoco}min</span></div></div>`;
  if(dd.celular)html+=`<div class="rel-section" style="border-color:#F57F17"><h3>üì± Tela</h3><div class="rel-row"><span>Tempo</span><span class="rv">${dd.celular.horas}h ${dd.celular.minutos}min</span></div></div>`;
  if(dd.leitura)html+=`<div class="rel-section" style="border-color:#6A1B9A"><h3>üìö Leitura</h3><div class="rel-row"><span>P√°ginas</span><span class="rv">${dd.leitura.paginas}</span></div></div>`;
  html+='</div>';
  card.innerHTML=html; card.style.display='block';
}

function switchInfo(tab,btn){
  document.querySelectorAll('.info-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.info-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('info-'+tab).classList.add('active');
  btn.classList.add('active');
  if(tab==='mensal') gerarRelatorioMensal();
}

init();
</script>
</body>
</html>
