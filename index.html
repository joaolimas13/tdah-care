<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TDAH Care</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --primary: #1565C0; --primary-light: #1976D2; --primary-dark: #0D47A1;
  --accent: #29B6F6; --bg: #F0F4F8; --text: #1A237E; --text-light: #546E7A;
  --success: #2E7D32; --shadow: 0 2px 12px rgba(21,101,192,0.10); --radius: 16px;
}
body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; max-width: 430px; margin: 0 auto; }
.header { background: linear-gradient(135deg, var(--primary-dark), var(--primary-light)); color: white; padding: 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.header h1 { font-size: 1.3rem; font-weight: 700; }
.header span { font-size: 0.8rem; opacity: 0.85; display: block; }
.nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 430px; background: white; display: flex; box-shadow: 0 -2px 12px rgba(21,101,192,0.12); z-index: 100; }
.nav-btn { flex: 1; padding: 10px 2px; border: none; background: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 3px; font-size: 0.58rem; color: var(--text-light); transition: all 0.2s; }
.nav-btn .icon { font-size: 1.25rem; }
.nav-btn.active { color: var(--primary); }
.nav-btn.active .icon { transform: translateY(-2px); }
.nav-btn.caverna-nav { background: linear-gradient(135deg, #1A1A2E, #16213E); color: #E0E0FF; }
.nav-btn.caverna-nav.active { color: #A78BFA; }
.page { display: none; padding: 20px; padding-bottom: 85px; }
.page.active { display: block; }
.card { background: white; border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow); }
.card-title { font-size: 0.85rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 14px; }
.greeting { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
.greeting h2 { font-size: 1.2rem; margin-bottom: 4px; }
.greeting p { font-size: 0.85rem; opacity: 0.9; }
.stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.stat-card { background: white; border-radius: 12px; padding: 14px 10px; text-align: center; box-shadow: var(--shadow); }
.stat-icon { font-size: 1.5rem; margin-bottom: 4px; }
.stat-value { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
.stat-label { font-size: 0.65rem; color: var(--text-light); }
.form-group { margin-bottom: 16px; }
label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text); }
input, select, textarea { width: 100%; padding: 12px 14px; border: 2px solid #E3EAF2; border-radius: 10px; font-size: 0.95rem; outline: none; transition: border 0.2s; background: #F8FAFF; }
input:focus, select:focus, textarea:focus { border-color: var(--primary); background: white; }
textarea { resize: none; height: 80px; }
.btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
.btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; }
.btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
.remedio-card { background: linear-gradient(135deg, #E3F2FD, #F0F7FF); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; border: 2px solid #BBDEFB; }
.remedio-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
.remedio-title { font-weight: 700; color: var(--primary); font-size: 0.95rem; }
.remedio-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
.badge-ativo { background: #E8F5E9; color: #2E7D32; }
.badge-inativo { background: #FFEBEE; color: #C62828; }
.badge-encerrado { background: #FFF8E1; color: #F57F17; }
.remedio-progress-bar { height: 14px; background: #E3EAF2; border-radius: 7px; overflow: hidden; }
.remedio-progress-fill { height: 100%; border-radius: 7px; transition: width 1s ease; position: relative; }
.remedio-progress-fill::after { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:linear-gradient(90deg,transparent,rgba(255,255,255,0.3),transparent); animation: shimmer 2s infinite; }
@keyframes shimmer { 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }
.remedio-info-row { display: flex; justify-content: space-between; font-size: 0.78rem; color: var(--text-light); margin-top: 6px; }
.remedio-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
.remedio-stat { background: white; border-radius: 10px; padding: 10px; text-align: center; }
.remedio-stat .val { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
.remedio-stat .lbl { font-size: 0.7rem; color: var(--text-light); }
.remedio-fase-box { background: white; border-radius: 10px; padding: 12px 14px; margin-top: 12px; border-left: 4px solid var(--primary); }
.remedio-fase-titulo { font-size: 0.72rem; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.remedio-fase-desc { font-size: 0.82rem; color: var(--text-light); line-height: 1.5; }
.aviso-encerrado { background: #FFF8E1; border: 2px solid #FFE082; border-radius: 12px; padding: 16px; margin-top: 12px; display: none; }
.aviso-encerrado h4 { color: #F57F17; font-size: 0.9rem; margin-bottom: 8px; }
.aviso-encerrado p { font-size: 0.82rem; color: #5D4037; line-height: 1.6; }
.aviso-encerrado.show { display: block; }
.time-input-wrap { display: flex; gap: 10px; align-items: flex-end; }
.time-input-wrap input[type="time"] { flex: 1; }
.time-input-wrap button { padding: 12px 18px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 0.9rem; font-weight: 700; cursor: pointer; white-space: nowrap; }
.sono-visual { display: flex; align-items: center; justify-content: center; gap: 16px; padding: 16px 0; }
.sono-circle { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-dark), var(--accent)); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; box-shadow: 0 4px 16px rgba(21,101,192,0.35); }
.sono-circle .horas { font-size: 1.8rem; font-weight: 800; }
.sono-circle .label { font-size: 0.65rem; opacity: 0.85; }
.sono-info p { font-size: 0.85rem; color: var(--text-light); margin-bottom: 4px; }
.sono-info strong { color: var(--primary); }
.hours-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin: 10px 0; }
.hour-btn { padding: 10px; border: 2px solid #E3EAF2; border-radius: 10px; background: #F8FAFF; font-size: 0.85rem; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s; color: var(--text); }
.hour-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }
.custom-hours { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
.custom-hours input { flex: 1; }
.custom-hours span { font-size: 0.85rem; color: var(--text-light); white-space: nowrap; }
.meta-secao-titulo { font-size: 0.82rem; font-weight: 700; color: var(--text); margin: 14px 0 8px; display: flex; align-items: center; gap: 6px; }
.meta-secao-titulo .tag { font-size: 0.68rem; padding: 2px 8px; border-radius: 10px; font-weight: 700; }
.tag-fixa { background: #E8EAF6; color: #3949AB; }
.tag-diaria { background: #E8F5E9; color: #2E7D32; }
.meta-item { display: flex; align-items: center; gap: 12px; padding: 14px; background: #F8FAFF; border-radius: 12px; margin-bottom: 10px; border: 2px solid transparent; transition: all 0.2s; cursor: pointer; }
.meta-item.done { background: #E8F5E9; border-color: #A5D6A7; }
.meta-item.fixa { border-left: 3px solid #7986CB; }
.prio-tag { font-size: 0.65rem; padding: 2px 7px; border-radius: 8px; font-weight: 700; margin-left: 4px; flex-shrink: 0; }
.prio-alta { background: #FFEBEE; color: #C62828; }
.prio-media { background: #FFF8E1; color: #F57F17; }
.prio-baixa { background: #E8F5E9; color: #2E7D32; }
.meta-item.prio-alta-item { border-top: 2px solid #EF9A9A; }
.meta-item.prio-media-item { border-top: 2px solid #FFE082; }
.meta-item.prio-baixa-item { border-top: 2px solid #A5D6A7; }
.meta-check { width: 26px; height: 26px; border-radius: 50%; border: 2px solid #B0BEC5; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0; }
.meta-item.done .meta-check { background: var(--success); border-color: var(--success); color: white; }
.meta-text { flex: 1; }
.meta-title { font-size: 0.9rem; font-weight: 600; }
.meta-sub { font-size: 0.75rem; color: var(--text-light); }
.progress-bar { height: 8px; background: #E3EAF2; border-radius: 4px; overflow: hidden; margin: 8px 0; }
.progress-fill { height: 100%; background: linear-gradient(to right, var(--primary), var(--accent)); border-radius: 4px; transition: width 0.4s; }
.progress-info { display: flex; justify-content: space-between; font-size: 0.78rem; color: var(--text-light); }
.add-meta-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
.add-meta-row input { flex: 1; }
.add-meta-row select { width: auto; padding: 12px 10px; font-size: 0.82rem; }
.add-meta-row button { padding: 12px 16px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1.2rem; cursor: pointer; flex-shrink: 0; }
.historico-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #EEF2F7; }
.historico-item:last-child { border-bottom: none; }
.historico-data { font-size: 0.8rem; color: var(--text-light); }
.badge { padding: 3px 10px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; }
.badge-good { background: #E8F5E9; color: #2E7D32; }
.badge-warn { background: #FFF8E1; color: #F57F17; }
.badge-bad { background: #FFEBEE; color: #C62828; }
.meta-hist-card { background: #F8FAFF; border-radius: 12px; padding: 12px 14px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #E3EAF2; }
.leitura-row { display: flex; gap: 8px; align-items: center; }
.leitura-row input { flex: 1; }
.leitura-row button { padding: 12px 16px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 0.85rem; font-weight: 700; cursor: pointer; white-space: nowrap; }
.info-tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; }
.info-tab { padding: 8px 14px; border-radius: 20px; border: 2px solid #E3EAF2; background: white; font-size: 0.8rem; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
.info-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
.info-content { display: none; }
.info-content.active { display: block; }
.info-card { background: #F0F7FF; border-left: 4px solid var(--primary); border-radius: 0 12px 12px 0; padding: 16px; margin-bottom: 12px; }
.info-card h3 { font-size: 0.95rem; color: var(--primary); margin-bottom: 8px; }
.info-card p { font-size: 0.85rem; color: var(--text-light); line-height: 1.6; }
.info-tip { background: #FFF8E1; border-left: 4px solid #FFB300; border-radius: 0 12px 12px 0; padding: 12px 16px; margin-bottom: 10px; font-size: 0.83rem; color: #5D4037; line-height: 1.5; }
.toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #1A237E; color: white; padding: 12px 24px; border-radius: 24px; font-size: 0.85rem; font-weight: 600; z-index: 999; opacity: 0; transition: opacity 0.3s; white-space: nowrap; box-shadow: 0 4px 16px rgba(0,0,0,0.2); }
.toast.show { opacity: 1; }
.section-title { font-size: 1rem; font-weight: 700; color: var(--text); margin-bottom: 12px; }
.divider { height: 1px; background: #EEF2F7; margin: 16px 0; }
.btn-danger { background: transparent; border: 2px solid #EF5350; color: #EF5350; border-radius: 12px; padding: 10px; font-size: 0.8rem; font-weight: 700; cursor: pointer; width: 100%; margin-top: 8px; }
#page-caverna { background: #0D0D1A; min-height: 100vh; padding: 20px; padding-bottom: 85px; color: #E0E0FF; }
.caverna-header { text-align: center; margin-bottom: 24px; }
.caverna-header h2 { font-size: 1.5rem; font-weight: 800; background: linear-gradient(135deg, #A78BFA, #60A5FA); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 4px; }
.caverna-header p { font-size: 0.8rem; color: #6B7280; }
.caverna-status-badge { display: block; padding: 6px 16px; border-radius: 20px; font-size: 0.78rem; font-weight: 700; margin-bottom: 24px; text-align: center; }
.status-foco { background: rgba(167,139,250,0.15); color: #A78BFA; border: 1px solid rgba(167,139,250,0.3); }
.status-pausa { background: rgba(96,165,250,0.15); color: #60A5FA; border: 1px solid rgba(96,165,250,0.3); }
.status-idle { background: rgba(107,114,128,0.15); color: #9CA3AF; border: 1px solid rgba(107,114,128,0.3); }
.caverna-timer-wrap { display: flex; justify-content: center; margin-bottom: 32px; }
.caverna-ring { position: relative; width: 220px; height: 220px; }
.caverna-ring svg { position: absolute; top: 0; left: 0; width: 220px; height: 220px; transform: rotate(-90deg); }
.caverna-ring-bg { fill: none; stroke: #1E1E3A; stroke-width: 12; }
.caverna-ring-fill { fill: none; stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 1s linear, stroke 0.5s; }
.caverna-center { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.caverna-time { font-size: 3.2rem; font-weight: 800; color: white; letter-spacing: -2px; line-height: 1; font-variant-numeric: tabular-nums; }
.caverna-phase { font-size: 0.75rem; color: #6B7280; margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; }
.caverna-controls { display: flex; gap: 16px; justify-content: center; margin-bottom: 28px; }
.caverna-btn { width: 64px; height: 64px; border-radius: 50%; border: none; cursor: pointer; font-size: 1.6rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
.caverna-btn-main { width: 80px; height: 80px; font-size: 2rem; background: linear-gradient(135deg, #7C3AED, #4F46E5); color: white; box-shadow: 0 0 30px rgba(124,58,237,0.4); }
.caverna-btn-skip, .caverna-btn-reset { background: rgba(30,30,58,0.8); color: #9CA3AF; border: 1px solid #2D2D4E; }
.caverna-stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.caverna-stat-box { background: rgba(30,30,58,0.6); border: 1px solid #2D2D4E; border-radius: 14px; padding: 14px 10px; text-align: center; }
.caverna-stat-box .v { font-size: 1.3rem; font-weight: 800; color: #A78BFA; display: block; }
.caverna-stat-box .l { font-size: 0.62rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
.caverna-card-dark { background: rgba(20,20,40,0.8); border: 1px solid #2D2D4E; border-radius: 14px; padding: 16px; margin-bottom: 16px; }
.caverna-card-title { font-size: 0.78rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
.session-dot-row { display: flex; gap: 8px; }
.session-dot { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; border: 2px solid #2D2D4E; color: #4B5563; }
.session-dot.completo { background: rgba(124,58,237,0.2); border-color: #7C3AED; color: #A78BFA; }
.session-dot.atual { background: rgba(124,58,237,0.4); border-color: #A78BFA; color: white; animation: pulse-dot 1.5s infinite; }
@keyframes pulse-dot { 0%,100%{box-shadow:0 0 0 0 rgba(167,139,250,0.4)} 50%{box-shadow:0 0 0 6px rgba(167,139,250,0)} }
.cav-input-row { display: flex; gap: 8px; align-items: center; }
.cav-input-row input { flex: 1; background: rgba(30,30,58,0.8); border: 1px solid #3D3D6E; color: #E0E0FF; border-radius: 10px; padding: 10px 14px; font-size: 0.95rem; }
.cav-input-row input::placeholder { color: #4B5563; }
.cav-input-row button { background: linear-gradient(135deg, #7C3AED, #4F46E5); color: white; border: none; border-radius: 10px; padding: 10px 14px; font-size: 0.85rem; font-weight: 700; cursor: pointer; }
.celular-home-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
.celular-home-row input { width: 70px; flex: none; }
.celular-home-row button { padding: 12px 14px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 0.85rem; font-weight: 700; cursor: pointer; }
.ciclos-manual-row { display: flex; gap: 8px; align-items: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid #2D2D4E; }
.ciclos-manual-row input { width: 70px; flex: none; background: rgba(30,30,58,0.8); border: 1px solid #3D3D6E; color: #E0E0FF; border-radius: 10px; padding: 10px 12px; font-size: 0.95rem; }
.ciclos-manual-row span { color: #9CA3AF; font-size: 0.82rem; flex: 1; }
.ciclos-manual-row button { background: rgba(124,58,237,0.4); color: #A78BFA; border: 1px solid #7C3AED; border-radius: 10px; padding: 10px 14px; font-size: 0.85rem; font-weight: 700; cursor: pointer; }
.relatorio-btn { background: linear-gradient(135deg, #1565C0, #29B6F6); color: white; border: none; border-radius: 14px; padding: 16px; width: 100%; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 16px; box-shadow: 0 4px 16px rgba(21,101,192,0.3); }
.relatorio-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 200; align-items: flex-end; justify-content: center; }
.relatorio-modal.show { display: flex; }
.relatorio-content { background: white; border-radius: 24px 24px 0 0; padding: 24px; width: 100%; max-width: 430px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s ease; }
@keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
.relatorio-title { font-size: 1.2rem; font-weight: 800; color: var(--text); margin-bottom: 4px; }
.relatorio-date { font-size: 0.8rem; color: var(--text-light); margin-bottom: 20px; }
.rel-section { background: #F8FAFF; border-radius: 14px; padding: 16px; margin-bottom: 12px; border-left: 4px solid var(--primary); }
.rel-section h3 { font-size: 0.9rem; font-weight: 700; color: var(--primary); margin-bottom: 10px; }
.rel-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid #EEF2F7; font-size: 0.85rem; }
.rel-row:last-child { border-bottom: none; }
.rel-row .rl { color: var(--text-light); }
.rel-row .rv { font-weight: 700; color: var(--text); }
.rel-avaliacao { background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 14px; padding: 20px; text-align: center; color: white; margin-bottom: 12px; }
.rel-nota { font-size: 2.8rem; font-weight: 800; }
.rel-nota-label { font-size: 0.85rem; opacity: 0.9; }
.rel-close-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 8px; }
.rel-clinico { background: white; border-radius: 14px; overflow: hidden; margin-bottom: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
.rel-clinico-header { background: linear-gradient(135deg, #0D47A1, #1565C0); color: white; padding: 16px 20px; }
.rel-clinico-header h4 { font-size: 0.9rem; font-weight: 700; margin-bottom: 2px; }
.rel-clinico-header p { font-size: 0.75rem; opacity: 0.8; }
.rel-clinico-body { padding: 16px 20px; }
.rel-clinico-body .row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #EEF2F7; font-size: 0.85rem; align-items: center; }
.rel-clinico-body .row:last-child { border-bottom: none; }
.rel-clinico-body .row .lbl { color: var(--text-light); flex: 1; }
.rel-clinico-body .row .val { font-weight: 700; color: var(--text); }
.rel-clinico-body .row .status { font-size: 0.72rem; padding: 2px 8px; border-radius: 10px; font-weight: 700; margin-left: 8px; }
.status-norm { background: #E8F5E9; color: #2E7D32; }
.status-atenc { background: #FFF8E1; color: #F57F17; }
.status-criti { background: #FFEBEE; color: #C62828; }
.rel-parecer { background: #F0F7FF; border-left: 4px solid var(--primary); border-radius: 0 12px 12px 0; padding: 14px 16px; margin-top: 12px; font-size: 0.84rem; color: #37474F; line-height: 1.6; }
.rel-parecer strong { color: var(--primary-dark); }
.calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.calendar-nav button { background: none; border: none; font-size: 1.5rem; color: var(--primary); cursor: pointer; padding: 5px; }
.calendar-nav h3 { font-size: 1rem; color: var(--text); text-transform: capitalize; }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
.calendar-day-header { font-size: 0.68rem; color: var(--text-light); text-transform: uppercase; padding-bottom: 8px; }
.calendar-day { padding: 6px 2px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s; background: #F8FAFF; color: var(--text); min-height: 44px; }
.calendar-day.inactive { color: #B0BEC5; cursor: default; background: transparent; }
.calendar-day.today { border: 2px solid var(--primary); background: #EEF2FF; }
.calendar-day.selected { background: var(--primary); color: white; }
.calendar-day:not(.inactive):not(.selected):hover { background: #DBEAFE; }
.calendar-day-metrics { font-size: 0.6rem; line-height: 1.3; margin-top: 2px; }
.calendar-day-metrics span { display: block; }
.m-ok { color: #2E7D32; }
.m-warn { color: #F57F17; }
.m-bad { color: #C62828; }
.calendar-day.selected .calendar-day-metrics span { color: rgba(255,255,255,0.85); }
.daily-sum-card { background: white; border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow); }

/* ========== BACKUP & SINCRONIZA√á√ÉO ========== */
.backup-fab {
  position: fixed; bottom: 90px; right: 16px;
  width: 52px; height: 52px; border-radius: 50%;
  background: linear-gradient(135deg, #1565C0, #29B6F6);
  border: none; color: white; font-size: 1.3rem; cursor: pointer;
  box-shadow: 0 4px 16px rgba(21,101,192,0.4); z-index: 90;
  display: flex; align-items: center; justify-content: center;
  transition: transform 0.2s, box-shadow 0.2s;
}
.backup-fab:hover { transform: scale(1.1); }
.backup-ping {
  position: absolute; top: -3px; right: -3px;
  width: 14px; height: 14px; background: #EF5350;
  border-radius: 50%; border: 2px solid white; display: none;
}
.backup-ping.show { display: block; animation: pulse-ping 1.5s infinite; }
@keyframes pulse-ping { 0%,100%{box-shadow:0 0 0 0 rgba(239,83,80,0.4)} 50%{box-shadow:0 0 0 6px rgba(239,83,80,0)} }
.backup-modal { display: none; position: fixed; top:0;left:0;right:0;bottom:0; background: rgba(0,0,0,0.7); z-index: 200; align-items: flex-end; justify-content: center; }
.backup-modal.show { display: flex; }
.backup-content { background: white; border-radius: 24px 24px 0 0; width: 100%; max-width: 430px; max-height: 92vh; overflow-y: auto; animation: slideUp 0.3s ease; }
.backup-header { background: linear-gradient(135deg, #0D47A1, #1565C0); color: white; padding: 20px 24px 16px; border-radius: 24px 24px 0 0; position: sticky; top: 0; z-index: 1; }
.backup-header h2 { font-size: 1.15rem; font-weight: 800; margin-bottom: 2px; }
.backup-header p { font-size: 0.78rem; opacity: 0.8; }
.backup-close { position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; }
.backup-body { padding: 20px; }
.backup-section { background: #F8FAFF; border-radius: 16px; padding: 18px; margin-bottom: 14px; border: 1px solid #E3EAF2; }
.backup-section-title { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; font-weight: 700; color: #1A237E; margin-bottom: 6px; }
.backup-section-desc { font-size: 0.78rem; color: #546E7A; margin-bottom: 14px; line-height: 1.5; }
.backup-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 14px; }
.backup-stat { background: white; border-radius: 10px; padding: 10px 8px; text-align: center; border: 1px solid #E3EAF2; }
.backup-stat .bv { font-size: 1.1rem; font-weight: 800; color: #1565C0; }
.backup-stat .bl { font-size: 0.62rem; color: #546E7A; margin-top: 2px; }
.backup-btn-row { display: flex; gap: 8px; }
.bkp-btn { flex: 1; padding: 12px 8px; border: none; border-radius: 12px; font-size: 0.82rem; font-weight: 700; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 3px; transition: all 0.2s; }
.bkp-btn .bicon { font-size: 1.3rem; }
.bkp-btn-primary { background: linear-gradient(135deg, #1565C0, #1976D2); color: white; }
.bkp-btn-warn { background: linear-gradient(135deg, #E65100, #F57F17); color: white; }
.bkp-btn-neutral { background: #EEF2FF; color: #1A237E; border: 1px solid #C5CAE9; }
.bkp-btn:active { transform: scale(0.97); }
.backup-last-info { background: #E8F5E9; border-radius: 10px; padding: 10px 14px; font-size: 0.78rem; color: #1B5E20; display: flex; align-items: center; gap: 8px; margin-top: 10px; }
.backup-last-info.warn { background: #FFF8E1; color: #5D4037; }
.backup-last-info.none { background: #F5F5F5; color: #757575; }
.import-drop-area { border: 2px dashed #90CAF9; border-radius: 12px; padding: 24px; text-align: center; background: #F0F7FF; cursor: pointer; transition: all 0.2s; margin-bottom: 10px; }
.import-drop-area:hover, .import-drop-area.dragover { border-color: #1565C0; background: #E3F2FD; }
.import-drop-area .drop-icon { font-size: 2rem; margin-bottom: 8px; }
.import-drop-area p { font-size: 0.82rem; color: #546E7A; }
.import-preview { background: #E8F5E9; border: 1px solid #A5D6A7; border-radius: 12px; padding: 14px; margin-bottom: 10px; display: none; }
.import-preview h4 { font-size: 0.85rem; font-weight: 700; color: #2E7D32; margin-bottom: 8px; }
.import-preview .ip-row { display: flex; justify-content: space-between; font-size: 0.8rem; padding: 3px 0; }
.backup-divider { height: 1px; background: #EEF2F7; margin: 4px 0 14px; }
.backup-progress { height: 4px; background: #E3EAF2; border-radius: 2px; overflow: hidden; margin: 10px 0; display: none; }
.backup-progress.show { display: block; }
.backup-progress-fill { height: 100%; background: linear-gradient(to right, #1565C0, #29B6F6); border-radius: 2px; transition: width 0.3s; }
.auto-backup-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; }
.toggle-switch { width: 46px; height: 26px; background: #CFD8DC; border-radius: 13px; position: relative; cursor: pointer; transition: background 0.2s; flex-shrink: 0; }
.toggle-switch.on { background: #1565C0; }
.toggle-switch::after { content: ''; position: absolute; width: 20px; height: 20px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: left 0.2s; box-shadow: 0 1px 4px rgba(0,0,0,0.2); }
.toggle-switch.on::after { left: 23px; }

/* ========== COMPARTILHAR PROGRESSO ========== */
.compartilhar-modal { display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.85); z-index:300; align-items:flex-end; justify-content:center; }
.compartilhar-modal.show { display:flex; }
.compartilhar-content { background:white; border-radius:24px 24px 0 0; width:100%; max-width:430px; max-height:95vh; overflow-y:auto; animation:slideUp 0.3s ease; }
.compartilhar-header { background:linear-gradient(135deg,#1B5E20,#2E7D32); color:white; padding:20px 24px 16px; border-radius:24px 24px 0 0; position:sticky; top:0; z-index:1; }
.compartilhar-header h2 { font-size:1.15rem; font-weight:800; margin-bottom:2px; }
.compartilhar-header p { font-size:0.78rem; opacity:0.85; }
.comp-close { position:absolute; top:16px; right:16px; background:rgba(255,255,255,0.2); border:none; color:white; width:32px; height:32px; border-radius:50%; cursor:pointer; font-size:1rem; display:flex; align-items:center; justify-content:center; }
.compartilhar-body { padding:20px; }

/* Tabs de formato */
.comp-tabs { display:flex; gap:8px; margin-bottom:20px; }
.comp-tab { flex:1; padding:10px 6px; border:2px solid #E3EAF2; border-radius:12px; background:white; font-size:0.75rem; font-weight:700; cursor:pointer; text-align:center; transition:all 0.2s; color:#546E7A; }
.comp-tab.active { background:#1B5E20; color:white; border-color:#1B5E20; }

/* Cart√£o visual wrapped */
.wrapped-card {
  background:linear-gradient(135deg,#0D1B0A,#1A3A14,#0A2010);
  border-radius:20px; padding:24px; margin-bottom:16px;
  border:1px solid rgba(67,160,71,0.3); position:relative; overflow:hidden;
}
.wrapped-card::before {
  content:''; position:absolute; top:-40px; right:-40px;
  width:160px; height:160px; border-radius:50%;
  background:radial-gradient(circle,rgba(67,160,71,0.2),transparent 70%);
}
.wrapped-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px; }
.wrapped-titulo { font-size:0.72rem; color:#81C784; text-transform:uppercase; letter-spacing:1px; font-weight:700; }
.wrapped-periodo { font-size:0.68rem; color:#4CAF50; text-align:right; }
.wrapped-score { text-align:center; margin-bottom:20px; }
.wrapped-score-num { font-size:3.5rem; font-weight:900; background:linear-gradient(135deg,#69F0AE,#00E676); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; line-height:1; }
.wrapped-score-label { font-size:0.72rem; color:#81C784; margin-top:4px; letter-spacing:1px; text-transform:uppercase; }
.wrapped-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
.wrapped-item { background:rgba(255,255,255,0.06); border-radius:12px; padding:12px; border:1px solid rgba(67,160,71,0.2); }
.wrapped-item .wi-val { font-size:1.3rem; font-weight:800; color:#E8F5E9; }
.wrapped-item .wi-label { font-size:0.65rem; color:#81C784; margin-top:2px; }
.wrapped-item .wi-bar { height:4px; background:rgba(255,255,255,0.1); border-radius:2px; margin-top:6px; overflow:hidden; }
.wrapped-item .wi-bar-fill { height:100%; background:linear-gradient(to right,#43A047,#69F0AE); border-radius:2px; }
.wrapped-destaque { background:rgba(255,215,0,0.08); border:1px solid rgba(255,215,0,0.2); border-radius:12px; padding:12px 14px; margin-bottom:16px; }
.wrapped-destaque .wd-label { font-size:0.68rem; color:#FFD54F; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; }
.wrapped-destaque .wd-val { font-size:0.88rem; color:#FFF9C4; font-weight:700; }
.wrapped-footer { text-align:center; font-size:0.65rem; color:#388E3C; letter-spacing:0.5px; }

/* Texto formatado */
.texto-formatado { background:#F8FAFF; border:2px solid #E3EAF2; border-radius:14px; padding:16px; font-size:0.82rem; color:#37474F; line-height:1.8; font-family:monospace; margin-bottom:16px; white-space:pre-wrap; }

/* Bot√µes de a√ß√£o */
.comp-acoes { display:flex; flex-direction:column; gap:10px; }
.comp-acao-btn { width:100%; padding:14px; border:none; border-radius:12px; font-size:0.9rem; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:all 0.2s; }
.comp-acao-btn:active { transform:scale(0.98); }
.btn-whatsapp { background:linear-gradient(135deg,#128C7E,#25D366); color:white; }
.btn-copiar { background:#EEF2FF; color:#1A237E; border:1px solid #C5CAE9; }
.btn-pdf { background:linear-gradient(135deg,#C62828,#EF5350); color:white; }

.reativar-btn {
  width: 100%; padding: 16px; border: none; border-radius: 16px;
  background: linear-gradient(135deg, #E65100, #FF6D00);
  color: white; font-size: 1rem; font-weight: 800; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 10px;
  margin-bottom: 16px; box-shadow: 0 4px 20px rgba(230,81,0,0.35);
  transition: transform 0.2s, box-shadow 0.2s; position: relative; overflow: hidden;
}
.reativar-btn::before {
  content: ''; position: absolute; top: -50%; left: -50%;
  width: 200%; height: 200%;
  background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 60%);
  animation: pulse-glow 2.5s ease-in-out infinite;
}
@keyframes pulse-glow { 0%,100%{opacity:0.4;transform:scale(0.8)} 50%{opacity:1;transform:scale(1.1)} }
.reativar-btn:active { transform: scale(0.98); }

.reativar-modal { display: none; position: fixed; top:0;left:0;right:0;bottom:0; background: rgba(0,0,0,0.85); z-index: 300; align-items: flex-end; justify-content: center; }
.reativar-modal.show { display: flex; }
.reativar-content { background: #0D0D1A; border-radius: 24px 24px 0 0; width: 100%; max-width: 430px; max-height: 95vh; overflow-y: auto; animation: slideUp 0.3s ease; border-top: 2px solid rgba(255,109,0,0.4); }
.reativar-top { background: linear-gradient(135deg, #1A0A00, #2D1200); padding: 20px 24px 16px; border-radius: 24px 24px 0 0; position: sticky; top: 0; z-index: 1; }
.reativar-top h2 { font-size: 1.2rem; font-weight: 800; color: #FF6D00; margin-bottom: 2px; }
.reativar-top p { font-size: 0.78rem; color: #9CA3AF; }
.reativar-close { position: absolute; top: 16px; right: 16px; background: rgba(255,109,0,0.2); border: 1px solid rgba(255,109,0,0.3); color: #FF6D00; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; }
.reativar-body { padding: 20px; }

/* Sele√ß√£o de n√≠vel */
.nivel-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
.nivel-card { background: rgba(30,30,50,0.8); border: 2px solid #2D2D4E; border-radius: 14px; padding: 16px 10px; text-align: center; cursor: pointer; transition: all 0.2s; }
.nivel-card:hover { border-color: #FF6D00; background: rgba(255,109,0,0.1); }
.nivel-card.selected { border-color: #FF6D00; background: rgba(255,109,0,0.15); }
.nivel-card .nivel-emoji { font-size: 1.8rem; margin-bottom: 6px; display: block; }
.nivel-card .nivel-nome { font-size: 0.72rem; font-weight: 700; color: #E0E0FF; }
.nivel-card .nivel-desc { font-size: 0.62rem; color: #6B7280; margin-top: 3px; line-height: 1.3; }

/* Protocolo passo a passo */
.protocolo-wrap { display: none; }
.protocolo-wrap.show { display: block; }
.passo-card {
  background: rgba(20,20,40,0.9); border: 1px solid #2D2D4E;
  border-radius: 18px; padding: 24px; text-align: center; margin-bottom: 16px;
}
.passo-icon { font-size: 3rem; margin-bottom: 12px; display: block; }
.passo-titulo { font-size: 1.1rem; font-weight: 800; color: #E0E0FF; margin-bottom: 8px; }
.passo-desc { font-size: 0.85rem; color: #9CA3AF; line-height: 1.6; margin-bottom: 20px; }

/* Timer do passo */
.passo-timer-wrap { display: flex; justify-content: center; margin-bottom: 20px; }
.passo-ring { position: relative; width: 120px; height: 120px; }
.passo-ring svg { position: absolute; top:0;left:0;width:120px;height:120px;transform:rotate(-90deg); }
.passo-ring-bg { fill: none; stroke: #1E1E3A; stroke-width: 8; }
.passo-ring-fill { fill: none; stroke: #FF6D00; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 1s linear; }
.passo-center { position: absolute;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center; }
.passo-time { font-size: 1.8rem; font-weight: 800; color: white; letter-spacing: -1px; }
.passo-time-label { font-size: 0.6rem; color: #6B7280; text-transform: uppercase; letter-spacing: 1px; }

/* Anima√ß√£o respira√ß√£o */
.breath-circle {
  width: 100px; height: 100px; border-radius: 50%;
  background: radial-gradient(circle, rgba(255,109,0,0.6), rgba(255,109,0,0.1));
  border: 2px solid rgba(255,109,0,0.5);
  margin: 0 auto 12px; display: flex; align-items: center; justify-content: center;
  font-size: 0.75rem; color: #FF6D00; font-weight: 700; text-align: center;
  transition: transform 0.1s;
}
.breath-circle.inhale { animation: breath-in 4s ease-in-out forwards; }
.breath-circle.hold { animation: none; transform: scale(1.4); }
.breath-circle.exhale { animation: breath-out 8s ease-in-out forwards; }
@keyframes breath-in { from{transform:scale(1)} to{transform:scale(1.4)} }
@keyframes breath-out { from{transform:scale(1.4)} to{transform:scale(1)} }

/* Bot√µes do protocolo */
.passo-btn-row { display: flex; gap: 10px; }
.passo-btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-size: 0.9rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
.passo-btn-next { background: linear-gradient(135deg, #E65100, #FF6D00); color: white; }
.passo-btn-play { background: linear-gradient(135deg, #1B5E20, #43A047); color: white; font-size: 0.95rem; }
.passo-btn-play.tocando { background: linear-gradient(135deg, #6A1B9A, #9C27B0); }
/* Relat√≥rios tab sub-buttons */
.rel-subtabs { display:flex; gap:8px; margin-bottom:20px; }
.rel-subtab { flex:1; padding:12px 8px; border-radius:14px; border:2px solid #E3EAF2; background:white; font-size:0.82rem; font-weight:700; cursor:pointer; text-align:center; transition:all 0.2s; color:#546E7A; }
.rel-subtab.active { color:white; border-color:transparent; }
.rel-subtab.diario.active { background:linear-gradient(135deg,#1565C0,#29B6F6); }
.rel-subtab.mensal.active { background:linear-gradient(135deg,#0D47A1,#1565C0); }
/* Relat√≥rio cl√≠nico mensal melhorado */
.clinico-wrap { background:white; border-radius:16px; overflow:hidden; box-shadow:0 2px 16px rgba(21,101,192,0.12); margin-bottom:14px; }
.clinico-topo { background:linear-gradient(135deg,#0D47A1,#1565C0); color:white; padding:20px; }
.clinico-topo .ct-titulo { font-size:1rem; font-weight:800; margin-bottom:2px; }
.clinico-topo .ct-sub { font-size:0.75rem; opacity:0.85; margin-bottom:12px; }
.clinico-topo .ct-meta { display:flex; gap:10px; }
.ct-meta-item { background:rgba(255,255,255,0.15); border-radius:10px; padding:8px 12px; flex:1; text-align:center; }
.ct-meta-item .ctm-val { font-size:1.1rem; font-weight:800; }
.ct-meta-item .ctm-lbl { font-size:0.62rem; opacity:0.85; margin-top:2px; }
.clinico-secao { padding:16px 20px; border-bottom:1px solid #EEF2F7; }
.clinico-secao:last-child { border-bottom:none; }
.clinico-secao-titulo { font-size:0.72rem; font-weight:800; color:#1565C0; text-transform:uppercase; letter-spacing:0.8px; margin-bottom:10px; display:flex; align-items:center; gap:6px; }
.clinico-linha { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #F5F7FA; font-size:0.85rem; }
.clinico-linha:last-child { border-bottom:none; }
.clinico-linha .cl-lbl { color:#546E7A; flex:1; line-height:1.4; }
.clinico-linha .cl-val { font-weight:700; color:#1A237E; margin-left:8px; }
.clinico-linha .cl-badge { font-size:0.68rem; padding:3px 8px; border-radius:10px; font-weight:700; margin-left:6px; flex-shrink:0; }
.cl-norm { background:#E8F5E9; color:#2E7D32; }
.cl-atenc { background:#FFF8E1; color:#F57F17; }
.cl-crit { background:#FFEBEE; color:#C62828; }
.clinico-parecer { background:#F0F7FF; border-left:4px solid #1565C0; border-radius:0 14px 14px 0; padding:16px 18px; margin:14px 0; font-size:0.84rem; color:#37474F; line-height:1.7; }
.clinico-parecer .cp-titulo { font-size:0.72rem; font-weight:800; color:#1565C0; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px; }
.clinico-grafico { display:flex; gap:4px; align-items:flex-end; height:60px; margin:12px 0; }
.clinico-grafico-bar { flex:1; border-radius:4px 4px 0 0; min-height:4px; transition:height 0.5s; position:relative; }
.clinico-aviso { background:#FFF8E1; border:1px solid #FFE082; border-radius:12px; padding:12px 14px; font-size:0.8rem; color:#5D4037; line-height:1.5; margin-top:10px; }
.passo-btn-skip { background: rgba(30,30,50,0.8); color: #6B7280; border: 1px solid #2D2D4E; font-size: 0.8rem; }
.passo-progresso { display: flex; gap: 6px; justify-content: center; margin-bottom: 20px; }
.passo-dot { width: 8px; height: 8px; border-radius: 50%; background: #2D2D4E; transition: all 0.3s; }
.passo-dot.done { background: #FF6D00; }
.passo-dot.atual { background: #FF6D00; box-shadow: 0 0 8px rgba(255,109,0,0.6); transform: scale(1.3); }

/* Conclus√£o */
.protocolo-fim { text-align: center; padding: 20px 0; display: none; }
.protocolo-fim.show { display: block; }
.protocolo-fim .fim-emoji { font-size: 3.5rem; margin-bottom: 12px; display: block; animation: bounce-in 0.5s ease; }
@keyframes bounce-in { 0%{transform:scale(0)} 60%{transform:scale(1.2)} 100%{transform:scale(1)} }
.protocolo-fim h3 { font-size: 1.2rem; font-weight: 800; color: #E0E0FF; margin-bottom: 8px; }
.protocolo-fim p { font-size: 0.85rem; color: #9CA3AF; margin-bottom: 20px; line-height: 1.6; }
.fim-btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #E65100, #FF6D00); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; }

/* ========== POMODORO EDIT√ÅVEL ========== */
.pom-config-card { background: rgba(30,30,58,0.6); border: 1px solid #2D2D4E; border-radius: 14px; padding: 16px; margin-bottom: 16px; }
.pom-config-title { font-size: 0.78rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
.pom-config-row { display: flex; gap: 10px; align-items: center; }
.pom-config-item { flex: 1; text-align: center; }
.pom-config-item label { font-size: 0.7rem; color: #9CA3AF; display: block; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
.pom-config-item input { background: rgba(20,20,40,0.8); border: 1px solid #3D3D6E; color: #E0E0FF; border-radius: 10px; padding: 10px; font-size: 1rem; font-weight: 700; text-align: center; width: 100%; }
.pom-config-sep { color: #4B5563; font-size: 1.2rem; font-weight: 700; margin-top: 16px; }
.pom-config-btn { padding: 10px 16px; background: rgba(124,58,237,0.3); color: #A78BFA; border: 1px solid #7C3AED; border-radius: 10px; font-size: 0.82rem; font-weight: 700; cursor: pointer; white-space: nowrap; margin-top: 14px; }
</style>
</head>
<body>
<div class="header">
  <div><h1>üß† TDAH Care</h1><span id="header-date"></span></div>
  <div style="font-size:2rem;">üë§</div>
</div>

<!-- HOME -->
<div class="page active" id="page-home">
  <div class="greeting"><h2 id="greeting-text">Ol√°! üëã</h2><p>Acompanhe seu dia com TDAH</p></div>
  <div class="stats-row">
    <div class="stat-card"><div class="stat-icon">üò¥</div><div class="stat-value" id="stat-sono">‚Äî</div><div class="stat-label">Sono</div></div>
    <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-value" id="stat-metas">0/0</div><div class="stat-label">Metas</div></div>
    <div class="stat-card"><div class="stat-icon">üíä</div><div class="stat-value" id="stat-remedio">‚Äî</div><div class="stat-label">Rem√©dio</div></div>
  </div>
  <div class="remedio-card">
    <div class="remedio-header">
      <div><div class="remedio-title">üíä Venvanse (Lisdexanfetamina)</div><div style="font-size:0.75rem;color:var(--text-light);">Dura√ß√£o: 12 horas</div></div>
      <span class="remedio-badge badge-inativo" id="remedio-badge">N√£o registrado</span>
    </div>
    <div id="remedio-sem-registro">
      <p style="font-size:0.82rem;color:var(--text-light);margin-bottom:10px;">Registre o hor√°rio que tomou o rem√©dio:</p>
      <div class="time-input-wrap"><input type="time" id="hora-remedio"><button onclick="registrarRemedio()">üíä Tomei</button></div>
    </div>
    <div id="remedio-com-registro" style="display:none;">
      <div style="display:flex;justify-content:space-between;font-size:0.8rem;margin-bottom:8px;">
        <span style="color:var(--text-light);">Tomado √†s <strong id="hora-tomada-display">‚Äî</strong></span>
        <span style="color:var(--text-light);">Encerra √†s <strong id="hora-encerra-display">‚Äî</strong></span>
      </div>
      <div class="remedio-progress-bar"><div class="remedio-progress-fill" id="remedio-fill" style="width:0%"></div></div>
      <div class="remedio-info-row"><span id="tempo-ativo-label">0h no organismo</span><span id="tempo-restante-label">12h restantes</span></div>
      <div class="remedio-stats">
        <div class="remedio-stat"><div class="val" id="tempo-ativo-val">0h 00min</div><div class="lbl">Tempo ativo</div></div>
        <div class="remedio-stat"><div class="val" id="tempo-restante-val">12h 00min</div><div class="lbl">Tempo restante</div></div>
      </div>
      <div class="remedio-fase-box" id="remedio-fase-box">
        <div class="remedio-fase-titulo" id="remedio-fase-titulo">üìä Fase atual</div>
        <div class="remedio-fase-desc" id="remedio-fase-desc">Calculando...</div>
      </div>
      <div class="aviso-encerrado" id="aviso-encerrado">
        <h4>‚ö†Ô∏è Efeito do rem√©dio encerrado</h4>
        <p>O Venvanse completou suas 12h de a√ß√£o. √â normal sentir cansa√ßo, irritabilidade leve e retorno da fome.<br><br>üí° <strong>Dica:</strong> Evite tarefas de alto foco agora. Descanse e alimente-se bem.</p>
      </div>
      <button class="btn-danger" onclick="resetarRemedio()">üîÑ Registrar nova dose</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title">üìä Progresso de hoje</div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    <div class="progress-info"><span id="progress-text">0 de 0 metas conclu√≠das</span><span id="progress-pct">0%</span></div>
  </div>

  <!-- LEMBRETE SEXTA -->
  <div id="lembrete-sexta" style="display:none;background:linear-gradient(135deg,#1B5E20,#2E7D32);border-radius:16px;padding:16px;margin-bottom:16px;color:white;">
    <div style="font-size:0.9rem;font-weight:800;margin-bottom:4px;">üìÖ √â sexta-feira!</div>
    <div style="font-size:0.78rem;opacity:0.9;margin-bottom:12px;">Hora de enviar seu progresso semanal para sua psic√≥loga üß†</div>
    <button onclick="abrirCompartilhar()" style="width:100%;padding:10px;background:white;color:#1B5E20;border:none;border-radius:10px;font-size:0.85rem;font-weight:800;cursor:pointer;">üì§ Gerar e Compartilhar Progresso</button>
  </div>

  <button class="reativar-btn" onclick="abrirReativar()">‚ö° Reativar Foco</button>

  <div class="card">
    <div class="card-title">üì± Tempo de tela hoje</div>
    <div id="celular-home-display">
      <p style="color:var(--text-light);font-size:0.82rem;margin-bottom:8px;">Quanto tempo voc√™ usou o celular hoje?</p>
      <div class="celular-home-row">
        <input type="number" id="celular-horas" placeholder="0" min="0" max="24">
        <span style="color:var(--text-light);font-size:0.85rem;">h</span>
        <input type="number" id="celular-minutos" placeholder="0" min="0" max="59">
        <span style="color:var(--text-light);font-size:0.85rem;">min</span>
        <button onclick="salvarCelular()">üíæ Salvar</button>
      </div>
    </div>
    <div id="celular-registrado-home" style="display:none;"></div>
  </div>
  <div class="card">
    <div class="card-title">üìÖ √öltimo sono registrado</div>
    <div id="ultimo-sono-home"><p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:8px;">Nenhum registro ainda</p></div>
  </div>
  <button class="relatorio-btn" onclick="abrirCompartilhar()" style="background:linear-gradient(135deg,#1B5E20,#43A047);">üì§ Enviar Progresso para Psic√≥loga</button>
</div>

<!-- SONO -->
<div class="page" id="page-sono">
  <div class="section-title">üò¥ Registrar Sono</div>
  <div class="card">
    <div class="sono-visual">
      <div class="sono-circle"><span class="horas" id="sono-display">‚Äî</span><span class="label">de sono</span></div>
      <div class="sono-info">
        <p>Recomendado: <strong>7-9 horas</strong></p>
        <p style="font-size:0.8rem;color:var(--text-light);margin-top:6px;">Sono regular melhora foco e resposta ao medicamento.</p>
      </div>
    </div>
    <div class="form-group">
      <label>‚è∞ Quantas horas dormiu?</label>
      <div class="hours-grid" id="hours-grid"></div>
      <div class="custom-hours"><input type="number" id="horas-custom" placeholder="Outro valor..." min="0" max="24" step="0.5" oninput="selecionarHoraCustom(this.value)"><span>horas</span></div>
    </div>
    <div class="form-group">
      <label>üò¥ Qualidade do sono</label>
      <select id="sono-qualidade">
        <option value="otima">üòä √ìtima ‚Äî Acordei muito descansado</option>
        <option value="boa" selected>üôÇ Boa ‚Äî Acordei bem</option>
        <option value="regular">üòê Regular ‚Äî Cansado mas ok</option>
        <option value="ruim">üòî Ruim ‚Äî Muito cansado</option>
        <option value="pessima">üò´ P√©ssima ‚Äî Mal consegui dormir</option>
      </select>
    </div>
    <div class="form-group"><label>üìù Observa√ß√µes (opcional)</label><textarea id="sono-obs" placeholder="Ex: Acordei v√°rias vezes..."></textarea></div>
    <button class="btn btn-primary" onclick="salvarSono()">üíæ Salvar Registro</button>
  </div>
  <div class="card"><div class="card-title">üìÖ √öltimos registros</div><div id="historico-sono"><p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">Nenhum registro ainda</p></div></div>
</div>

<!-- METAS -->
<div class="page" id="page-metas">
  <div class="section-title">üéØ Minhas Metas</div>
  <div class="card">
    <div class="card-title">‚ûï Nova meta</div>
    <div class="add-meta-row">
      <input type="text" id="nova-meta-input" placeholder="Ex: Estudar 1h, Meditar...">
      <select id="nova-meta-tipo">
        <option value="diaria">üìÖ Di√°ria</option>
        <option value="fixa">üìå Fixa</option>
      </select>
      <button onclick="adicionarMeta()">+</button>
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
      <label style="font-size:0.78rem;margin-bottom:0;font-weight:500;color:var(--text-light);white-space:nowrap;">Prioridade:</label>
      <select id="nova-meta-prio" style="padding:6px 10px;font-size:0.78rem;border-radius:8px;border:2px solid #E3EAF2;background:#F8FAFF;flex:1;">
        <option value="alta">üî¥ Alta</option>
        <option value="media" selected>üü° M√©dia</option>
        <option value="baixa">üü¢ Baixa</option>
      </select>
    </div>
    <p style="font-size:0.75rem;color:var(--text-light);">üìå Fixas se repetem todo dia. üìÖ Di√°rias somem √† meia-noite. Ordenadas por prioridade.</p>
  </div>
  <div class="card">
    <div class="card-title">üìã Metas de hoje</div>
    <div class="progress-bar" style="margin-bottom:8px;"><div class="progress-fill" id="meta-progress" style="width:0%"></div></div>
    <div class="progress-info" style="margin-bottom:16px;"><span id="meta-info">0 conclu√≠das</span><span id="meta-pct">0%</span></div>
    <div id="lista-metas"></div>
    <div class="divider"></div>
    <button class="btn btn-outline" onclick="limparConcluidas()" style="margin-top:8px;">üóëÔ∏è Limpar di√°rias conclu√≠das</button>
  </div>
  <div class="card">
    <div class="card-title">üìö P√°ginas lidas hoje</div>
    <div id="leitura-form">
      <p style="font-size:0.82rem;color:var(--text-light);margin-bottom:10px;">Quantas p√°ginas voc√™ leu hoje?</p>
      <div class="leitura-row">
        <input type="number" id="paginas-input" placeholder="Ex: 30" min="0">
        <button onclick="salvarLeitura()">üíæ Salvar</button>
      </div>
    </div>
    <div id="leitura-registrada" style="display:none;"></div>
  </div>
  <div class="card">
    <div class="card-title">üìÖ Hist√≥rico de metas</div>
    <div id="historico-metas-lista"><p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">O hist√≥rico aparecer√° aqui a partir de amanh√£.</p></div>
  </div>
  <div class="card"><div class="card-title">üí° Dica</div>
    <div style="background:#FFF8E1;border-left:4px solid #FFB300;border-radius:0 12px 12px 0;padding:12px 16px;font-size:0.83rem;color:#5D4037;line-height:1.5;"><strong>TDAH e metas:</strong> Divida tarefas grandes em passos pequenos. Cada ‚úÖ libera dopamina!</div>
  </div>
</div>

<!-- CALEND√ÅRIO -->
<div class="page" id="page-calendario">
  <div class="section-title">üóìÔ∏è Hist√≥rico Di√°rio</div>
  <div class="card">
    <div class="calendar-nav">
      <button onclick="changeMonth(-1)">‚óÄ</button>
      <h3 id="current-month-year"></h3>
      <button onclick="changeMonth(1)">‚ñ∂</button>
    </div>
    <div class="calendar-grid">
      <div class="calendar-day-header">Dom</div><div class="calendar-day-header">Seg</div>
      <div class="calendar-day-header">Ter</div><div class="calendar-day-header">Qua</div>
      <div class="calendar-day-header">Qui</div><div class="calendar-day-header">Sex</div>
      <div class="calendar-day-header">S√°b</div>
    </div>
    <div class="calendar-grid" id="calendar-grid-days"></div>
  </div>
  <div id="daily-summary-card" style="display:none;"></div>
</div>

<!-- CAVERNA -->
<div class="page" id="page-caverna">
  <div class="caverna-header"><h2>üèîÔ∏è Modo Caverna</h2><p id="caverna-subtitle">Pomodoro 20min foco / 5min pausa</p></div>
  <div style="text-align:center;"><span class="caverna-status-badge status-idle" id="caverna-status-badge">‚è∏ Aguardando in√≠cio</span></div>

  <!-- Config edit√°vel do Pomodoro -->
  <div class="pom-config-card">
    <div class="pom-config-title">‚öôÔ∏è Configurar tempo</div>
    <div class="pom-config-row">
      <div class="pom-config-item">
        <label>üéØ Foco (min)</label>
        <input type="number" id="pom-foco-input" value="20" min="1" max="90" onchange="aplicarConfigPom()">
      </div>
      <div class="pom-config-sep">/</div>
      <div class="pom-config-item">
        <label>‚òï Pausa (min)</label>
        <input type="number" id="pom-pausa-input" value="5" min="1" max="30" onchange="aplicarConfigPom()">
      </div>
      <button class="pom-config-btn" onclick="aplicarConfigPom()">‚úì Aplicar</button>
    </div>
  </div>
  <div class="caverna-timer-wrap">
    <div class="caverna-ring">
      <svg viewBox="0 0 220 220"><circle class="caverna-ring-bg" cx="110" cy="110" r="96"/><circle class="caverna-ring-fill" id="caverna-ring-fill" cx="110" cy="110" r="96" stroke="#A78BFA" stroke-dasharray="603.19" stroke-dashoffset="0"/></svg>
      <div class="caverna-center"><div class="caverna-time" id="caverna-time-display">20:00</div><div class="caverna-phase" id="caverna-phase-label">FOCO</div></div>
    </div>
  </div>
  <div class="caverna-controls">
    <button class="caverna-btn caverna-btn-reset" onclick="resetarPomodoro()" title="Reiniciar">üîÑ</button>
    <button class="caverna-btn caverna-btn-main" id="caverna-play-btn" onclick="togglePomodoro()">‚ñ∂</button>
    <button class="caverna-btn caverna-btn-skip" onclick="pularFase()" title="Pular fase">‚è≠</button>
  </div>
  <div class="caverna-stats-grid">
    <div class="caverna-stat-box"><span class="v" id="cav-sessoes">0</span><span class="l">Sess√µes</span></div>
    <div class="caverna-stat-box"><span class="v" id="cav-foco-total">0min</span><span class="l">Foco hoje</span></div>
    <div class="caverna-stat-box"><span class="v" id="cav-ciclos">0</span><span class="l">Ciclos</span></div>
  </div>
  <div class="caverna-card-dark">
    <div class="caverna-card-title">üîµ Sess√µes do ciclo atual (4 = 1 ciclo)</div>
    <div class="session-dot-row" id="session-dots"></div>
    <div class="ciclos-manual-row" style="margin-top:14px;padding-top:12px;border-top:1px solid #2D2D4E;">
      <span style="color:#9CA3AF;font-size:0.78rem;flex:1;">Celular desligou? Ajuste as sess√µes:</span>
      <button onclick="removerSessaoManual()" title="Remover 1 sess√£o" style="background:rgba(239,68,68,0.15);color:#F87171;border:1px solid rgba(239,68,68,0.3);border-radius:10px;padding:8px 14px;font-size:1rem;font-weight:700;cursor:pointer;">‚èÆ</button>
      <button onclick="adicionarSessaoManual()" title="Adicionar 1 sess√£o" style="background:rgba(124,58,237,0.25);color:#A78BFA;border:1px solid #7C3AED;border-radius:10px;padding:8px 14px;font-size:1rem;font-weight:700;cursor:pointer;">‚è≠</button>
    </div>
    <p style="font-size:0.68rem;color:#4B5563;margin-top:8px;">‚è≠ adiciona 1 sess√£o de 20min ¬∑ ‚èÆ remove 1 sess√£o</p>
  </div>
  <div class="caverna-card-dark">
    <div class="caverna-card-title">üì± Tempo de celular hoje</div>
    <div id="cav-celular-form">
      <div class="cav-input-row">
        <input type="number" id="cav-cel-h" placeholder="Horas" min="0" max="24">
        <span style="color:#6B7280;font-size:0.85rem;">h</span>
        <input type="number" id="cav-cel-m" placeholder="Min" min="0" max="59">
        <span style="color:#6B7280;font-size:0.85rem;">min</span>
        <button onclick="salvarCelularCaverna()">üíæ</button>
      </div>
    </div>
    <div id="cav-celular-registrado" style="display:none;"></div>
  </div>
</div>

<!-- INFO -->
<div class="page" id="page-info">
  <div class="section-title">üìö Informa√ß√µes</div>
  <div class="info-tabs">
    <button class="info-tab active" onclick="switchInfo('sono',this)">üò¥ Sono</button>
    <button class="info-tab" onclick="switchInfo('eletrolitos',this)">üíß Eletr√≥litos</button>
    <button class="info-tab" onclick="switchInfo('remedio',this)">üíä Medica√ß√£o</button>
    <button class="info-tab" onclick="switchInfo('estrategias',this)">üß† Estrat√©gias</button>
    <button class="info-tab" onclick="switchInfo('relatorios',this)">üìä Relat√≥rios</button>
  </div>
  <div class="info-content active" id="info-sono">
    <div class="info-card"><h3>üåô Por que o sono √© crucial no TDAH?</h3><p>Priva√ß√£o de sono agrava desaten√ß√£o, impulsividade e regula√ß√£o emocional ‚Äî j√° comprometidas no TDAH.</p></div>
    <div class="info-tip"><strong>‚úÖ Recomenda√ß√£o:</strong> 7-9 horas com hor√°rios consistentes, mesmo nos fins de semana.</div>
    <div class="info-card"><h3>üì± Higiene do sono</h3><p>Evite telas 1 hora antes de dormir. A luz azul inibe a melatonina. Crie rotina: banho morno, leitura leve, ambiente fresco.</p></div>
    <div class="info-tip"><strong>‚ö†Ô∏è Aten√ß√£o:</strong> Estimulantes tomados tarde dificultam o sono. Converse com seu m√©dico.</div>
  </div>
  <div class="info-content" id="info-eletrolitos">
    <div class="info-card"><h3>üíß Hidrata√ß√£o e TDAH</h3><p>Desidrata√ß√£o leve (1-2%) j√° impacta concentra√ß√£o e mem√≥ria ‚Äî fun√ß√µes comprometidas no TDAH.</p></div>
    <div class="info-tip"><strong>‚úÖ Meta:</strong> 2-3 litros de √°gua por dia.</div>
    <div class="info-card"><h3>üßÇ Eletr√≥litos importantes</h3><p><strong>Magn√©sio:</strong> Reduz hiperatividade, melhora sono.<br><br><strong>Zinco:</strong> Relacionado √† s√≠ntese de dopamina.<br><br><strong>Ferro:</strong> Defici√™ncia agrava TDAH. Avalie com seu m√©dico.</p></div>
    <div class="info-tip"><strong>‚ö†Ô∏è Importante:</strong> N√£o inicie suplementa√ß√£o sem orienta√ß√£o m√©dica.</div>
  </div>
  <div class="info-content" id="info-remedio">
    <div class="info-card"><h3>üíä Venvanse ‚Äî Como funciona</h3><p>Pr√≥-f√°rmaco ativado no organismo. In√≠cio em 1-2h, pico entre 3-5h, dura√ß√£o total de at√© 12h.</p></div>
    <div class="info-tip"><strong>‚úÖ Hor√°rio ideal:</strong> Tome ao acordar. Consist√™ncia maximiza o efeito terap√™utico.</div>
    <div class="info-card"><h3>üçΩÔ∏è Alimenta√ß√£o e medica√ß√£o</h3><p>Estimulantes reduzem apetite. Tome caf√© da manh√£ nutritivo ANTES da dose.</p></div>
    <div class="info-tip"><strong>‚ö†Ô∏è Nunca</strong> ajuste doses sem consultar seu m√©dico.</div>
    <div class="info-card"><h3>üåô Rebote ao fim do efeito</h3><p>Retorno dos sintomas, irritabilidade leve e fome s√£o normais. Planeje atividades de menor demanda cognitiva para esse per√≠odo.</p></div>
  </div>
  <div class="info-content" id="info-estrategias">
    <div class="info-card"><h3>‚è±Ô∏è Modo Caverna ‚Äî Pomodoro 20/5</h3><p>20min de foco + 5min de pausa. Para TDAH, sess√µes mais curtas s√£o mais eficazes. Ap√≥s 4 sess√µes (1 ciclo), fa√ßa uma pausa maior de 15-20min.</p></div>
    <div class="info-card"><h3>üìù Body doubling</h3><p>Estudar na presen√ßa de outra pessoa (mesmo virtual) aumenta foco no TDAH.</p></div>
    <div class="info-tip"><strong>‚úÖ Organiza√ß√£o:</strong> Listas curtas de 3-5 itens. Muitas tarefas vis√≠veis sobrecarregam.</div>
    <div class="info-card"><h3>üéµ M√∫sica e foco</h3><p>Lo-fi, instrumentais ou ru√≠do branco melhoram concentra√ß√£o. Evite letras em tarefas de leitura.</p></div>
  </div>
  <div class="info-content" id="info-relatorios">
    <div class="rel-subtabs">
      <button class="rel-subtab diario active" id="subtab-diario" onclick="switchRelSubtab('diario')">üìã Relat√≥rio do Dia</button>
      <button class="rel-subtab mensal" id="subtab-mensal" onclick="switchRelSubtab('mensal')">üìà Relat√≥rio Mensal</button>
    </div>
    <div id="relatorio-diario-inline">
      <div style="text-align:center;padding:20px 0 10px;">
        <div style="font-size:2rem;margin-bottom:8px;">üìã</div>
        <div style="font-size:0.85rem;color:#546E7A;margin-bottom:16px;">An√°lise completa do seu dia atual</div>
        <button onclick="gerarRelatorioDiarioInline()" style="background:linear-gradient(135deg,#1565C0,#29B6F6);color:white;border:none;border-radius:12px;padding:14px 24px;font-size:0.9rem;font-weight:700;cursor:pointer;width:100%;">üìä Gerar Relat√≥rio de Hoje</button>
      </div>
      <div id="relatorio-diario-conteudo"></div>
    </div>
    <div id="relatorio-mensal-inline" style="display:none;">
      <div id="relatorio-mensal-wrap"></div>
    </div>
  </div>
</div>

<!-- RELAT√ìRIO MODAL -->
<div class="relatorio-modal" id="relatorio-modal" onclick="fecharRelatorio(event)">
  <div class="relatorio-content">
    <div class="relatorio-title">üìä Relat√≥rio do Dia</div>
    <div class="relatorio-date" id="relatorio-date"></div>
    <div id="relatorio-body"></div>
    <button class="rel-close-btn" onclick="document.getElementById('relatorio-modal').classList.remove('show')">‚úï Fechar</button>
  </div>
</div>

<!-- ===== COMPARTILHAR PROGRESSO MODAL ===== -->
<div class="compartilhar-modal" id="compartilhar-modal" onclick="fecharCompartilharModal(event)">
  <div class="compartilhar-content">
    <div class="compartilhar-header" style="position:relative;">
      <h2>üì§ Progresso Semanal</h2>
      <p>Compartilhe sua evolu√ß√£o com sua psic√≥loga</p>
      <button class="comp-close" onclick="document.getElementById('compartilhar-modal').classList.remove('show')">‚úï</button>
    </div>
    <div class="compartilhar-body">

      <div class="comp-tabs">
        <button class="comp-tab active" onclick="switchCompTab('visual',this)">üé® Visual</button>
        <button class="comp-tab" onclick="switchCompTab('texto',this)">üí¨ Texto</button>
        <button class="comp-tab" onclick="switchCompTab('pdf',this)">üìÑ PDF</button>
      </div>

      <!-- ABA VISUAL -->
      <div id="comp-visual" class="comp-tab-content">
        <div class="wrapped-card" id="wrapped-card">
          <div class="wrapped-header">
            <div>
              <div class="wrapped-titulo">üìä Progresso Semanal</div>
              <div style="font-size:1rem;font-weight:800;color:#E8F5E9;margin-top:2px;" id="wc-nome">TDAH Care</div>
            </div>
            <div class="wrapped-periodo" id="wc-periodo"></div>
          </div>
          <div class="wrapped-score">
            <div class="wrapped-score-num" id="wc-score">‚Äî</div>
            <div class="wrapped-score-label">score da semana</div>
          </div>
          <div class="wrapped-grid">
            <div class="wrapped-item">
              <div class="wi-val" id="wc-sono">‚Äî</div>
              <div class="wi-label">üò¥ M√©dia de sono</div>
              <div class="wi-bar"><div class="wi-bar-fill" id="wc-sono-bar" style="width:0%"></div></div>
            </div>
            <div class="wrapped-item">
              <div class="wi-val" id="wc-metas">‚Äî</div>
              <div class="wi-label">‚úÖ Metas conclu√≠das</div>
              <div class="wi-bar"><div class="wi-bar-fill" id="wc-metas-bar" style="width:0%"></div></div>
            </div>
            <div class="wrapped-item">
              <div class="wi-val" id="wc-foco">‚Äî</div>
              <div class="wi-label">üèîÔ∏è Tempo de foco</div>
              <div class="wi-bar"><div class="wi-bar-fill" id="wc-foco-bar" style="width:0%"></div></div>
            </div>
            <div class="wrapped-item">
              <div class="wi-val" id="wc-tela">‚Äî</div>
              <div class="wi-label">üì± M√©dia de tela</div>
              <div class="wi-bar"><div class="wi-bar-fill" id="wc-tela-bar" style="width:0%"></div></div>
            </div>
          </div>
          <div class="wrapped-destaque" id="wc-destaque-wrap">
            <div class="wd-label">‚≠ê Destaque da semana</div>
            <div class="wd-val" id="wc-destaque">‚Äî</div>
          </div>
          <div class="wrapped-footer">gerado pelo TDAH Care ‚Ä¢ semana de acompanhamento</div>
        </div>
        <div class="comp-acoes">
          <button class="comp-acao-btn btn-whatsapp" onclick="compartilharWhatsApp()">üì± Enviar pelo WhatsApp</button>
          <button class="comp-acao-btn btn-copiar" onclick="tirarPrintCard()">üì∏ Salvar como imagem</button>
        </div>
      </div>

      <!-- ABA TEXTO -->
      <div id="comp-texto" class="comp-tab-content" style="display:none;">
        <div class="texto-formatado" id="texto-progresso"></div>
        <div class="comp-acoes">
          <button class="comp-acao-btn btn-whatsapp" onclick="enviarTextoWhatsApp()">üì± Abrir no WhatsApp</button>
          <button class="comp-acao-btn btn-copiar" onclick="copiarTexto()">üìã Copiar texto</button>
        </div>
      </div>

      <!-- ABA PDF -->
      <div id="comp-pdf" class="comp-tab-content" style="display:none;">
        <div style="background:#F8FAFF;border-radius:14px;padding:20px;margin-bottom:16px;text-align:center;">
          <div style="font-size:2.5rem;margin-bottom:12px;">üìÑ</div>
          <div style="font-weight:700;color:#1A237E;margin-bottom:8px;">Relat√≥rio Cl√≠nico Semanal</div>
          <div style="font-size:0.82rem;color:#546E7A;line-height:1.6;margin-bottom:16px;">Gera um PDF formatado profissionalmente com todos os dados da semana ‚Äî pronto para apresentar na consulta.</div>
          <div id="pdf-preview-info" style="background:#EEF2FF;border-radius:10px;padding:12px;font-size:0.8rem;color:#1A237E;text-align:left;margin-bottom:16px;"></div>
        </div>
        <div class="comp-acoes">
          <button class="comp-acao-btn btn-pdf" onclick="gerarPDFSemanal()">üìÑ Gerar e Baixar PDF</button>
          <button class="comp-acao-btn btn-copiar" onclick="imprimirRelatorio()">üñ®Ô∏è Imprimir / Salvar PDF</button>
        </div>
      </div>

    </div>
  </div>
</div>
<!-- ===== FIM COMPARTILHAR ===== -->

<!-- ===== REATIVAR FOCO MODAL ===== -->
<div class="reativar-modal" id="reativar-modal" onclick="fecharReativarModal(event)">
  <div class="reativar-content">
    <div class="reativar-top" style="position:relative;">
      <h2>‚ö° Reativar Foco</h2>
      <p>Selecione como voc√™ est√° agora</p>
      <button class="reativar-close" onclick="document.getElementById('reativar-modal').classList.remove('show')">‚úï</button>
    </div>
    <div class="reativar-body">

      <!-- Sele√ß√£o de n√≠vel -->
      <div id="reativar-nivel-select">
        <div class="nivel-grid">
          <div class="nivel-card" onclick="selecionarNivel(1,this)">
            <span class="nivel-emoji">üòê</span>
            <div class="nivel-nome">Travado</div>
            <div class="nivel-desc">Dif√≠cil focar mas consigo</div>
          </div>
          <div class="nivel-card" onclick="selecionarNivel(2,this)">
            <span class="nivel-emoji">üò∂‚Äçüå´Ô∏è</span>
            <div class="nivel-nome">Cabe√ßa Pesada</div>
            <div class="nivel-desc">Tentei e n√£o consigo</div>
          </div>
          <div class="nivel-card" onclick="selecionarNivel(3,this)">
            <span class="nivel-emoji">üß±</span>
            <div class="nivel-nome">Tela em Branco</div>
            <div class="nivel-desc">Nem sei por onde come√ßar</div>
          </div>
        </div>
      </div>

      <!-- Protocolo -->
      <div class="protocolo-wrap" id="protocolo-wrap">
        <div class="passo-progresso" id="passo-progresso"></div>
        <div class="passo-card" id="passo-card">
          <span class="passo-icon" id="passo-icon">üíß</span>
          <div class="passo-titulo" id="passo-titulo">Beba √°gua agora</div>
          <div class="passo-desc" id="passo-desc">Desidrata√ß√£o piora a concentra√ß√£o. Levante, pegue um copo d'√°gua e beba agora.</div>
          <div class="passo-timer-wrap" id="passo-timer-wrap">
            <div class="passo-ring">
              <svg viewBox="0 0 120 120">
                <circle class="passo-ring-bg" cx="60" cy="60" r="52"/>
                <circle class="passo-ring-fill" id="passo-ring-fill" cx="60" cy="60" r="52" stroke-dasharray="326.73" stroke-dashoffset="0"/>
              </svg>
              <div class="passo-center">
                <div class="passo-time" id="passo-time-display">‚Äî</div>
                <div class="passo-time-label" id="passo-time-label">segundos</div>
              </div>
            </div>
          </div>
          <div id="breath-container" style="display:none;">
            <div class="breath-circle" id="breath-circle">Prepare-se</div>
            <div style="font-size:0.78rem;color:#6B7280;text-align:center;margin-bottom:16px;" id="breath-instruction">Respire fundo</div>
          </div>
          <div id="sentidos-container" style="display:none;">
            <div style="background:rgba(255,109,0,0.1);border:1px solid rgba(255,109,0,0.3);border-radius:12px;padding:14px;margin-bottom:16px;">
              <div style="font-size:0.78rem;color:#FF6D00;font-weight:700;margin-bottom:8px;" id="sentido-atual-label">üëÄ Nome 5 coisas que voc√™ V√ä</div>
              <div style="font-size:0.72rem;color:#9CA3AF;line-height:1.6;" id="sentido-exemplos"></div>
            </div>
          </div>
        </div>
        <div class="passo-btn-row">
          <button class="passo-btn passo-btn-skip" onclick="pularPasso()">Pular</button>
          <button class="passo-btn passo-btn-play" id="passo-play-btn" onclick="toggleTimerPasso()" style="display:none;">‚ñ∂ Iniciar</button>
          <button class="passo-btn passo-btn-next" id="passo-next-btn" onclick="proximoPasso()">Feito ‚úì</button>
        </div>
      </div>

      <!-- Conclus√£o -->
      <div class="protocolo-fim" id="protocolo-fim">
        <span class="fim-emoji">üß†‚ú®</span>
        <h3>Protocolo conclu√≠do!</h3>
        <p>Voc√™ fez o necess√°rio para reativar seu sistema. Agora comece com uma tarefa pequena ‚Äî apenas 10 minutos de foco.</p>
        <button class="fim-btn" onclick="finalizarProtocolo()">üèîÔ∏è Iniciar Modo Caverna</button>
      </div>

    </div>
  </div>
</div>
<!-- ===== FIM REATIVAR FOCO ===== -->

<!-- ===== BACKUP FAB & MODAL ===== -->
<button class="backup-fab" id="backup-fab-btn" onclick="abrirBackup()" title="Backup & Sincroniza√ß√£o" style="position:relative;">
  üíæ
  <div class="backup-ping" id="backup-ping"></div>
</button>

<div class="backup-modal" id="backup-modal" onclick="fecharBackupModal(event)">
  <div class="backup-content">
    <div class="backup-header" style="position:relative;">
      <h2>üíæ Backup & Sincroniza√ß√£o</h2>
      <p>Seus dados salvos localmente neste dispositivo</p>
      <button class="backup-close" onclick="document.getElementById('backup-modal').classList.remove('show')">‚úï</button>
    </div>
    <div class="backup-body">
      <div class="backup-section">
        <div class="backup-section-title">üìä Seus dados</div>
        <div class="backup-stats">
          <div class="backup-stat"><div class="bv" id="bk-dias">0</div><div class="bl">Dias</div></div>
          <div class="backup-stat"><div class="bv" id="bk-metas">0</div><div class="bl">Metas</div></div>
          <div class="backup-stat"><div class="bv" id="bk-size">0kb</div><div class="bl">Tamanho</div></div>
        </div>
        <div id="backup-last-export" class="backup-last-info none">üìÅ Nenhum backup exportado ainda</div>
      </div>

      <div class="backup-section">
        <div class="backup-section-title">üì§ Exportar backup</div>
        <div class="backup-section-desc">Baixe um arquivo JSON com todos os seus dados. Guarde no Google Drive, iCloud ou envie por e-mail para voc√™ mesmo.</div>
        <div class="backup-btn-row">
          <button class="bkp-btn bkp-btn-primary" onclick="exportarJSON()">
            <span class="bicon">‚¨áÔ∏è</span><span>Baixar .json</span>
          </button>
          <button class="bkp-btn bkp-btn-neutral" onclick="copiarBackupClipboard()">
            <span class="bicon">üìã</span><span>Copiar texto</span>
          </button>
          <button class="bkp-btn bkp-btn-neutral" onclick="compartilharBackup()">
            <span class="bicon">üì§</span><span>Compartilhar</span>
          </button>
        </div>
        <div class="backup-progress" id="export-progress">
          <div class="backup-progress-fill" id="export-progress-fill" style="width:0%"></div>
        </div>
      </div>

      <div class="backup-section">
        <div class="backup-section-title">üì• Importar / Restaurar</div>
        <div class="backup-section-desc">Restaure seus dados a partir de um arquivo JSON exportado. <strong style="color:#C62828;">Aten√ß√£o: substituir√° os dados atuais.</strong></div>
        <div class="import-drop-area" id="import-drop" onclick="document.getElementById('import-file-input').click()"
             ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
          <div class="drop-icon">üìÇ</div>
          <p><strong>Toque para selecionar</strong> ou arraste o arquivo aqui</p>
          <p style="margin-top:4px;font-size:0.72rem;">Apenas arquivos .json do TDAH Care</p>
        </div>
        <input type="file" id="import-file-input" accept=".json" style="display:none" onchange="handleFileSelect(event)">
        <div class="import-preview" id="import-preview">
          <h4>‚úÖ Arquivo v√°lido encontrado!</h4>
          <div class="ip-row"><span>Dias com dados</span><span id="ip-dias" style="font-weight:700;"></span></div>
          <div class="ip-row"><span>√öltimo registro</span><span id="ip-ultimo" style="font-weight:700;"></span></div>
          <div class="ip-row"><span>Hist√≥rico de metas</span><span id="ip-metas" style="font-weight:700;"></span></div>
        </div>
        <div class="backup-btn-row" id="import-confirm-row" style="display:none;margin-bottom:10px;">
          <button class="bkp-btn bkp-btn-warn" onclick="confirmarImport()" style="flex:2;">
            <span class="bicon">‚ö†Ô∏è</span><span>Confirmar e restaurar</span>
          </button>
          <button class="bkp-btn bkp-btn-neutral" onclick="cancelarImport()">
            <span class="bicon">‚úï</span><span>Cancelar</span>
          </button>
        </div>
        <div id="import-paste-area">
          <p style="font-size:0.75rem;color:#546E7A;margin-bottom:6px;">Ou cole o texto do backup aqui:</p>
          <textarea id="import-paste-input" placeholder="Cole o conte√∫do do backup aqui..."
            style="width:100%;height:70px;border:2px solid #E3EAF2;border-radius:10px;padding:10px;font-size:0.78rem;resize:none;background:#F8FAFF;outline:none;"></textarea>
          <button onclick="importarDoPaste()" style="width:100%;padding:10px;margin-top:6px;background:#EEF2FF;border:1px solid #C5CAE9;border-radius:10px;font-size:0.82rem;font-weight:700;color:#1A237E;cursor:pointer;">
            üìã Importar do texto colado
          </button>
        </div>
      </div>

      <div class="backup-section">
        <div class="backup-section-title">‚öôÔ∏è Configura√ß√µes</div>
        <div class="auto-backup-row">
          <div>
            <span style="font-size:0.85rem;color:#37474F;font-weight:500;">Lembrete de backup</span>
            <div style="font-size:0.72rem;color:#90A4AE;margin-top:2px;">Avisa a cada 7 dias para exportar</div>
          </div>
          <div class="toggle-switch" id="backup-reminder-toggle" onclick="toggleBackupReminder()"></div>
        </div>
        <div class="backup-divider"></div>
        <div style="font-size:0.75rem;color:#90A4AE;line-height:1.6;">
          ‚ÑπÔ∏è Dados salvos apenas neste dispositivo/navegador.<br>
          Para outro dispositivo: exporte e importe o .json.<br><br>
          üîí Nenhum dado √© enviado para servidores externos.
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ===== FIM BACKUP ===== -->

<div class="toast" id="toast"></div>

<div class="nav">
  <button class="nav-btn active" onclick="navigate('home',this)"><span class="icon">üè†</span><span>In√≠cio</span></button>
  <button class="nav-btn" onclick="navigate('sono',this)"><span class="icon">üò¥</span><span>Sono</span></button>
  <button class="nav-btn" onclick="navigate('metas',this)"><span class="icon">üéØ</span><span>Metas</span></button>
  <button class="nav-btn" onclick="navigate('calendario',this)"><span class="icon">üóìÔ∏è</span><span>Hist√≥rico</span></button>
  <button class="nav-btn caverna-nav" onclick="navigate('caverna',this)"><span class="icon">üèîÔ∏è</span><span>Caverna</span></button>
  <button class="nav-btn" onclick="navigate('info',this)"><span class="icon">üìö</span><span>Info</span></button>
</div>

<script>
const DUR_REM = 12*60, POM_FOCO = 20*60, POM_PAUSA = 5*60, SESS_CICLO = 4;
const CIRC = 2*Math.PI*96;
const METAS_FIXAS_DEFAULT = [
  {id:'f1', texto:'Tomar medica√ß√£o', done:false, tipo:'fixa'},
  {id:'f2', texto:'Beber 2L de √°gua', done:false, tipo:'fixa'},
  {id:'f3', texto:'Fazer 30min de exerc√≠cio', done:false, tipo:'fixa'},
  {id:'f4', texto:'Dormir antes das 23h', done:false, tipo:'fixa'},
];
const FASES_REMEDIO = [
  { min: 0,  max: 60,  titulo:'üåÖ Fase de absor√ß√£o (0‚Äì1h)', cor:'#1565C0', desc:'O rem√©dio est√° sendo absorvido. Voc√™ pode n√£o sentir efeito ainda. Evite refei√ß√µes pesadas agora.' },
  { min: 60, max: 180, titulo:'üìà In√≠cio da a√ß√£o (1‚Äì3h)', cor:'#1976D2', desc:'O f√°rmaco come√ßa a agir. Voc√™ pode sentir leve aumento de alerta, redu√ß√£o do apetite e melhora no foco. √â normal sentir a boca seca.' },
  { min: 180,max: 300, titulo:'üöÄ Pico terap√™utico (3‚Äì5h)', cor:'#00897B', desc:'Este √© o momento de maior efic√°cia. Aproveite para tarefas de alto foco. Concentra√ß√£o e controle de impulsos est√£o no m√°ximo.' },
  { min: 300,max: 480, titulo:'‚ö° A√ß√£o plena (5‚Äì8h)', cor:'#2E7D32', desc:'O rem√©dio continua em plena a√ß√£o. Foco sustentado ainda presente. Lembre-se de se alimentar mesmo sem fome.' },
  { min: 480,max: 600, titulo:'üìâ Decl√≠nio gradual (8‚Äì10h)', cor:'#F57F17', desc:'O efeito come√ßa a declinar suavemente. Voc√™ pode notar leve retorno da agita√ß√£o ou dificuldade de foco. Normal nesta fase.' },
  { min: 600,max: 720, titulo:'üåô Fase de rebote (10‚Äì12h)', cor:'#E65100', desc:'Aproximando-se do fim da a√ß√£o. Pode sentir irritabilidade leve, fome e retorno dos sintomas. Evite decis√µes importantes agora.' },
  { min: 720,max: Infinity, titulo:'‚èπÔ∏è Efeito encerrado', cor:'#C62828', desc:'O Venvanse completou sua dura√ß√£o. Descanse, alimente-se bem e prepare-se para a pr√≥xima dose amanh√£.' },
];
let state = {
  dailyData: {}, currentDate: hojeISO(),
  sono: [], horasSono: null,
  metas: [], metasFixas: [],
  metasHist: [],
  remedio: null, remedioTimer: null,
  celular: null, leitura: null,
  pom: {rodando:false,fase:'foco',seg:POM_FOCO,sessoes:0,ciclos:0,sessNoCiclo:0,minFoco:0,timer:null,data:null}
};
let currentCalendarDate = new Date();
function hoje() { return new Date().toLocaleDateString('pt-BR'); }
function hojeISO(date = new Date()) { return date.getFullYear()+'-'+pad(date.getMonth()+1)+'-'+pad(date.getDate()); }
function pad(n) { return String(n).padStart(2,'0'); }
function fmt(d) { if (!(d instanceof Date) || isNaN(d)) return '--:--'; return d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); }
function showToast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }
function salvar() {
  state.dailyData[state.currentDate] = {
    sono: state.sono, remedio: state.remedio ? {...state.remedio, horaRegistro: state.remedio.horaRegistro instanceof Date ? state.remedio.horaRegistro.toISOString() : state.remedio.horaRegistro} : null,
    metas: state.metas, metasFixas: state.metasFixas, celular: state.celular, leitura: state.leitura,
    pom: {sessoes:state.pom.sessoes,ciclos:state.pom.ciclos,sessNoCiclo:state.pom.sessNoCiclo,minFoco:state.pom.minFoco,data:state.pom.data||state.currentDate}
  };
  try {
    localStorage.setItem('tdah_daily', JSON.stringify(state.dailyData));
    localStorage.setItem('tdah_mhist', JSON.stringify(state.metasHist));
    localStorage.setItem('tdah_fixas', JSON.stringify(state.metasFixas));
    localStorage.setItem('tdah_last_date', hojeISO());
  } catch(e) {}
}
function carregar() {
  try {
    const raw = localStorage.getItem('tdah_daily');
    if (raw) { state.dailyData = JSON.parse(raw); for (const d in state.dailyData) { const dd=state.dailyData[d]; if(dd.remedio&&dd.remedio.horaRegistro) dd.remedio.horaRegistro=new Date(dd.remedio.horaRegistro); } }
    const mh = localStorage.getItem('tdah_mhist'); if(mh) state.metasHist=JSON.parse(mh);
    const mf = localStorage.getItem('tdah_fixas'); if(mf) state.metasFixas=JSON.parse(mf); else state.metasFixas=METAS_FIXAS_DEFAULT.map(m=>({...m}));
    const lastDate = localStorage.getItem('tdah_last_date');
    if(lastDate&&lastDate!==hojeISO()){
      const prevData=state.dailyData[lastDate];
      if(prevData&&prevData.metas&&prevData.metas.length>0){const entry={data:lastDate,total:prevData.metas.length,concluidas:prevData.metas.filter(m=>m.done).length,lista:prevData.metas.map(m=>({t:m.texto,d:m.done,tipo:m.tipo}))};if(!state.metasHist.find(h=>h.data===lastDate)){state.metasHist.unshift(entry);if(state.metasHist.length>60)state.metasHist.splice(60);}}
      state.metasFixas=state.metasFixas.map(m=>({...m,done:false})); localStorage.setItem('tdah_fixas',JSON.stringify(state.metasFixas));
    }
  } catch(e) { console.error(e); }
}
function carregarDia(dateISO) {
  state.currentDate=dateISO; const data=state.dailyData[dateISO]||{};
  state.sono=data.sono||[]; state.remedio=data.remedio||null;
  state.metas=data.metas||[]; state.celular=data.celular||null; state.leitura=data.leitura||null;
  state.pom={rodando:false,fase:'foco',seg:POM_FOCO,timer:null,sessoes:data.pom?data.pom.sessoes:0,ciclos:data.pom?data.pom.ciclos:0,sessNoCiclo:data.pom?data.pom.sessNoCiclo:0,minFoco:data.pom?data.pom.minFoco:0,data:dateISO};
  if(state.remedioTimer) clearInterval(state.remedioTimer);
  if(state.remedio&&dateISO===hojeISO()) state.remedioTimer=setInterval(atualizarBarra,30000);
  renderUI();
}
function renderUI() {
  const now=new Date();
  document.getElementById('header-date').textContent=now.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'});
  const h=now.getHours(); document.getElementById('greeting-text').textContent=h<12?'Bom dia! üëã':h<18?'Boa tarde! üëã':'Boa noite! üëã';
  if(state.remedio){document.getElementById('remedio-sem-registro').style.display='none';document.getElementById('remedio-com-registro').style.display='block';atualizarBarra();}
  else{document.getElementById('remedio-sem-registro').style.display='block';document.getElementById('remedio-com-registro').style.display='none';document.getElementById('remedio-badge').textContent='N√£o registrado';document.getElementById('remedio-badge').className='remedio-badge badge-inativo';document.getElementById('aviso-encerrado').classList.remove('show');document.getElementById('hora-remedio').value='';}
  renderMetas(); renderHistSono(); renderHistMetas(); updateStats(); renderCelular(); renderLeitura(); renderPom();
}
function init() { carregar(); buildHoursGrid(); carregarDia(hojeISO()); renderCalendar(currentCalendarDate); }
function navigate(p,btn) {
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-'+p).classList.add('active'); btn.classList.add('active');
  if(p==='calendario'){renderCalendar(currentCalendarDate);document.getElementById('daily-summary-card').style.display='none';}
}
function registrarRemedio() {
  if(state.currentDate!==hojeISO()){showToast('‚ö†Ô∏è S√≥ registra para o dia atual');return;}
  const val=document.getElementById('hora-remedio').value;
  if(!val){showToast('‚ö†Ô∏è Informe o hor√°rio!');return;}
  const [hh,mm]=val.split(':').map(Number); const now=new Date();
  const reg=new Date(now.getFullYear(),now.getMonth(),now.getDate(),hh,mm,0);
  state.remedio={horaRegistro:reg}; salvar();
  document.getElementById('remedio-sem-registro').style.display='none';
  document.getElementById('remedio-com-registro').style.display='block';
  atualizarBarra(); if(state.remedioTimer) clearInterval(state.remedioTimer);
  state.remedioTimer=setInterval(atualizarBarra,30000); showToast('üíä Medica√ß√£o registrada!'); updateStats();
}
function atualizarBarra() {
  if(!state.remedio) return; const hr=state.remedio.horaRegistro;
  if(!(hr instanceof Date)||isNaN(hr)) return;
  const agora=new Date(); const minPass=Math.floor((agora-hr)/60000); const minRest=Math.max(0,DUR_REM-minPass);
  const pct=Math.min(100,(minPass/DUR_REM)*100); const horaEnc=new Date(hr.getTime()+DUR_REM*60000);
  document.getElementById('hora-tomada-display').textContent=fmt(hr);
  document.getElementById('hora-encerra-display').textContent=fmt(horaEnc);
  document.getElementById('remedio-fill').style.width=pct+'%';
  const cor=pct<40?'linear-gradient(90deg,#1565C0,#42A5F5)':pct<75?'linear-gradient(90deg,#1976D2,#26C6DA)':pct<100?'linear-gradient(90deg,#F57F17,#FFCA28)':'linear-gradient(90deg,#C62828,#EF5350)';
  document.getElementById('remedio-fill').style.background=cor;
  const hA=Math.floor(minPass/60),mA=minPass%60,hR=Math.floor(minRest/60),mR=minRest%60;
  document.getElementById('tempo-ativo-val').textContent=hA+'h '+pad(mA)+'min';
  document.getElementById('tempo-restante-val').textContent=minRest>0?hR+'h '+pad(mR)+'min':'Encerrado';
  document.getElementById('tempo-ativo-label').textContent=hA+'h no organismo';
  document.getElementById('tempo-restante-label').textContent=minRest>0?hR+'h restantes':'Efeito encerrado';
  const badge=document.getElementById('remedio-badge');
  if(minRest<=0){badge.textContent='Encerrado';badge.className='remedio-badge badge-encerrado';document.getElementById('aviso-encerrado').classList.add('show');document.getElementById('stat-remedio').textContent='Enc.';}
  else{badge.textContent='Ativo';badge.className='remedio-badge badge-ativo';document.getElementById('aviso-encerrado').classList.remove('show');document.getElementById('stat-remedio').textContent=hA+'h';}
  atualizarFaseRemedio(minPass);
}
function atualizarFaseRemedio(minPass) {
  const fase=FASES_REMEDIO.find(f=>minPass>=f.min&&minPass<f.max)||FASES_REMEDIO[FASES_REMEDIO.length-1];
  const box=document.getElementById('remedio-fase-box'),tit=document.getElementById('remedio-fase-titulo'),desc=document.getElementById('remedio-fase-desc');
  if(box&&tit&&desc){box.style.borderLeftColor=fase.cor;tit.textContent=fase.titulo;tit.style.color=fase.cor;desc.textContent=fase.desc;}
}
function resetarRemedio() {
  if(state.currentDate!==hojeISO()){showToast('‚ö†Ô∏è S√≥ reseta para o dia atual');return;}
  state.remedio=null;salvar();if(state.remedioTimer)clearInterval(state.remedioTimer);
  document.getElementById('remedio-sem-registro').style.display='block';document.getElementById('remedio-com-registro').style.display='none';
  document.getElementById('remedio-badge').textContent='N√£o registrado';document.getElementById('remedio-badge').className='remedio-badge badge-inativo';
  document.getElementById('aviso-encerrado').classList.remove('show');document.getElementById('hora-remedio').value='';
  document.getElementById('stat-remedio').textContent='‚Äî';showToast('üîÑ Pronto para nova dose');
}
function buildHoursGrid(){document.getElementById('hours-grid').innerHTML=[4,5,6,7,8,9,10,11].map(h=>`<button class="hour-btn" onclick="selecionarHora(${h},this)">${h}h</button>`).join('');}
function selecionarHora(h,btn){document.querySelectorAll('.hour-btn').forEach(b=>b.classList.remove('selected'));btn.classList.add('selected');state.horasSono=h;document.getElementById('sono-display').textContent=h+'h';document.getElementById('horas-custom').value='';}
function selecionarHoraCustom(val){document.querySelectorAll('.hour-btn').forEach(b=>b.classList.remove('selected'));state.horasSono=parseFloat(val)||null;if(state.horasSono){const h=Math.floor(state.horasSono),m=(state.horasSono%1)*60;document.getElementById('sono-display').textContent=m>0?h+'h'+m:h+'h';}}
function salvarSono(){
  if(state.currentDate!==hojeISO()){showToast('‚ö†Ô∏è S√≥ registra sono para o dia atual');return;}
  if(!state.horasSono){showToast('‚ö†Ô∏è Selecione quantas horas dormiu!');return;}
  state.sono.unshift({data:hoje(),horas:state.horasSono,qualidade:document.getElementById('sono-qualidade').value,obs:document.getElementById('sono-obs').value});
  if(state.sono.length>7)state.sono=state.sono.slice(0,7);
  salvar();document.getElementById('sono-obs').value='';state.horasSono=null;
  document.querySelectorAll('.hour-btn').forEach(b=>b.classList.remove('selected'));
  document.getElementById('sono-display').textContent='‚Äî';document.getElementById('horas-custom').value='';
  renderHistSono();updateStats();showToast('‚úÖ Sono salvo!');
}
function renderHistSono(){
  const c=document.getElementById('historico-sono'),hEl=document.getElementById('ultimo-sono-home');
  const qM={otima:'üòä √ìtima',boa:'üôÇ Boa',regular:'üòê Regular',ruim:'üòî Ruim',pessima:'üò´ P√©ssima'};
  const bM={otima:'badge-good',boa:'badge-good',regular:'badge-warn',ruim:'badge-bad',pessima:'badge-bad'};
  if(!state.sono.length){const m='<p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">Nenhum registro ainda</p>';c.innerHTML=m;hEl.innerHTML=m;return;}
  const mk=r=>`<div class="historico-item"><div><div style="font-weight:600;font-size:0.88rem;">${r.data}</div><div class="historico-data">${qM[r.qualidade]}</div></div><div style="display:flex;align-items:center;gap:8px;"><span style="font-weight:700;color:var(--primary);">${r.horas}h</span><span class="badge ${bM[r.qualidade]}">${r.horas>=7?'OK':'Baixo'}</span></div></div>`;
  c.innerHTML=state.sono.map(mk).join('');hEl.innerHTML=mk(state.sono[0]);
}
function renderMetas(){
  const c=document.getElementById('lista-metas');
  const prioOrder={alta:0,media:1,baixa:2};const prioLabel={alta:'üî¥ Alta',media:'üü° M√©dia',baixa:'üü¢ Baixa'};
  const prioClass={alta:'prio-alta',media:'prio-media',baixa:'prio-baixa'};const prioItemClass={alta:'prio-alta-item',media:'prio-media-item',baixa:'prio-baixa-item'};
  const sortFn=(a,b)=>{if(a.done!==b.done)return a.done?1:-1;return(prioOrder[a.prioridade||'media']||1)-(prioOrder[b.prioridade||'media']||1);};
  const fixas=[...state.metasFixas].sort(sortFn);const diarias=state.metas.filter(m=>m.tipo==='diaria'||!m.tipo).sort(sortFn);
  const mkMeta=(m,isFixa)=>{const prio=m.prioridade||'media';const toggleFn=isFixa?`toggleMetaFixa('${m.id}')`:`toggleMeta(${m.id})`;const removeFn=isFixa?`removerMetaFixa('${m.id}')`:`removerMeta(${m.id})`;
    return`<div class="meta-item ${isFixa?'fixa':''} ${prioItemClass[prio]} ${m.done?'done':''}" onclick="${toggleFn}"><div class="meta-check">${m.done?'‚úì':''}</div><div class="meta-text"><div class="meta-title" style="${m.done?'text-decoration:line-through;color:var(--text-light)':''}">${m.texto}<span class="prio-tag ${prioClass[prio]}">${prioLabel[prio]}</span></div><div class="meta-sub">${m.done?'Conclu√≠da! üéâ':'Toque para concluir'}</div></div><div onclick="event.stopPropagation();${removeFn}" style="font-size:1.1rem;color:#B0BEC5;padding:4px;">‚úï</div></div>`;};
  let html='';
  if(fixas.length){html+=`<div class="meta-secao-titulo">üìå Metas Fixas <span class="tag tag-fixa">se repetem todo dia</span></div>`;html+=fixas.map(m=>mkMeta(m,true)).join('');}
  if(diarias.length){html+=`<div class="meta-secao-titulo">üìÖ Metas Di√°rias <span class="tag tag-diaria">somem amanh√£</span></div>`;html+=diarias.map(m=>mkMeta(m,false)).join('');}
  if(!fixas.length&&!diarias.length)html='<p style="color:var(--text-light);text-align:center;font-size:0.85rem;padding:16px;">Nenhuma meta. Adicione acima!</p>';
  c.innerHTML=html;updateMetaProg();
}
function toggleMeta(id){const m=state.metas.find(m=>m.id===id);if(m){m.done=!m.done;salvar();renderMetas();updateStats();if(m.done)showToast('üéâ Meta conclu√≠da!');}}
function toggleMetaFixa(id){const m=state.metasFixas.find(m=>m.id===id);if(m){m.done=!m.done;salvar();renderMetas();updateStats();if(m.done)showToast('üéâ Meta conclu√≠da!');}}
function adicionarMeta(){
  const inp=document.getElementById('nova-meta-input');const tipo=document.getElementById('nova-meta-tipo').value;const prio=document.getElementById('nova-meta-prio').value;const txt=inp.value.trim();
  if(!txt){showToast('‚ö†Ô∏è Digite uma meta!');return;}
  if(tipo==='fixa')state.metasFixas.push({id:'f'+Date.now(),texto:txt,done:false,tipo:'fixa',prioridade:prio});
  else state.metas.push({id:Date.now(),texto:txt,done:false,tipo:'diaria',prioridade:prio});
  inp.value='';salvar();renderMetas();updateStats();const prioEmoji=prio==='alta'?'üî¥':prio==='media'?'üü°':'üü¢';
  showToast(tipo==='fixa'?`üìå Meta fixa ${prioEmoji} adicionada!`:`‚úÖ Meta di√°ria ${prioEmoji} adicionada!`);
}
function removerMeta(id){state.metas=state.metas.filter(m=>m.id!==id);salvar();renderMetas();updateStats();showToast('üóëÔ∏è Meta removida');}
function removerMetaFixa(id){state.metasFixas=state.metasFixas.filter(m=>m.id!==id);salvar();renderMetas();updateStats();showToast('üóëÔ∏è Meta fixa removida');}
function limparConcluidas(){state.metas=state.metas.filter(m=>!m.done);salvar();renderMetas();updateStats();showToast('üßπ Di√°rias conclu√≠das removidas!');}
function updateMetaProg(){
  const fixasDone=state.metasFixas.filter(m=>m.done).length;const diariasDone=state.metas.filter(m=>m.done&&(m.tipo==='diaria'||!m.tipo)).length;
  const tot=state.metasFixas.length+state.metas.filter(m=>m.tipo==='diaria'||!m.tipo).length;const dn=fixasDone+diariasDone;const pct=tot>0?Math.round((dn/tot)*100):0;
  document.getElementById('meta-progress').style.width=pct+'%';document.getElementById('meta-info').textContent=dn+' conclu√≠da'+(dn!==1?'s':'');document.getElementById('meta-pct').textContent=pct+'%';
}
function renderHistMetas(){
  const c=document.getElementById('historico-metas-lista');
  if(!state.metasHist.length){c.innerHTML='<p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">O hist√≥rico aparecer√° aqui a partir de amanh√£.</p>';return;}
  const fmtD=iso=>{const p=iso.split('-');return p[2]+'/'+p[1]+'/'+p[0];};
  c.innerHTML=state.metasHist.slice(0,7).map(h=>{const pct=h.total>0?Math.round((h.concluidas/h.total)*100):0;const cls=pct>=80?'badge-good':pct>=50?'badge-warn':'badge-bad';
    return`<div class="meta-hist-card"><div><div style="font-weight:600;font-size:0.88rem;">${fmtD(h.data)}</div><div style="font-size:0.8rem;color:var(--text-light);">${h.concluidas} de ${h.total} metas conclu√≠das</div></div><span class="badge ${cls}">${pct}%</span></div>`;}).join('');
}
function salvarLeitura(){
  if(state.currentDate!==hojeISO()){showToast('‚ö†Ô∏è S√≥ registra leitura para hoje');return;}
  const val=parseInt(document.getElementById('paginas-input').value);if(!val||val<0){showToast('‚ö†Ô∏è Informe um n√∫mero v√°lido de p√°ginas!');return;}
  state.leitura={paginas:val,data:hojeISO()};salvar();renderLeitura();showToast('üìö Leitura registrada!');
}
function renderLeitura(){
  const form=document.getElementById('leitura-form'),reg=document.getElementById('leitura-registrada');
  if(state.leitura){
    form.style.display='none';reg.style.display='block';
    const cls=state.leitura.paginas>=20?'badge-good':state.leitura.paginas>=5?'badge-warn':'badge-bad';
    const msg=state.leitura.paginas>=20?'Excelente! üèÜ':state.leitura.paginas>=5?'Bom progresso! üëç':'Leia mais amanh√£! üí™';
    reg.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;"><div><div style="font-weight:700;font-size:1.2rem;color:var(--primary);">üìñ ${state.leitura.paginas} p√°ginas</div><div style="font-size:0.78rem;color:var(--text-light);">${msg}</div></div><span class="badge ${cls}">${state.leitura.paginas>=20?'√ìtimo':state.leitura.paginas>=5?'Ok':'Baixo'}</span></div><button onclick="resetarLeitura()" style="margin-top:10px;font-size:0.78rem;color:var(--text-light);background:none;border:none;cursor:pointer;text-decoration:underline;">Editar registro</button>`;
  }else{form.style.display='block';reg.style.display='none';}
}
function resetarLeitura(){state.leitura=null;salvar();document.getElementById('paginas-input').value='';renderLeitura();}
function avalCelular(h,m){const t=h*60+m;if(t<=120)return{msg:'Excelente controle!',badge:'badge-good',label:'√ìtimo'};if(t<=240)return{msg:'Uso moderado',badge:'badge-warn',label:'OK'};return{msg:'Uso elevado ‚Äî tente reduzir',badge:'badge-bad',label:'Alto'};}
function salvarCelular(){
  if(state.currentDate!==hojeISO()){showToast('‚ö†Ô∏è S√≥ registra para hoje');return;}
  const h=parseInt(document.getElementById('celular-horas').value)||0;const m=parseInt(document.getElementById('celular-minutos').value)||0;
  if(h===0&&m===0){showToast('‚ö†Ô∏è Informe o tempo de celular!');return;}
  state.celular={horas:h,minutos:m};salvar();renderCelular();showToast('üì± Tempo de celular salvo!');
}
function salvarCelularCaverna(){
  if(state.currentDate!==hojeISO()){showToast('‚ö†Ô∏è S√≥ registra para hoje');return;}
  const h=parseInt(document.getElementById('cav-cel-h').value)||0;const m=parseInt(document.getElementById('cav-cel-m').value)||0;
  if(h===0&&m===0){showToast('‚ö†Ô∏è Informe o tempo!');return;}
  state.celular={horas:h,minutos:m};salvar();renderCelular();showToast('üì± Tempo salvo!');
}
function renderCelular(){
  const hD=document.getElementById('celular-home-display'),hR=document.getElementById('celular-registrado-home');
  const cF=document.getElementById('cav-celular-form'),cR=document.getElementById('cav-celular-registrado');
  if(state.celular){
    const txt=state.celular.horas+'h '+state.celular.minutos+'min';const av=avalCelular(state.celular.horas,state.celular.minutos);
    hD.style.display='none';hR.style.display='block';
    hR.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;"><div><div style="font-weight:700;font-size:1.1rem;color:var(--primary);">üì± ${txt}</div><div style="font-size:0.78rem;color:var(--text-light);">${av.msg}</div></div><span class="badge ${av.badge}">${av.label}</span></div><button onclick="resetarCelular()" style="margin-top:10px;font-size:0.78rem;color:var(--text-light);background:none;border:none;cursor:pointer;text-decoration:underline;">Editar registro</button>`;
    cF.style.display='none';cR.style.display='block';
    cR.innerHTML=`<div style="background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.3);border-radius:10px;padding:12px;margin-top:10px;color:#A78BFA;font-size:0.85rem;">üì± <strong style="color:#E0E0FF;">${txt}</strong> ‚Äî ${av.msg}</div><button onclick="resetarCelular()" style="margin-top:8px;font-size:0.75rem;color:#6B7280;background:none;border:none;cursor:pointer;text-decoration:underline;">Editar</button>`;
  }else{hD.style.display='block';hR.style.display='none';cF.style.display='block';cR.style.display='none';}
}
function resetarCelular(){state.celular=null;salvar();document.getElementById('celular-horas').value='';document.getElementById('celular-minutos').value='';renderCelular();}
function updateStats(){
  const fixasDone=state.metasFixas.filter(m=>m.done).length;const diariasDone=state.metas.filter(m=>m.done&&(m.tipo==='diaria'||!m.tipo)).length;
  const tot=state.metasFixas.length+state.metas.filter(m=>m.tipo==='diaria'||!m.tipo).length;const dn=fixasDone+diariasDone;const pct=tot>0?Math.round((dn/tot)*100):0;
  const ult=state.sono[0];document.getElementById('stat-sono').textContent=ult?ult.horas+'h':'‚Äî';
  document.getElementById('stat-metas').textContent=dn+'/'+tot;
  document.getElementById('progress-fill').style.width=pct+'%';document.getElementById('progress-text').textContent=dn+' de '+tot+' metas conclu√≠das';document.getElementById('progress-pct').textContent=pct+'%';
}
function togglePomodoro(){if(state.currentDate!==hojeISO()){showToast('‚ö†Ô∏è Modo Caverna s√≥ para hoje');return;}if(state.pom.rodando)pausarPom();else iniciarPom();}
function iniciarPom(){state.pom.rodando=true;document.getElementById('caverna-play-btn').textContent='‚è∏';if(!state.pom.seg||isNaN(state.pom.seg)||state.pom.seg<=0)state.pom.seg=state.pom.fase==='foco'?getPomFoco():getPomPausa();atualizarUIPom();state.pom.timer=setInterval(tickPom,1000);}
function pausarPom(){state.pom.rodando=false;document.getElementById('caverna-play-btn').textContent='‚ñ∂';clearInterval(state.pom.timer);salvar();}
function tickPom(){state.pom.seg--;if(state.pom.seg<=0)concluirFase();else atualizarUIPom();}
function concluirFase(){
  clearInterval(state.pom.timer);state.pom.rodando=false;
  const focoMin=getPomFoco()/60;
  if(state.pom.fase==='foco'){state.pom.sessoes++;state.pom.sessNoCiclo++;state.pom.minFoco+=focoMin;if(state.pom.sessNoCiclo>=SESS_CICLO){state.pom.ciclos++;state.pom.sessNoCiclo=0;showToast('üèÜ Ciclo completo! Fa√ßa uma pausa maior.');}else showToast('‚úÖ Sess√£o conclu√≠da! Hora de pausar!');state.pom.fase='pausa';state.pom.seg=getPomPausa();}
  else{state.pom.fase='foco';state.pom.seg=getPomFoco();showToast('üéØ Hora de focar!');}
  state.pom.data=hojeISO();salvar();document.getElementById('caverna-play-btn').textContent='‚ñ∂';atualizarUIPom();playBeep();
}
function pularFase(){
  if(state.currentDate!==hojeISO()){showToast('‚ö†Ô∏è Modo Caverna s√≥ para hoje');return;}
  clearInterval(state.pom.timer);state.pom.rodando=false;document.getElementById('caverna-play-btn').textContent='‚ñ∂';
  if(state.pom.fase==='foco'){state.pom.sessoes++;state.pom.sessNoCiclo++;state.pom.minFoco+=getPomFoco()/60;if(state.pom.sessNoCiclo>=SESS_CICLO){state.pom.ciclos++;state.pom.sessNoCiclo=0;showToast('üèÜ Ciclo completo!');}else showToast('‚úÖ +1 sess√£o registrada! Hora de pausar.');state.pom.fase='pausa';state.pom.seg=getPomPausa();}
  else{state.pom.fase='foco';state.pom.seg=getPomFoco();showToast('üéØ Pausa pulada ‚Äî hora de focar!');}
  atualizarUIPom();salvar();
}
function adicionarSessaoManual(){
  if(state.currentDate!==hojeISO()){showToast('‚ö†Ô∏è S√≥ para hoje');return;}
  state.pom.sessoes++;state.pom.sessNoCiclo++;state.pom.minFoco+=20;
  if(state.pom.sessNoCiclo>=SESS_CICLO){state.pom.ciclos++;state.pom.sessNoCiclo=0;showToast('üèÜ Ciclo completo! +1 sess√£o adicionada.');}else showToast('‚úÖ +1 sess√£o de 20min adicionada');
  salvar();renderPom();
}
function removerSessaoManual(){
  if(state.currentDate!==hojeISO()){showToast('‚ö†Ô∏è S√≥ para hoje');return;}
  if(state.pom.sessoes<=0){showToast('‚ö†Ô∏è Nenhuma sess√£o para remover');return;}
  state.pom.sessoes--;state.pom.minFoco=Math.max(0,state.pom.minFoco-20);
  if(state.pom.sessNoCiclo>0)state.pom.sessNoCiclo--;else if(state.pom.ciclos>0){state.pom.ciclos--;state.pom.sessNoCiclo=SESS_CICLO-1;}
  salvar();renderPom();showToast('‚Ü©Ô∏è 1 sess√£o removida');
}
function resetarPomodoro(){
  if(state.currentDate!==hojeISO()){showToast('‚ö†Ô∏è Modo Caverna s√≥ para hoje');return;}
  clearInterval(state.pom.timer);state.pom.rodando=false;state.pom.fase='foco';state.pom.seg=getPomFoco();
  document.getElementById('caverna-play-btn').textContent='‚ñ∂';atualizarUIPom();showToast('üîÑ Timer reiniciado');salvar();
}
function atualizarUIPom(){
  const p=state.pom;const focoSeg=getPomFoco();const pausaSeg=getPomPausa();
  const seg=(typeof p.seg==='number'&&!isNaN(p.seg)&&p.seg>=0)?p.seg:(p.fase==='foco'?focoSeg:pausaSeg);
  const total=p.fase==='foco'?focoSeg:pausaSeg;const prog=(total-seg)/total;
  document.getElementById('caverna-ring-fill').style.strokeDashoffset=CIRC*(1-prog);
  document.getElementById('caverna-ring-fill').style.stroke=p.fase==='foco'?'#A78BFA':'#60A5FA';
  const mm=Math.floor(seg/60),ss=Math.floor(seg%60);
  document.getElementById('caverna-time-display').textContent=pad(mm)+':'+pad(ss);
  document.getElementById('caverna-phase-label').textContent=p.fase==='foco'?'FOCO':'PAUSA';
  const badge=document.getElementById('caverna-status-badge');const isFull=seg===(p.fase==='foco'?focoSeg:pausaSeg);
  if(!p.rodando&&isFull){badge.textContent='‚è∏ Aguardando in√≠cio';badge.className='caverna-status-badge status-idle';}
  else if(p.fase==='foco'){badge.textContent=p.rodando?'üéØ Em foco':'‚è∏ Foco pausado';badge.className='caverna-status-badge status-foco';}
  else{badge.textContent=p.rodando?'‚òï Pausa ativa':'‚è∏ Pausa pausada';badge.className='caverna-status-badge status-pausa';}
  renderPom();
}
function renderPom(){
  const p=state.pom;document.getElementById('cav-sessoes').textContent=p.sessoes;
  const min=p.minFoco;document.getElementById('cav-foco-total').textContent=min>=60?Math.floor(min/60)+'h'+(min%60>0?min%60+'m':''):min+'min';
  document.getElementById('cav-ciclos').textContent=p.ciclos;
  let html='';for(let i=0;i<SESS_CICLO;i++){if(i<p.sessNoCiclo)html+=`<div class="session-dot completo">‚úì</div>`;else if(i===p.sessNoCiclo&&p.fase==='foco'&&p.rodando)html+=`<div class="session-dot atual">${i+1}</div>`;else html+=`<div class="session-dot">${i+1}</div>`;}
  document.getElementById('session-dots').innerHTML=html;
}
function playBeep(){try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.connect(g);g.connect(ctx.destination);o.frequency.value=440;g.gain.setValueAtTime(0.3,ctx.currentTime);g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.6);o.start(ctx.currentTime);o.stop(ctx.currentTime+0.6);}catch(e){}}
function abrirRelatorio(){
  const now=new Date();document.getElementById('relatorio-date').textContent=now.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  let pts=0,max=0;const pontosDetalhe=[];const dicas=[];
  const sh=state.sono.find(s=>s.data===hoje());let sonoH='';max+=25;
  if(sh){const qM={otima:'üòä √ìtima',boa:'üôÇ Boa',regular:'üòê Regular',ruim:'üòî Ruim',pessima:'üò´ P√©ssima'};const p=sh.horas>=7?25:sh.horas>=5?15:5;pts+=p;pontosDetalhe.push({label:'üò¥ Sono',pts:p,max:25,ok:sh.horas>=7});if(sh.horas<7)dicas.push(`Tente dormir ${7-sh.horas<=1?'mais 1 hora':'pelo menos 7h'} ‚Äî sono adequado potencializa o foco e o efeito do tratamento.`);sonoH=`<div class="rel-section" style="border-color:#1565C0;"><h3>üò¥ Sono</h3><div class="rel-row"><span>Horas dormidas</span><span class="rv">${sh.horas}h</span></div><div class="rel-row"><span>Qualidade</span><span class="rv">${qM[sh.qualidade]}</span></div><div class="rel-row"><span>Avalia√ß√£o</span><span class="rv">${sh.horas>=7?'‚úÖ Adequado':sh.horas>=5?'‚ö†Ô∏è Abaixo do ideal':'‚ùå Insuficiente'}</span></div></div>`;}
  else{pontosDetalhe.push({label:'üò¥ Sono',pts:0,max:25,ok:false});dicas.push('Registre seu sono diariamente.');sonoH=`<div class="rel-section" style="border-color:#B0BEC5;"><h3>üò¥ Sono</h3><p style="font-size:0.83rem;color:var(--text-light);">N√£o registrado hoje.</p></div>`;}
  const fixasDone=state.metasFixas.filter(m=>m.done).length;const tot=state.metasFixas.length+state.metas.filter(m=>m.tipo==='diaria'||!m.tipo).length;const dn=fixasDone+state.metas.filter(m=>m.done&&(m.tipo==='diaria'||!m.tipo)).length;const pctM=tot>0?Math.round((dn/tot)*100):0;
  max+=30;const ptsMetas=Math.round((pctM/100)*30);pts+=ptsMetas;pontosDetalhe.push({label:'üéØ Metas',pts:ptsMetas,max:30,ok:pctM>=70});if(pctM<70&&tot>0){const pend=tot-dn;dicas.push(`Ficaram ${pend} meta${pend>1?'s':''} pendente${pend>1?'s':''}.`);}
  const todasMetas=[...state.metasFixas,...state.metas.filter(m=>m.tipo==='diaria'||!m.tipo)];
  const metasH=`<div class="rel-section" style="border-color:#2E7D32;"><h3>üéØ Metas do Dia</h3><div class="rel-row"><span>Conclu√≠das</span><span class="rv">${dn} de ${tot}</span></div><div class="rel-row"><span>Taxa</span><span class="rv">${pctM}%</span></div>${todasMetas.map(m=>`<div class="rel-row"><span>${m.tipo==='fixa'?'üìå ':''}<span style="font-size:0.7rem;">${m.prioridade==='alta'?'üî¥':m.prioridade==='baixa'?'üü¢':'üü°'}</span> ${m.texto}</span><span class="rv">${m.done?'‚úÖ':'‚¨ú'}</span></div>`).join('')}</div>`;
  const p=state.pom;max+=25;const ptsPom=Math.min(25,Math.round((p.minFoco/80)*25));pts+=ptsPom;pontosDetalhe.push({label:'üèîÔ∏è Caverna',pts:ptsPom,max:25,ok:p.minFoco>=40});if(p.minFoco<40)dicas.push('Tente completar ao menos 2 sess√µes de Modo Caverna amanh√£.');
  const pomH=`<div class="rel-section" style="border-color:#7C3AED;"><h3>üèîÔ∏è Modo Caverna</h3><div class="rel-row"><span>Sess√µes</span><span class="rv">${p.sessoes}</span></div><div class="rel-row"><span>Ciclos</span><span class="rv">${p.ciclos}</span></div><div class="rel-row"><span>Foco total</span><span class="rv">${p.minFoco}min</span></div></div>`;
  max+=20;let celH='';
  if(state.celular){const tm=state.celular.horas*60+state.celular.minutos;const ptsCel=tm<=120?20:tm<=240?10:0;pts+=ptsCel;pontosDetalhe.push({label:'üì± Tela',pts:ptsCel,max:20,ok:ptsCel>=15});if(ptsCel<15)dicas.push('O tempo de tela foi elevado.');const av=avalCelular(state.celular.horas,state.celular.minutos);celH=`<div class="rel-section" style="border-color:#F57F17;"><h3>üì± Tela</h3><div class="rel-row"><span>Tempo</span><span class="rv">${state.celular.horas}h ${state.celular.minutos}min</span></div><div class="rel-row"><span>Avalia√ß√£o</span><span class="rv">${av.msg}</span></div></div>`;}
  else{pontosDetalhe.push({label:'üì± Tela',pts:0,max:20,ok:false});dicas.push('Registre o tempo de tela amanh√£.');celH=`<div class="rel-section" style="border-color:#B0BEC5;"><h3>üì± Tela</h3><p style="font-size:0.83rem;color:var(--text-light);">N√£o registrado.</p></div>`;}
  let remH=state.remedio?`<div class="rel-section" style="border-color:#29B6F6;"><h3>üíä Medica√ß√£o</h3><div class="rel-row"><span>Tomado √†s</span><span class="rv">${fmt(state.remedio.horaRegistro)}</span></div><div class="rel-row"><span>Status</span><span class="rv">‚úÖ Registrado hoje</span></div></div>`:`<div class="rel-section" style="border-color:#B0BEC5;"><h3>üíä Medica√ß√£o</h3><p style="font-size:0.83rem;color:var(--text-light);">N√£o registrada hoje.</p></div>`;
  let leitH=state.leitura?`<div class="rel-section" style="border-color:#6A1B9A;"><h3>üìö Leitura</h3><div class="rel-row"><span>P√°ginas lidas</span><span class="rv">${state.leitura.paginas} p√°ginas</span></div></div>`:'';
  const nota=max>0?Math.round((pts/max)*100):0;const em=nota>=80?'üèÜ':nota>=60?'‚≠ê':nota>=40?'üí™':'üå±';const msg=nota>=80?'Dia excelente!':nota>=60?'Bom progresso!':nota>=40?'Continue tentando!':'Amanh√£ ser√° melhor!';
  const pontosBar=pontosDetalhe.map(pd=>`<div style="margin-bottom:8px;"><div style="display:flex;justify-content:space-between;font-size:0.82rem;margin-bottom:3px;"><span>${pd.label}</span><span style="font-weight:700;color:${pd.ok?'#2E7D32':'#F57F17'};">${pd.pts}/${pd.max}pts</span></div><div style="height:6px;background:#E3EAF2;border-radius:3px;overflow:hidden;"><div style="height:100%;width:${Math.round((pd.pts/pd.max)*100)}%;background:${pd.ok?'linear-gradient(to right,#2E7D32,#66BB6A)':'linear-gradient(to right,#F57F17,#FFA726)'};border-radius:3px;"></div></div></div>`).join('');
  const dicasH=dicas.length>0?`<div class="rel-section" style="border-color:#FFB300;background:#FFFDE7;"><h3 style="color:#F57F17;">üí° O que melhorar amanh√£</h3>${dicas.map((d,i)=>`<div style="padding:8px 0;border-bottom:${i<dicas.length-1?'1px solid #FFF8E1':'none'};font-size:0.84rem;color:#5D4037;line-height:1.5;">‚Ä¢ ${d}</div>`).join('')}</div>`:`<div class="rel-section" style="border-color:#2E7D32;background:#F1F8E9;"><h3 style="color:#2E7D32;">üèÜ Parab√©ns!</h3><p style="font-size:0.84rem;color:#33691E;">Dia excelente em todas as categorias!</p></div>`;
  document.getElementById('relatorio-body').innerHTML=`<div class="rel-avaliacao"><div style="font-size:2rem;">${em}</div><div class="rel-nota">${pts}<span style="font-size:1.2rem;opacity:0.7;">/${max}</span></div><div class="rel-nota-label">${nota}/100 pontos ‚Äî ${msg}</div></div><div class="rel-section" style="border-color:#1565C0;"><h3>üìä Pontos por categoria</h3>${pontosBar}</div>${dicasH}${sonoH}${metasH}${pomH}${celH}${remH}${leitH}`;
  document.getElementById('relatorio-modal').classList.add('show');
}
function fecharRelatorio(e){if(e.target.id==='relatorio-modal')document.getElementById('relatorio-modal').classList.remove('show');}
function gerarRelatorioMensal(){
  const wrap=document.getElementById('relatorio-mensal-wrap');
  const today=new Date(); const daysN=30;
  let sonoTotal=0,sonoN=0,sonoAbaixo7=0,sonoAbaixo6=0,metasConcl=0,metasTotal=0,
      focoTotal=0,focoN=0,celularTotal=0,celularN=0,remedioN=0,
      leituraTotal=0,leituraN=0,diasDados=0,reativarTotal=0;
  const diasReativar={}; const sonoSeries=[]; const focoSeries=[];

  for(let i=daysN-1;i>=0;i--){
    const d=new Date(today); d.setDate(today.getDate()-i);
    const iso=hojeISO(d); const dd=state.dailyData[iso];
    if(!dd){ sonoSeries.push(null); focoSeries.push(0); continue; }
    diasDados++;
    if(dd.sono&&dd.sono.length>0){
      const h=dd.sono[0].horas; sonoTotal+=h; sonoN++;
      if(h<7)sonoAbaixo7++; if(h<6)sonoAbaixo6++;
      sonoSeries.push(h);
    } else { sonoSeries.push(null); }
    const allMetas=[...(dd.metas||[]),...(dd.metasFixas||[])];
    if(allMetas.length>0){ metasConcl+=allMetas.filter(m=>m.done).length; metasTotal+=allMetas.length; }
    if(dd.pom&&dd.pom.minFoco>0){ focoTotal+=dd.pom.minFoco; focoN++; focoSeries.push(dd.pom.minFoco); }
    else focoSeries.push(0);
    if(dd.celular){ celularTotal+=dd.celular.horas*60+dd.celular.minutos; celularN++; }
    if(dd.remedio) remedioN++;
    if(dd.leitura){ leituraTotal+=dd.leitura.paginas; leituraN++; }
    if(dd.reativarFoco&&dd.reativarFoco.length>0){ reativarTotal+=dd.reativarFoco.length; diasReativar[iso]=dd.reativarFoco.length; }
  }

  if(diasDados===0){
    wrap.innerHTML=`<div class="clinico-aviso">üìã Nenhum dado registrado ainda. Use o app diariamente para gerar seu relat√≥rio cl√≠nico.</div>`;
    return;
  }

  const avgSono = sonoN>0 ? (sonoTotal/sonoN) : null;
  const pctMetas = metasTotal>0 ? Math.round((metasConcl/metasTotal)*100) : null;
  const avgFoco = focoN>0 ? Math.round(focoTotal/focoN) : null;
  const avgCelular = celularN>0 ? Math.round(celularTotal/celularN) : null;
  const pctRemedio = Math.round((remedioN/diasDados)*100);
  const pctSonoAdequado = sonoN>0 ? Math.round(((sonoN-sonoAbaixo7)/sonoN)*100) : null;
  const dataIni = new Date(today); dataIni.setDate(today.getDate()-29);
  const fmtD = d => d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'});
  const fmtM = d => d.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});

  // Score geral cl√≠nico 0-100
  let scoreTotal=0, scoreMax=0;
  if(avgSono!==null){scoreMax+=25; scoreTotal+=avgSono>=7?25:avgSono>=6?15:avgSono>=5?8:2;}
  if(pctMetas!==null){scoreMax+=25; scoreTotal+=Math.round((pctMetas/100)*25);}
  if(avgFoco!==null){scoreMax+=25; scoreTotal+=Math.min(25,Math.round((avgFoco/60)*25));}
  if(avgCelular!==null){scoreMax+=15; scoreTotal+=avgCelular<=120?15:avgCelular<=240?10:avgCelular<=360?5:0;}
  scoreMax+=10; scoreTotal+=Math.round((pctRemedio/100)*10);
  const scoreGeral = scoreMax>0 ? Math.round((scoreTotal/scoreMax)*100) : 0;
  const scoreCor = scoreGeral>=75?'#2E7D32':scoreGeral>=50?'#F57F17':'#C62828';
  const scoreLabel = scoreGeral>=75?'Boa ades√£o ao tratamento':scoreGeral>=50?'Ades√£o moderada':'Ades√£o baixa ‚Äî requer aten√ß√£o';

  // Mini gr√°fico de sono (√∫ltimas 4 semanas, barras semanais)
  const sonoValidos = sonoSeries.filter(v=>v!==null);
  const sonoMax = Math.max(...sonoValidos, 9);
  const focoMax = Math.max(...focoSeries, 60);
  const grafSono = sonoSeries.slice(-14).map(v => {
    const h = Math.round((v||0)/sonoMax*100);
    const cor = !v?'#EEF2F7':v>=7?'#43A047':v>=6?'#FFA726':'#EF5350';
    return `<div class="clinico-grafico-bar" style="height:${Math.max(4,h)}%;background:${cor};flex:1;" title="${v?v+'h':'‚Äî'}"></div>`;
  }).join('');
  const grafFoco = focoSeries.slice(-14).map(v => {
    const h = Math.round((v/focoMax)*100);
    const cor = v>=60?'#7C3AED':v>=30?'#A78BFA':'#E3EAF2';
    return `<div class="clinico-grafico-bar" style="height:${Math.max(4,h)}%;background:${cor};flex:1;" title="${v?v+'min':'‚Äî'}"></div>`;
  }).join('');

  // Parecer textual por se√ß√£o
  function parecerSono(){
    if(!avgSono) return 'Dados de sono insuficientes para an√°lise.';
    let txt=`M√©dia de ${avgSono.toFixed(1)}h/noite no per√≠odo. `;
    if(avgSono>=8)txt+='Padr√£o de sono <strong>dentro dos par√¢metros ideais</strong> para adultos com TDAH (7‚Äì9h). Sono adequado potencializa a efic√°cia do tratamento farmacol√≥gico.';
    else if(avgSono>=7)txt+='Sono <strong>lim√≠trofe ao adequado</strong>. Pequenas varia√ß√µes para baixo podem impactar concentra√ß√£o e resposta ao medicamento.';
    else if(avgSono>=6)txt+='Sono <strong>abaixo do recomendado</strong>. Priva√ß√£o cr√¥nica leve (6‚Äì7h) agrava desaten√ß√£o e impulsividade em pacientes com TDAH.';
    else txt+='Sono <strong>significativamente abaixo do limiar terap√™utico</strong>. Priva√ß√£o de sono desta magnitude compromete gravemente a regula√ß√£o executiva e pode reduzir a efic√°cia da medica√ß√£o.';
    if(sonoAbaixo7>0)txt+=` Registradas <strong>${sonoAbaixo7} noites abaixo de 7h</strong> no per√≠odo.`;
    return txt;
  }

  function parecerMetas(){
    if(pctMetas===null)return 'Dados de metas insuficientes para an√°lise.';
    let txt=`Taxa de conclus√£o de metas: <strong>${pctMetas}%</strong> (${metasConcl}/${metasTotal}). `;
    if(pctMetas>=80)txt+='<strong>Desempenho satisfat√≥rio</strong> na execu√ß√£o de planejamento. Indica boa capacidade de organiza√ß√£o e follow-through no per√≠odo.';
    else if(pctMetas>=60)txt+='Desempenho <strong>moderado</strong>. Sugere dificuldades ocasionais de planejamento ou de manuten√ß√£o de foco ao longo do dia.';
    else if(pctMetas>=40)txt+='Desempenho <strong>abaixo do esperado</strong>. Padr√£o consistente com dificuldades executivas caracter√≠sticas do TDAH ‚Äî considerar ajuste de estrat√©gias.';
    else txt+='<strong>Dificuldade persistente na execu√ß√£o de planejamento</strong>. Taxa inferior a 40% pode indicar sobrecarga, estrat√©gias inadequadas ou necessidade de revis√£o terap√™utica.';
    return txt;
  }

  function parecerFoco(){
    if(!avgFoco)return 'Nenhuma sess√£o de foco registrada no per√≠odo. Recomenda-se iniciar uso do Modo Caverna.';
    const totalH = Math.floor(focoTotal/60), totalM = focoTotal%60;
    let txt=`Total de <strong>${totalH>0?totalH+'h ':''  }${totalM>0?totalM+'min':''}de foco registrado</strong> em ${focoN} dias ativos. M√©dia de ${avgFoco}min/dia. `;
    if(avgFoco>=60)txt+='Volume de foco <strong>adequado para adulto com TDAH</strong>. Consist√™ncia no uso de t√©cnicas estruturadas.';
    else if(avgFoco>=30)txt+='Volume de foco <strong>moderado</strong>. H√° espa√ßo para aumentar sess√µes de trabalho concentrado.';
    else txt+='Volume de foco <strong>baixo</strong>. Sess√µes curtas e irregulares s√£o esperadas em fases de desregula√ß√£o. Considerar estrat√©gias de body doubling ou ajuste do protocolo Pomodoro.';
    return txt;
  }

  function parecerMedicacao(){
    let txt=`Medica√ß√£o registrada em <strong>${remedioN} de ${diasDados} dias</strong> com dados (${pctRemedio}%). `;
    if(pctRemedio>=90)txt+='<strong>Ades√£o medicamentosa excelente</strong>. Consist√™ncia farmacol√≥gica √© fundamental para estabilidade cl√≠nica.';
    else if(pctRemedio>=75)txt+='<strong>Boa ades√£o</strong> ao tratamento farmacol√≥gico.';
    else if(pctRemedio>=50)txt+='<strong>Ades√£o moderada</strong>. Dias sem registro podem indicar esquecimento ou efeitos adversos ‚Äî avaliar na consulta.';
    else txt+='<strong>Ades√£o baixa ao tratamento</strong>. Este padr√£o pode comprometer significativamente a estabilidade cl√≠nica. Discuss√£o priorit√°ria na pr√≥xima consulta.';
    return txt;
  }

  function parecerTela(){
    if(!avgCelular)return 'Tempo de tela n√£o monitorado no per√≠odo.';
    const h=Math.floor(avgCelular/60), m=avgCelular%60;
    let txt=`M√©dia de <strong>${h}h${m>0?m+'min':''}/dia</strong> de uso de dispositivos. `;
    if(avgCelular<=120)txt+='<strong>Controle adequado</strong> do tempo de tela. Uso dentro de par√¢metros que favorecem foco e sono.';
    else if(avgCelular<=240)txt+='Uso <strong>moderado a elevado</strong>. Aten√ß√£o ao impacto em sono e capacidade de foco prolongado.';
    else txt+='<strong>Uso elevado de telas</strong>. Tempo excessivo em dispositivos correlaciona-se negativamente com aten√ß√£o sustentada e qualidade do sono em pacientes com TDAH.';
    return txt;
  }

  const row=(lbl,val,badge,badgeTxt)=>`<div class="clinico-linha"><span class="cl-lbl">${lbl}</span><span class="cl-val">${val}</span><span class="cl-badge ${badge}">${badgeTxt}</span></div>`;

  wrap.innerHTML = `
  <div style="font-size:0.72rem;color:#90A4AE;text-align:right;margin-bottom:8px;">üìÖ ${fmtD(dataIni)} a ${fmtD(today)}</div>

  <!-- Cabe√ßalho cl√≠nico -->
  <div class="clinico-wrap">
    <div class="clinico-topo">
      <div class="ct-titulo">üìã Relat√≥rio Cl√≠nico de Acompanhamento</div>
      <div class="ct-sub">TDAH Care ¬∑ ${fmtM(today)} ¬∑ ${diasDados} dias com registro</div>
      <div class="ct-meta">
        <div class="ct-meta-item">
          <div class="ctm-val" style="color:${scoreCor};">${scoreGeral}</div>
          <div class="ctm-lbl">Score geral /100</div>
        </div>
        <div class="ct-meta-item">
          <div class="ctm-val">${diasDados}</div>
          <div class="ctm-lbl">Dias registrados</div>
        </div>
        <div class="ct-meta-item">
          <div class="ctm-val">${pctRemedio}%</div>
          <div class="ctm-lbl">Ades√£o ao med.</div>
        </div>
      </div>
    </div>

    <!-- Quadro geral -->
    <div class="clinico-secao">
      <div class="clinico-secao-titulo">üìä Indicadores do Per√≠odo</div>
      ${avgSono!==null?row('M√©dia de sono/noite', avgSono.toFixed(1)+'h', avgSono>=7?'cl-norm':avgSono>=6?'cl-atenc':'cl-crit', avgSono>=7?'Adequado':avgSono>=6?'Aten√ß√£o':'Cr√≠tico'):''}
      ${pctMetas!==null?row('Taxa de conclus√£o de metas', pctMetas+'% ('+metasConcl+'/'+metasTotal+')', pctMetas>=70?'cl-norm':pctMetas>=50?'cl-atenc':'cl-crit', pctMetas>=70?'Adequada':pctMetas>=50?'Moderada':'Baixa'):''}
      ${avgFoco!==null?row('M√©dia de foco di√°rio', avgFoco+'min/dia', avgFoco>=40?'cl-norm':avgFoco>=20?'cl-atenc':'cl-crit', avgFoco>=40?'Adequado':avgFoco>=20?'Moderado':'Baixo'):''}
      ${avgCelular!==null?row('M√©dia de tempo de tela', Math.floor(avgCelular/60)+'h'+(avgCelular%60>0?avgCelular%60+'min':'')+'/dia', avgCelular<=180?'cl-norm':avgCelular<=300?'cl-atenc':'cl-crit', avgCelular<=180?'Controlado':avgCelular<=300?'Moderado':'Elevado'):''}
      ${row('Ades√£o medicamentosa', remedioN+'/'+diasDados+' dias', pctRemedio>=80?'cl-norm':pctRemedio>=60?'cl-atenc':'cl-crit', pctRemedio>=80?'Boa':pctRemedio>=60?'Moderada':'Baixa')}
      ${reativarTotal>0?row('Ativa√ß√µes de protocolo de foco', reativarTotal+'x em '+Object.keys(diasReativar).length+' dias', reativarTotal<=5?'cl-norm':reativarTotal<=15?'cl-atenc':'cl-crit', reativarTotal<=5?'Ocasional':reativarTotal<=15?'Frequente':'Intenso'):''}
      ${leituraN>0?row('Leitura acumulada', leituraTotal+' p√°ginas em '+leituraN+' dias', 'cl-norm', 'Registrada'):''}
    </div>
  </div>

  <!-- Gr√°fico sono -->
  ${sonoN>0?`<div class="clinico-wrap">
    <div class="clinico-secao">
      <div class="clinico-secao-titulo">üò¥ Evolu√ß√£o do Sono ‚Äî √∫ltimas 2 semanas</div>
      <div class="clinico-grafico">${grafSono}</div>
      <div style="display:flex;gap:12px;font-size:0.65rem;color:#90A4AE;margin-top:4px;">
        <span>üü¢ ‚â•7h adequado</span><span>üü† 6-7h aten√ß√£o</span><span>üî¥ &lt;6h cr√≠tico</span>
      </div>
      <div style="height:1px;background:#EEF2F7;margin:12px 0;"></div>
      <div class="clinico-secao-titulo">üèîÔ∏è Foco di√°rio ‚Äî √∫ltimas 2 semanas</div>
      <div class="clinico-grafico">${grafFoco}</div>
      <div style="font-size:0.65rem;color:#90A4AE;margin-top:4px;">üü£ ‚â•60min adequado ¬∑ üîµ 30-60min moderado</div>
    </div>
  </div>`:''}

  <!-- Parecer cl√≠nico detalhado -->
  <div class="clinico-wrap">
    <div class="clinico-secao">
      <div class="clinico-secao-titulo">üìù An√°lise Cl√≠nica Detalhada</div>

      <div style="margin-bottom:14px;">
        <div style="font-size:0.78rem;font-weight:700;color:#1565C0;margin-bottom:6px;">üò¥ Sono e Recupera√ß√£o Neurol√≥gica</div>
        <div style="font-size:0.83rem;color:#37474F;line-height:1.7;">${parecerSono()}</div>
      </div>

      <div style="margin-bottom:14px;">
        <div style="font-size:0.78rem;font-weight:700;color:#2E7D32;margin-bottom:6px;">üéØ Fun√ß√£o Executiva e Planejamento</div>
        <div style="font-size:0.83rem;color:#37474F;line-height:1.7;">${parecerMetas()}</div>
      </div>

      <div style="margin-bottom:14px;">
        <div style="font-size:0.78rem;font-weight:700;color:#7C3AED;margin-bottom:6px;">üèîÔ∏è Aten√ß√£o Sustentada e Foco</div>
        <div style="font-size:0.83rem;color:#37474F;line-height:1.7;">${parecerFoco()}</div>
      </div>

      <div style="margin-bottom:14px;">
        <div style="font-size:0.78rem;font-weight:700;color:#1565C0;margin-bottom:6px;">üíä Ades√£o ao Tratamento Farmacol√≥gico</div>
        <div style="font-size:0.83rem;color:#37474F;line-height:1.7;">${parecerMedicacao()}</div>
      </div>

      ${avgCelular!==null?`<div style="margin-bottom:14px;">
        <div style="font-size:0.78rem;font-weight:700;color:#F57F17;margin-bottom:6px;">üì± Regula√ß√£o do Uso de Tecnologia</div>
        <div style="font-size:0.83rem;color:#37474F;line-height:1.7;">${parecerTela()}</div>
      </div>`:''}

      ${reativarTotal>0?`<div style="margin-bottom:4px;">
        <div style="font-size:0.78rem;font-weight:700;color:#E65100;margin-bottom:6px;">‚ö° Uso do Protocolo de Reativa√ß√£o de Foco</div>
        <div style="font-size:0.83rem;color:#37474F;line-height:1.7;">Protocolo ativado <strong>${reativarTotal}x</strong> em ${Object.keys(diasReativar).length} dias. ${reativarTotal<=5?'Uso espor√°dico, dentro do esperado.':reativarTotal<=15?'Frequ√™ncia moderada de epis√≥dios de bloqueio cognitivo ‚Äî padr√£o caracter√≠stico do TDAH.':'Frequ√™ncia elevada de ativa√ß√µes ‚Äî pode indicar per√≠odo de maior desregula√ß√£o atencional. Recomenda-se discuss√£o na consulta.'}</div>
      </div>`:''}
    </div>
  </div>

  <!-- Score e conclus√£o -->
  <div class="clinico-wrap">
    <div class="clinico-secao">
      <div class="clinico-secao-titulo">‚≠ê Avalia√ß√£o Geral do Per√≠odo</div>
      <div style="display:flex;align-items:center;gap:16px;padding:8px 0;">
        <div style="width:64px;height:64px;border-radius:50%;background:${scoreCor};display:flex;align-items:center;justify-content:center;color:white;font-size:1.3rem;font-weight:900;flex-shrink:0;">${scoreGeral}</div>
        <div>
          <div style="font-size:0.9rem;font-weight:700;color:#1A237E;">${scoreLabel}</div>
          <div style="font-size:0.78rem;color:#546E7A;margin-top:4px;line-height:1.5;">Score calculado a partir de sono, metas, foco, tela e medica√ß√£o</div>
        </div>
      </div>
    </div>
  </div>

  <div class="clinico-aviso">‚ö†Ô∏è <strong>Importante:</strong> Este relat√≥rio √© gerado automaticamente a partir de dados autodeclarados. N√£o substitui avalia√ß√£o cl√≠nica profissional. Compartilhe com seu m√©dico ou psic√≥logo como material de apoio √† consulta.</div>
  `;
}
function renderCalendar(date){
  const yr=date.getFullYear(),mo=date.getMonth();document.getElementById('current-month-year').textContent=date.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  const firstDay=new Date(yr,mo,1).getDay();const daysInMonth=new Date(yr,mo+1,0).getDate();const prevLast=new Date(yr,mo,0).getDate();let html='';
  for(let i=firstDay-1;i>=0;i--)html+=`<div class="calendar-day inactive">${prevLast-i}</div>`;
  for(let i=1;i<=daysInMonth;i++){const d=new Date(yr,mo,i);const iso=hojeISO(d);const isToday=iso===hojeISO();const isSel=iso===state.currentDate&&state.currentDate!==hojeISO();const dd=state.dailyData[iso];let met='';
    if(dd){const s=dd.sono&&dd.sono.length>0?dd.sono[0].horas:null;const mTot=(dd.metas||[]).length+(dd.metasFixas||[]).length;const mDone=(dd.metas||[]).filter(m=>m.done).length+(dd.metasFixas||[]).filter(m=>m.done).length;const pf=dd.pom?dd.pom.minFoco:0;if(s)met+=`<span class="${s>=7?'m-ok':s>=5?'m-warn':'m-bad'}">üò¥${s}h</span>`;if(mTot>0)met+=`<span class="${mDone/mTot>=0.8?'m-ok':mDone/mTot>=0.5?'m-warn':'m-bad'}">‚úÖ${mDone}/${mTot}</span>`;if(pf>0)met+=`<span class="${pf>=40?'m-ok':'m-warn'}">üèîÔ∏è${pf}m</span>`;}
    html+=`<div class="calendar-day${isToday?' today':''}${isSel?' selected':''}" onclick="selectDay('${iso}',this)">${i}${met?`<div class="calendar-day-metrics">${met}</div>`:''}</div>`;}
  const rem=42-(firstDay+daysInMonth);for(let i=1;i<=rem;i++)html+=`<div class="calendar-day inactive">${i}</div>`;
  document.getElementById('calendar-grid-days').innerHTML=html;
}
function changeMonth(d){currentCalendarDate.setMonth(currentCalendarDate.getMonth()+d);renderCalendar(currentCalendarDate);}
function selectDay(iso,el){document.querySelectorAll('.calendar-day').forEach(d=>d.classList.remove('selected'));el.classList.add('selected');carregarDia(iso);mostrarSumarioDia(iso);}
function mostrarSumarioDia(iso){
  const card=document.getElementById('daily-summary-card');const dd=state.dailyData[iso];const dataFmt=new Date(iso+'T12:00:00').toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  if(!dd){card.innerHTML=`<div class="daily-sum-card"><div class="card-title">Sum√°rio ‚Äî ${dataFmt}</div><p style="color:var(--text-light);font-size:0.85rem;text-align:center;padding:10px;">Nenhum dado registrado.</p></div>`;card.style.display='block';return;}
  const qM={otima:'üòä √ìtima',boa:'üôÇ Boa',regular:'üòê Regular',ruim:'üòî Ruim',pessima:'üò´ P√©ssima'};let html=`<div class="daily-sum-card"><div class="card-title">Sum√°rio ‚Äî ${dataFmt}</div>`;
  const s=dd.sono&&dd.sono.length>0?dd.sono[0]:null;if(s)html+=`<div class="rel-section" style="border-color:#1565C0"><h3>üò¥ Sono</h3><div class="rel-row"><span>Horas</span><span class="rv">${s.horas}h</span></div><div class="rel-row"><span>Qualidade</span><span class="rv">${qM[s.qualidade]}</span></div></div>`;
  const mAll=[...(dd.metasFixas||[]),...(dd.metas||[])];if(mAll.length>0){const dn=mAll.filter(m=>m.done).length;html+=`<div class="rel-section" style="border-color:#2E7D32"><h3>üéØ Metas</h3><div class="rel-row"><span>Conclu√≠das</span><span class="rv">${dn}/${mAll.length}</span></div>${mAll.map(m=>`<div class="rel-row"><span>${m.tipo==='fixa'?'üìå ':''}${m.texto}</span><span class="rv">${m.done?'‚úÖ':'‚¨ú'}</span></div>`).join('')}</div>`;}
  if(dd.pom&&(dd.pom.sessoes>0||dd.pom.ciclos>0))html+=`<div class="rel-section" style="border-color:#7C3AED"><h3>üèîÔ∏è Caverna</h3><div class="rel-row"><span>Sess√µes</span><span class="rv">${dd.pom.sessoes}</span></div><div class="rel-row"><span>Foco total</span><span class="rv">${dd.pom.minFoco}min</span></div></div>`;
  if(dd.celular)html+=`<div class="rel-section" style="border-color:#F57F17"><h3>üì± Tela</h3><div class="rel-row"><span>Tempo</span><span class="rv">${dd.celular.horas}h ${dd.celular.minutos}min</span></div></div>`;
  if(dd.leitura)html+=`<div class="rel-section" style="border-color:#6A1B9A"><h3>üìö Leitura</h3><div class="rel-row"><span>P√°ginas</span><span class="rv">${dd.leitura.paginas}</span></div></div>`;
  html+='</div>';card.innerHTML=html;card.style.display='block';
}
function switchInfo(tab,btn){
  document.querySelectorAll('.info-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.info-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('info-'+tab).classList.add('active');
  btn.classList.add('active');
  if(tab==='relatorios') gerarRelatorioMensal();
}

function switchRelSubtab(tab) {
  document.getElementById('relatorio-diario-inline').style.display = tab==='diario'?'block':'none';
  document.getElementById('relatorio-mensal-inline').style.display = tab==='mensal'?'block':'none';
  document.getElementById('subtab-diario').className = 'rel-subtab diario'+(tab==='diario'?' active':'');
  document.getElementById('subtab-mensal').className = 'rel-subtab mensal'+(tab==='mensal'?' active':'');
  if(tab==='mensal') gerarRelatorioMensal();
}

function gerarRelatorioDiarioInline() {
  // Reutiliza toda a l√≥gica existente de abrirRelatorio mas coloca inline
  const now=new Date();
  const conteudo=document.getElementById('relatorio-body');
  // Gera o relatorio no modal mas captura o HTML
  abrirRelatorio();
  // Copia pro inline depois de gerado
  setTimeout(()=>{
    const htmlGerado = document.getElementById('relatorio-body').innerHTML;
    const diaStr = now.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
    document.getElementById('relatorio-diario-conteudo').innerHTML =
      `<div style="margin-top:16px;">
        <div style="font-size:0.72rem;color:#90A4AE;margin-bottom:12px;">üìÖ ${diaStr}</div>
        ${htmlGerado}
        <button onclick="document.getElementById('relatorio-diario-conteudo').innerHTML='';document.querySelector('.rel-subtabs').previousElementSibling&&document.getElementById('relatorio-diario-inline').querySelector('div').style.display='block'" style="width:100%;padding:12px;background:#EEF2FF;border:1px solid #C5CAE9;border-radius:12px;font-size:0.85rem;font-weight:700;color:#1A237E;cursor:pointer;margin-top:12px;">üîÑ Atualizar</button>
      </div>`;
    document.getElementById('relatorio-modal').classList.remove('show');
  }, 50);
}

// ========== BACKUP & SINCRONIZA√á√ÉO ==========
let _importData = null;

function abrirBackup() {
  atualizarStatsBackup();
  document.getElementById('backup-modal').classList.add('show');
  document.getElementById('backup-ping').classList.remove('show');
}
function fecharBackupModal(e) { if(e.target.id==='backup-modal') document.getElementById('backup-modal').classList.remove('show'); }
function atualizarStatsBackup() {
  const dias=Object.keys(state.dailyData).length;
  const totalMetas=state.metasHist.reduce((a,h)=>a+h.total,0)+state.metas.length+state.metasFixas.length;
  const raw=localStorage.getItem('tdah_daily')||'';
  const size=new Blob([raw]).size;const sizeStr=size>1024?(size/1024).toFixed(1)+'kb':size+'b';
  document.getElementById('bk-dias').textContent=dias;document.getElementById('bk-metas').textContent=totalMetas;document.getElementById('bk-size').textContent=sizeStr;
  const lastBackup=localStorage.getItem('tdah_last_backup');const lbEl=document.getElementById('backup-last-export');
  if(lastBackup){const d=new Date(lastBackup);const diff=Math.floor((Date.now()-d)/86400000);const txt=diff===0?'hoje':diff===1?'ontem':'h√° '+diff+' dias';lbEl.className='backup-last-info'+(diff>7?' warn':'');lbEl.textContent=(diff>7?'‚ö†Ô∏è':'‚úÖ')+' √öltimo backup: '+txt+' ('+d.toLocaleDateString('pt-BR')+')';}
  else{lbEl.className='backup-last-info none';lbEl.textContent='üìÅ Nenhum backup exportado ainda';}
  const rem=localStorage.getItem('tdah_backup_reminder')==='true';const tog=document.getElementById('backup-reminder-toggle');if(tog)tog.className='toggle-switch'+(rem?' on':'');
}
function gerarBackupJSON() {
  return JSON.stringify({version:'1.0',app:'TDAH Care',exportDate:new Date().toISOString(),data:{dailyData:state.dailyData,metasHist:state.metasHist,metasFixas:state.metasFixas}},null,2);
}
function exportarJSON() {
  const prog=document.getElementById('export-progress'),fill=document.getElementById('export-progress-fill');
  prog.classList.add('show');let w=0;const iv=setInterval(()=>{w+=20;fill.style.width=w+'%';if(w>=100){clearInterval(iv);setTimeout(()=>{prog.classList.remove('show');fill.style.width='0%';},500);}},60);
  const json=gerarBackupJSON();const blob=new Blob([json],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');
  const date=new Date().toISOString().split('T')[0];a.href=url;a.download='tdah-care-backup-'+date+'.json';a.click();URL.revokeObjectURL(url);
  localStorage.setItem('tdah_last_backup',new Date().toISOString());atualizarStatsBackup();showToast('‚úÖ Backup exportado com sucesso!');
}
async function copiarBackupClipboard() {
  const json=gerarBackupJSON();
  try{await navigator.clipboard.writeText(json);showToast('üìã Backup copiado para √°rea de transfer√™ncia!');}
  catch(e){const ta=document.createElement('textarea');ta.value=json;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);showToast('üìã Backup copiado!');}
  localStorage.setItem('tdah_last_backup',new Date().toISOString());atualizarStatsBackup();
}
async function compartilharBackup() {
  const json=gerarBackupJSON();const date=new Date().toISOString().split('T')[0];const file=new File([json],'tdah-care-backup-'+date+'.json',{type:'application/json'});
  if(navigator.share&&navigator.canShare&&navigator.canShare({files:[file]})){try{await navigator.share({files:[file],title:'Backup TDAH Care',text:'Meu backup do TDAH Care'});localStorage.setItem('tdah_last_backup',new Date().toISOString());atualizarStatsBackup();showToast('‚úÖ Backup compartilhado!');}catch(e){if(e.name!=='AbortError')exportarJSON();}}
  else exportarJSON();
}
function toggleBackupReminder() {
  const tog=document.getElementById('backup-reminder-toggle');const atual=tog.classList.contains('on');tog.className='toggle-switch'+(atual?'':' on');localStorage.setItem('tdah_backup_reminder',!atual);showToast(!atual?'üîî Lembrete de backup ativado!':'üîï Lembrete desativado');
}
function verificarLembreteBackup() {
  const rem=localStorage.getItem('tdah_backup_reminder')==='true';if(!rem)return;
  const last=localStorage.getItem('tdah_last_backup');if(!last){document.getElementById('backup-ping').classList.add('show');return;}
  const diff=Math.floor((Date.now()-new Date(last))/86400000);if(diff>=7)document.getElementById('backup-ping').classList.add('show');
}
function handleDragOver(e){e.preventDefault();document.getElementById('import-drop').classList.add('dragover');}
function handleDragLeave(e){document.getElementById('import-drop').classList.remove('dragover');}
function handleDrop(e){e.preventDefault();document.getElementById('import-drop').classList.remove('dragover');const file=e.dataTransfer.files[0];if(file)processarArquivo(file);}
function handleFileSelect(e){const file=e.target.files[0];if(file)processarArquivo(file);}
function processarArquivo(file){
  if(!file.name.endsWith('.json')){showToast('‚ö†Ô∏è Selecione um arquivo .json v√°lido');return;}
  const reader=new FileReader();reader.onload=(e)=>{try{const d=JSON.parse(e.target.result);validarEPrevisualizarBackup(d);}catch(err){showToast('‚ùå Arquivo inv√°lido ou corrompido');}};reader.readAsText(file);
}
function importarDoPaste(){
  const txt=document.getElementById('import-paste-input').value.trim();if(!txt){showToast('‚ö†Ô∏è Cole o backup no campo acima');return;}
  try{const d=JSON.parse(txt);validarEPrevisualizarBackup(d);}catch(e){showToast('‚ùå Texto inv√°lido ‚Äî verifique se √© um backup correto');}
}
function validarEPrevisualizarBackup(data){
  if(!data.app||data.app!=='TDAH Care'||!data.data){showToast('‚ùå Este arquivo n√£o √© um backup do TDAH Care');return;}
  _importData=data;const dias=Object.keys(data.data.dailyData||{}).length;const metas=(data.data.metasHist||[]).length;const datas=Object.keys(data.data.dailyData||{}).sort();
  const ultimo=datas.length>0?new Date(datas[datas.length-1]+'T12:00:00').toLocaleDateString('pt-BR'):'‚Äî';const expDate=new Date(data.exportDate).toLocaleDateString('pt-BR');
  document.getElementById('ip-dias').textContent=dias+' dias';document.getElementById('ip-ultimo').textContent=ultimo;document.getElementById('ip-metas').textContent=metas+' entradas';
  document.getElementById('import-preview').style.display='block';document.getElementById('import-confirm-row').style.display='flex';document.getElementById('import-paste-area').style.display='none';
  showToast('‚úÖ Backup de '+expDate+' carregado!');
}
function cancelarImport(){
  _importData=null;document.getElementById('import-preview').style.display='none';document.getElementById('import-confirm-row').style.display='none';
  document.getElementById('import-paste-area').style.display='block';document.getElementById('import-paste-input').value='';document.getElementById('import-file-input').value='';
}
function confirmarImport(){
  if(!_importData)return;const d=_importData.data;
  try{if(d.dailyData)localStorage.setItem('tdah_daily',JSON.stringify(d.dailyData));if(d.metasHist)localStorage.setItem('tdah_mhist',JSON.stringify(d.metasHist));if(d.metasFixas)localStorage.setItem('tdah_fixas',JSON.stringify(d.metasFixas));document.getElementById('backup-modal').classList.remove('show');showToast('‚úÖ Dados restaurados! Recarregando...');setTimeout(()=>location.reload(),1500);}
  catch(e){showToast('‚ùå Erro ao restaurar os dados');}
}
// ========== FIM BACKUP ==========


// ========== POMODORO EDIT√ÅVEL ==========
function aplicarConfigPom() {
  if (state.pom.rodando) { showToast('‚ö†Ô∏è Pare o timer antes de alterar!'); return; }
  const f = parseInt(document.getElementById('pom-foco-input').value) || 20;
  const p = parseInt(document.getElementById('pom-pausa-input').value) || 5;
  const focoMin = Math.min(90, Math.max(1, f));
  const pausaMin = Math.min(30, Math.max(1, p));
  document.getElementById('pom-foco-input').value = focoMin;
  document.getElementById('pom-pausa-input').value = pausaMin;
  // Atualiza as constantes din√¢micas
  state.pomConfig = { foco: focoMin * 60, pausa: pausaMin * 60 };
  state.pom.seg = state.pom.fase === 'foco' ? state.pomConfig.foco : state.pomConfig.pausa;
  document.getElementById('caverna-subtitle').textContent = `Pomodoro ${focoMin}min foco / ${pausaMin}min pausa`;
  atualizarUIPom();
  showToast(`‚úÖ ${focoMin}min foco / ${pausaMin}min pausa aplicado!`);
  // Salva config
  try { localStorage.setItem('tdah_pom_config', JSON.stringify({foco: focoMin, pausa: pausaMin})); } catch(e) {}
}

function carregarConfigPom() {
  try {
    const c = localStorage.getItem('tdah_pom_config');
    if (c) {
      const cfg = JSON.parse(c);
      document.getElementById('pom-foco-input').value = cfg.foco || 20;
      document.getElementById('pom-pausa-input').value = cfg.pausa || 5;
      state.pomConfig = { foco: (cfg.foco||20)*60, pausa: (cfg.pausa||5)*60 };
      document.getElementById('caverna-subtitle').textContent = `Pomodoro ${cfg.foco||20}min foco / ${cfg.pausa||5}min pausa`;
    } else {
      state.pomConfig = { foco: POM_FOCO, pausa: POM_PAUSA };
    }
  } catch(e) { state.pomConfig = { foco: POM_FOCO, pausa: POM_PAUSA }; }
}

// Override das fun√ß√µes que usam POM_FOCO/POM_PAUSA para usar pomConfig
function getPomFoco() { return state.pomConfig ? state.pomConfig.foco : POM_FOCO; }
function getPomPausa() { return state.pomConfig ? state.pomConfig.pausa : POM_PAUSA; }

// ========== COMPARTILHAR PROGRESSO ==========

function verificarLembreteSexta() {
  const hoje = new Date();
  const diaSemana = hoje.getDay(); // 5 = sexta
  const banner = document.getElementById('lembrete-sexta');
  if (banner) banner.style.display = diaSemana === 5 ? 'block' : 'none';
}

function fecharCompartilharModal(e) {
  if (e.target.id === 'compartilhar-modal') document.getElementById('compartilhar-modal').classList.remove('show');
}

function switchCompTab(tab, btn) {
  document.querySelectorAll('.comp-tab-content').forEach(c => c.style.display = 'none');
  document.querySelectorAll('.comp-tab').forEach(b => b.classList.remove('active'));
  document.getElementById('comp-' + tab).style.display = 'block';
  btn.classList.add('active');
}

function calcularDadosSemana() {
  const hoje = new Date();
  let sonoTotal=0,sonoN=0,metasConcl=0,metasTotal=0,focoTotal=0,celTotal=0,celN=0,remedioN=0,diasDados=0,reativarN=0;
  const dataInicio = new Date(hoje); dataInicio.setDate(hoje.getDate()-6);

  for (let i=0; i<7; i++) {
    const d = new Date(hoje); d.setDate(hoje.getDate()-i);
    const iso = hojeISO(d); const dd = state.dailyData[iso];
    if (!dd) continue; diasDados++;
    if (dd.sono&&dd.sono.length>0) { sonoTotal+=dd.sono[0].horas; sonoN++; }
    const allM=[...(dd.metas||[]),...(dd.metasFixas||[])];
    if (allM.length>0) { metasConcl+=allM.filter(m=>m.done).length; metasTotal+=allM.length; }
    if (dd.pom&&dd.pom.minFoco>0) focoTotal+=dd.pom.minFoco;
    if (dd.celular) { celTotal+=dd.celular.horas*60+dd.celular.minutos; celN++; }
    if (dd.remedio) remedioN++;
    if (dd.reativarFoco) reativarN+=dd.reativarFoco.length;
  }

  const fmtData = d => d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'});
  return {
    diasDados, sonoMedia: sonoN>0?(sonoTotal/sonoN).toFixed(1):null,
    metasPct: metasTotal>0?Math.round((metasConcl/metasTotal)*100):null,
    metasConcl, metasTotal,
    focoTotal, focoH: Math.floor(focoTotal/60), focoM: focoTotal%60,
    celMedia: celN>0?Math.round(celTotal/celN):null,
    remedioN, reativarN,
    periodo: fmtData(dataInicio)+' a '+fmtData(hoje),
    scoreGeral: calcularScoreSemana({sonoMedia:sonoN>0?(sonoTotal/sonoN):null, metasPct:metasTotal>0?Math.round((metasConcl/metasTotal)*100):null, focoTotal, celMedia:celN>0?Math.round(celTotal/celN):null})
  };
}

function calcularScoreSemana(d) {
  let pts=0, max=0;
  if (d.sonoMedia!==null) { max+=25; pts+=d.sonoMedia>=7?25:d.sonoMedia>=6?15:5; }
  if (d.metasPct!==null) { max+=30; pts+=Math.round((d.metasPct/100)*30); }
  if (d.focoTotal>0) { max+=25; pts+=Math.min(25,Math.round((d.focoTotal/280)*25)); }
  if (d.celMedia!==null) { max+=20; pts+=d.celMedia<=120?20:d.celMedia<=240?10:0; }
  return max>0?Math.round((pts/max)*100):0;
}

function abrirCompartilhar() {
  const dados = calcularDadosSemana();
  preencherWrappedCard(dados);
  preencherTexto(dados);
  preencherPDFInfo(dados);
  document.getElementById('compartilhar-modal').classList.add('show');
  switchCompTab('visual', document.querySelector('.comp-tab'));
}

function preencherWrappedCard(d) {
  const score = d.scoreGeral;
  const emoji = score>=80?'üèÜ':score>=60?'‚≠ê':score>=40?'üí™':'üå±';
  document.getElementById('wc-periodo').textContent = d.periodo;
  document.getElementById('wc-score').textContent = emoji+' '+score;

  if (d.sonoMedia) {
    document.getElementById('wc-sono').textContent = d.sonoMedia+'h';
    document.getElementById('wc-sono-bar').style.width = Math.min(100,(d.sonoMedia/9)*100)+'%';
  } else { document.getElementById('wc-sono').textContent = '‚Äî'; }

  if (d.metasPct!==null) {
    document.getElementById('wc-metas').textContent = d.metasPct+'%';
    document.getElementById('wc-metas-bar').style.width = d.metasPct+'%';
  } else { document.getElementById('wc-metas').textContent = '‚Äî'; }

  if (d.focoTotal>0) {
    document.getElementById('wc-foco').textContent = d.focoH>0?d.focoH+'h'+d.focoM+'m':d.focoTotal+'min';
    document.getElementById('wc-foco-bar').style.width = Math.min(100,(d.focoTotal/300)*100)+'%';
  } else { document.getElementById('wc-foco').textContent = '‚Äî'; }

  if (d.celMedia!==null) {
    const ch=Math.floor(d.celMedia/60),cm=d.celMedia%60;
    document.getElementById('wc-tela').textContent = ch+'h'+(cm>0?cm+'m':'');
    document.getElementById('wc-tela-bar').style.width = Math.max(0,100-Math.min(100,(d.celMedia/360)*100))+'%';
  } else { document.getElementById('wc-tela').textContent = '‚Äî'; }

  // Destaque
  let destaque = '';
  if (d.sonoMedia>=7.5) destaque = 'üò¥ Sono excelente ‚Äî m√©dia de '+d.sonoMedia+'h!';
  else if (d.metasPct>=80) destaque = '‚úÖ '+d.metasPct+'% das metas conclu√≠das!';
  else if (d.focoTotal>=120) destaque = 'üèîÔ∏è '+d.focoH+'h'+d.focoM+'min de foco esta semana!';
  else if (d.remedioN>=5) destaque = 'üíä Medica√ß√£o tomada '+d.remedioN+' de 7 dias!';
  else if (d.reativarN>0) destaque = '‚ö° Reativei o foco '+d.reativarN+'x e segui em frente!';
  else destaque = 'üìà '+d.diasDados+' dias de dados registrados esta semana!';
  document.getElementById('wc-destaque').textContent = destaque;
}

function preencherTexto(d) {
  const score = d.scoreGeral;
  const emoji = score>=80?'üèÜ':score>=60?'‚≠ê':score>=40?'üí™':'üå±';
  const hoje = new Date().toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'});
  let txt = `üìä Progresso Semanal ‚Äî TDAH Care
${d.periodo}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${emoji} Score da semana: ${score}/100

`;
  if (d.sonoMedia) txt += `üò¥ Sono m√©dio: ${d.sonoMedia}h ${d.sonoMedia>=7?'‚úÖ':'‚ö†Ô∏è'}\n`;
  if (d.metasPct!==null) txt += `‚úÖ Metas: ${d.metasConcl}/${d.metasTotal} (${d.metasPct}%) ${d.metasPct>=70?'‚úÖ':'‚ö†Ô∏è'}\n`;
  if (d.focoTotal>0) txt += `üèîÔ∏è Foco total: ${d.focoH>0?d.focoH+'h ':''  }${d.focoM>0?d.focoM+'min':''}\n`;
  if (d.celMedia!==null) { const ch=Math.floor(d.celMedia/60),cm=d.celMedia%60; txt += `üì± Tela m√©dia: ${ch}h${cm>0?cm+'min':''}/dia ${d.celMedia<=180?'‚úÖ':'‚ö†Ô∏è'}\n`; }
  if (d.remedioN>0) txt += `üíä Medica√ß√£o: ${d.remedioN}/7 dias\n`;
  if (d.reativarN>0) txt += `‚ö° Reativei o foco: ${d.reativarN}x\n`;
  txt += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüì± Gerado pelo TDAH Care`;
  document.getElementById('texto-progresso').textContent = txt;
}

function preencherPDFInfo(d) {
  const el = document.getElementById('pdf-preview-info');
  const score = d.scoreGeral;
  el.innerHTML = `
    <div style="font-weight:700;margin-bottom:8px;">üìã O PDF incluir√°:</div>
    <div>‚Ä¢ Score geral da semana: <strong>${score}/100</strong></div>
    ${d.sonoMedia?`<div>‚Ä¢ M√©dia de sono: <strong>${d.sonoMedia}h</strong></div>`:''}
    ${d.metasPct!==null?`<div>‚Ä¢ Taxa de metas: <strong>${d.metasPct}%</strong></div>`:''}
    ${d.focoTotal>0?`<div>‚Ä¢ Tempo de foco: <strong>${d.focoH>0?d.focoH+'h':''} ${d.focoM>0?d.focoM+'min':''}</strong></div>`:''}
    ${d.reativarN>0?`<div>‚Ä¢ Ativa√ß√µes de foco: <strong>${d.reativarN}x</strong></div>`:''}
    <div style="margin-top:8px;font-size:0.75rem;color:#546E7A;">Per√≠odo: ${d.periodo}</div>
  `;
}

async function compartilharWhatsApp() {
  const dados = calcularDadosSemana();
  const score = dados.scoreGeral;
  const emoji = score>=80?'üèÜ':score>=60?'‚≠ê':score>=40?'üí™':'üå±';
  let txt = `üìä *Progresso Semanal ‚Äî TDAH Care*\n_${dados.periodo}_\n\n${emoji} *Score: ${score}/100*\n\n`;
  if (dados.sonoMedia) txt += `üò¥ Sono m√©dio: *${dados.sonoMedia}h*\n`;
  if (dados.metasPct!==null) txt += `‚úÖ Metas: *${dados.metasPct}%* (${dados.metasConcl}/${dados.metasTotal})\n`;
  if (dados.focoTotal>0) txt += `üèîÔ∏è Foco: *${dados.focoH>0?dados.focoH+'h ':'' }${dados.focoM>0?dados.focoM+'min':''}*\n`;
  if (dados.celMedia!==null) { const ch=Math.floor(dados.celMedia/60),cm=dados.celMedia%60; txt += `üì± Tela: *${ch}h${cm>0?cm+'min':''}/dia*\n`; }
  if (dados.reativarN>0) txt += `‚ö° Reativei o foco: *${dados.reativarN}x*\n`;
  txt += `\n_Gerado pelo TDAH Care_ üì±`;
  const url = 'https://wa.me/?text='+encodeURIComponent(txt);
  window.open(url, '_blank');
}

async function enviarTextoWhatsApp() {
  const txt = document.getElementById('texto-progresso').textContent;
  const url = 'https://wa.me/?text='+encodeURIComponent(txt);
  window.open(url, '_blank');
}

async function copiarTexto() {
  const txt = document.getElementById('texto-progresso').textContent;
  try { await navigator.clipboard.writeText(txt); showToast('üìã Texto copiado!'); }
  catch(e) { const ta=document.createElement('textarea');ta.value=txt;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);showToast('üìã Copiado!'); }
}

function tirarPrintCard() {
  showToast('üì∏ Tire um print desta tela para salvar o cart√£o!');
}

function gerarPDFSemanal() {
  const dados = calcularDadosSemana();
  const score = dados.scoreGeral;
  const emoji = score>=80?'üèÜ':score>=60?'‚≠ê':score>=40?'üí™':'üå±';
  const hoje = new Date().toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

  const style_open = '<st'+'yle>';
  const style_close = '</st'+'yle>';
  const head_close = '</he'+'ad>';
  const body_open = '<bo'+'dy>';
  const body_close = '</bo'+'dy>';
  const html_close = '</ht'+'ml>';

  const itens = [
    dados.sonoMedia ? `<div class="item"><div class="val">${dados.sonoMedia}h</div><div class="lbl">üò¥ M√©dia de sono</div></div>` : '',
    dados.metasPct!==null ? `<div class="item"><div class="val">${dados.metasPct}%</div><div class="lbl">‚úÖ Metas (${dados.metasConcl}/${dados.metasTotal})</div></div>` : '',
    dados.focoTotal>0 ? `<div class="item"><div class="val">${dados.focoH>0?dados.focoH+'h ':'' }${dados.focoM>0?dados.focoM+'min':''}</div><div class="lbl">üèîÔ∏è Tempo de foco</div></div>` : '',
    dados.celMedia!==null ? `<div class="item"><div class="val">${Math.floor(dados.celMedia/60)}h${dados.celMedia%60>0?dados.celMedia%60+'min':''}</div><div class="lbl">üì± Tela/dia</div></div>` : '',
    dados.remedioN>0 ? `<div class="item"><div class="val">${dados.remedioN}/7</div><div class="lbl">üíä Medica√ß√£o</div></div>` : '',
    dados.reativarN>0 ? `<div class="item"><div class="val">${dados.reativarN}x</div><div class="lbl">‚ö° Reativa√ß√µes</div></div>` : '',
  ].join('');

  const obs = [
    dados.sonoMedia>=7 ? '‚úÖ Sono dentro dos par√¢metros recomendados (7-9h).' : dados.sonoMedia ? '‚ö†Ô∏è Sono abaixo do ideal ‚Äî pode impactar foco e resposta ao tratamento.' : '',
    dados.metasPct>=70 ? ' ‚úÖ Taxa de conclus√£o de metas satisfat√≥ria.' : dados.metasPct!==null ? ' ‚ö†Ô∏è Taxa de conclus√£o abaixo de 70% ‚Äî considerar estrat√©gias de planejamento.' : '',
    dados.reativarN>0 ? ` ‚ö° Protocolo de reativa√ß√£o necess√°rio ${dados.reativarN}x ‚Äî sinal de oscila√ß√µes de foco.` : '',
  ].join('');

  const conteudo = '<html><head><meta charset="UTF-8">'
    + style_open
    + 'body{font-family:Arial,sans-serif;max-width:600px;margin:0 auto;padding:40px;color:#1A237E;}'
    + '.header{background:linear-gradient(135deg,#1B5E20,#2E7D32);color:white;padding:24px;border-radius:12px;margin-bottom:24px;}'
    + '.header h1{font-size:1.3rem;margin:0 0 4px;} .header p{font-size:0.85rem;opacity:0.9;margin:0;}'
    + '.score-box{text-align:center;background:#F1F8E9;border:2px solid #A5D6A7;border-radius:12px;padding:20px;margin-bottom:20px;}'
    + '.score-num{font-size:3rem;font-weight:900;color:#1B5E20;} .score-label{font-size:0.85rem;color:#388E3C;}'
    + '.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;}'
    + '.item{background:#F8FAFF;border:1px solid #E3EAF2;border-radius:10px;padding:14px;}'
    + '.item .val{font-size:1.3rem;font-weight:800;color:#1565C0;} .item .lbl{font-size:0.75rem;color:#546E7A;margin-top:2px;}'
    + '.parecer{background:#F0F7FF;border-left:4px solid #1565C0;border-radius:0 10px 10px 0;padding:14px;font-size:0.85rem;color:#37474F;line-height:1.6;}'
    + '.footer{text-align:center;font-size:0.72rem;color:#90A4AE;margin-top:24px;padding-top:16px;border-top:1px solid #EEF2F7;}'
    + style_close + head_close + body_open
    + '<div class="header"><h1>üìä Relat√≥rio Semanal ‚Äî TDAH Care</h1><p>Per√≠odo: '+dados.periodo+' ¬∑ Gerado em: '+hoje+'</p></div>'
    + '<div class="score-box"><div class="score-num">'+emoji+' '+score+'</div><div class="score-label">Score geral da semana / 100</div></div>'
    + '<div class="grid">'+itens+'</div>'
    + '<div class="parecer"><strong>üìù Observa√ß√µes autom√°ticas:</strong><br><br>'+obs+'<br><br><em style="font-size:0.78rem;color:#90A4AE;">‚ö†Ô∏è Relat√≥rio autom√°tico ‚Äî n√£o substitui avalia√ß√£o cl√≠nica profissional.</em></div>'
    + '<div class="footer">TDAH Care ¬∑ Relat√≥rio gerado automaticamente ¬∑ '+hoje+'</div>'
    + body_close + html_close;

  const blob = new Blob([conteudo], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const data = new Date().toISOString().split('T')[0];
  a.href = url; a.download = `tdah-care-relatorio-semanal-${data}.html`;
  a.click(); URL.revokeObjectURL(url);
  showToast('üìÑ Relat√≥rio baixado! Abra no navegador e imprima como PDF.');
}

function imprimirRelatorio() {
  gerarPDFSemanal();
}

// ========== FIM COMPARTILHAR ==========

const PROTOCOLOS = {
  1: [ // Travado ‚Äî 5 min
    { icon:'üíß', titulo:'Beba √°gua agora', desc:'Desidrata√ß√£o piora a concentra√ß√£o. Levante, pegue um copo d\'√°gua e beba devagar.', tipo:'timer', duracao:30, label:'segundos' },
    { icon:'üå¨Ô∏è', titulo:'Respira√ß√£o 4-7-8', desc:'Inspire pelo nariz contando 4, segure 7, expire pela boca contando 8. Vamos fazer 1 ciclo.', tipo:'breath', ciclos:1 },
    { icon:'üìµ', titulo:'Feche tudo agora', desc:'Feche todas as abas, apps e notifica√ß√µes. Coloque o celular virado para baixo por 10 minutos.', tipo:'timer', duracao:20, label:'segundos' },
    { icon:'üèîÔ∏è', titulo:'Hora de focar', desc:'Seu c√©rebro est√° pronto. Comece com uma sess√£o curta de foco ‚Äî voc√™ consegue!', tipo:'final' },
  ],
  2: [ // Cabe√ßa Pesada ‚Äî 15 min
    { icon:'üíß', titulo:'Beba √°gua agora', desc:'Desidrata√ß√£o piora muito a concentra√ß√£o. Beba um copo cheio agora.', tipo:'timer', duracao:30, label:'segundos' },
    { icon:'üå¨Ô∏è', titulo:'Respira√ß√£o 4-7-8', desc:'Inspire pelo nariz contando 4, segure 7, expire pela boca contando 8. Vamos fazer 2 ciclos.', tipo:'breath', ciclos:2 },
    { icon:'üßä', titulo:'Gelo nas m√£os', desc:'Segure gelo ou ponha os pulsos em √°gua fria por 30 segundos. O choque t√©rmico ativa o sistema nervoso.', tipo:'timer', duracao:30, label:'segundos' },
    { icon:'üåë', titulo:'Ambiente escuro', desc:'Apague as luzes ou feche as persianas. Fique em sil√™ncio total por 5 minutos. Sem celular.', tipo:'timer', duracao:300, label:'minutos' },
    { icon:'üèîÔ∏è', titulo:'Hora de focar', desc:'Voc√™ fez o necess√°rio. Comece com uma tarefa pequena agora.', tipo:'final' },
  ],
  3: [ // Tela em Branco ‚Äî 30 min
    { icon:'üíß', titulo:'Beba √°gua agora', desc:'Primeiro: levante e beba √°gua. N√£o pule isso ‚Äî √© o reset mais simples que existe.', tipo:'timer', duracao:30, label:'segundos' },
    { icon:'üå¨Ô∏è', titulo:'Respira√ß√£o 4-7-8', desc:'Inspire pelo nariz contando 4, segure 7, expire pela boca contando 8. Vamos fazer 3 ciclos completos.', tipo:'breath', ciclos:3 },
    { icon:'üßä', titulo:'Gelo nas m√£os', desc:'Segure gelo por 1 minuto inteiro. O desconforto f√≠sico interrompe o loop mental e ativa a dopamina.', tipo:'timer', duracao:60, label:'segundos' },
    { icon:'üåë', titulo:'Ambiente escuro e silencioso', desc:'Apague tudo. Dobre sobre voc√™ mesmo ou deite. 10 minutos sem nenhum est√≠mulo. Isso reseta o sistema.', tipo:'timer', duracao:600, label:'minutos' },
    { icon:'üöø', titulo:'Banho frio (se poss√≠vel)', desc:'Se puder, tome 2 minutos de √°gua fria agora. √â o protocolo mais eficaz para reset dopamin√©rgico.', tipo:'timer', duracao:120, label:'segundos' },
    { icon:'üëÅÔ∏è', titulo:'T√©cnica 5-4-3-2-1', desc:'Vamos engajar seus sentidos para ancorar no presente.', tipo:'sentidos' },
    { icon:'üèîÔ∏è', titulo:'Voc√™ est√° pronto', desc:'Seu sistema foi resetado. Comece com a tarefa mais simples que voc√™ tem. Apenas 10 minutos.', tipo:'final' },
  ]
};

const SENTIDOS = [
  { label:'üëÄ 5 coisas que voc√™ V√ä', exemplo:'ex: a janela, a mesa, uma caneta...' },
  { label:'‚úã 4 coisas que voc√™ TOCA', exemplo:'ex: a cadeira, a roupa, o ch√£o...' },
  { label:'üëÇ 3 coisas que voc√™ OUVE', exemplo:'ex: ventilador, carro na rua, sil√™ncio...' },
  { label:'üëÉ 2 coisas que voc√™ CHEIRA', exemplo:'ex: o ambiente, sua roupa...' },
  { label:'üëÖ 1 coisa que voc√™ SABOREIA', exemplo:'ex: o gosto da √°gua, do caf√©...' },
];

let _reativarState = {
  nivel: null, passos: [], passoAtual: 0,
  timerSeg: 0, timerTotal: 0, timerInterval: null,
  breathCiclo: 0, breathTotal: 0, breathFase: null, breathInterval: null,
  sentidoAtual: 0,
};

function abrirReativar() {
  // Reset estado
  _reativarState = { nivel:null, passos:[], passoAtual:0, timerSeg:0, timerTotal:0, timerInterval:null, breathCiclo:0, breathTotal:0, breathFase:null, breathInterval:null, sentidoAtual:0 };
  document.getElementById('reativar-nivel-select').style.display = 'block';
  document.getElementById('protocolo-wrap').classList.remove('show');
  document.getElementById('protocolo-fim').classList.remove('show');
  document.querySelectorAll('.nivel-card').forEach(c => c.classList.remove('selected'));
  document.getElementById('reativar-modal').classList.add('show');
}

function fecharReativarModal(e) {
  if (e.target.id === 'reativar-modal') pararTimersReativar();
}

function pararTimersReativar() {
  if (_reativarState.timerInterval) clearInterval(_reativarState.timerInterval);
  if (_reativarState.breathInterval) clearInterval(_reativarState.breathInterval);
  document.getElementById('reativar-modal').classList.remove('show');
}

function selecionarNivel(n, el) {
  document.querySelectorAll('.nivel-card').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  _reativarState.nivel = n;
  _reativarState.passos = PROTOCOLOS[n];
  _reativarState.passoAtual = 0;

  // Registra uso no estado di√°rio
  if (!state.dailyData[hojeISO()]) state.dailyData[hojeISO()] = {};
  if (!state.dailyData[hojeISO()].reativarFoco) state.dailyData[hojeISO()].reativarFoco = [];
  state.dailyData[hojeISO()].reativarFoco.push({ ts: new Date().toISOString(), nivel: n });
  salvar();

  setTimeout(() => {
    document.getElementById('reativar-nivel-select').style.display = 'none';
    document.getElementById('protocolo-wrap').classList.add('show');
    renderPasso();
  }, 300);
}

function renderPasso() {
  const passos = _reativarState.passos;
  const idx = _reativarState.passoAtual;
  const passo = passos[idx];
  if (!passo) return;

  if (_reativarState.timerInterval) clearInterval(_reativarState.timerInterval);
  if (_reativarState.breathInterval) clearTimeout(_reativarState.breathInterval);
  _reativarState.timerRodando = false;

  const dots = passos.map((_, i) => `<div class="passo-dot ${i<idx?'done':i===idx?'atual':''}"></div>`).join('');
  document.getElementById('passo-progresso').innerHTML = dots;

  document.getElementById('passo-icon').textContent = passo.icon;
  document.getElementById('passo-titulo').textContent = passo.titulo;
  document.getElementById('passo-desc').textContent = passo.desc;

  document.getElementById('passo-timer-wrap').style.display = 'none';
  document.getElementById('breath-container').style.display = 'none';
  document.getElementById('sentidos-container').style.display = 'none';

  const playBtn = document.getElementById('passo-play-btn');
  const nextBtn = document.getElementById('passo-next-btn');

  // Reset bot√µes
  playBtn.style.display = 'none';
  playBtn.className = 'passo-btn passo-btn-play';
  playBtn.textContent = '‚ñ∂ Iniciar';
  nextBtn.style.display = 'flex';
  nextBtn.textContent = 'Feito ‚úì';
  nextBtn.disabled = false;

  if (passo.tipo === 'timer') {
    document.getElementById('passo-timer-wrap').style.display = 'flex';
    _reativarState.timerSeg = passo.duracao;
    _reativarState.timerTotal = passo.duracao;
    _reativarState.timerLabel = passo.label;
    atualizarDisplayTimer();
    playBtn.style.display = 'flex';
    nextBtn.style.display = 'none';

  } else if (passo.tipo === 'breath') {
    document.getElementById('breath-container').style.display = 'block';
    document.getElementById('breath-circle').className = 'breath-circle';
    document.getElementById('breath-circle').textContent = 'Pronto?';
    document.getElementById('breath-instruction').textContent = `${passo.ciclos} ciclo${passo.ciclos>1?'s':''} de respira√ß√£o 4-7-8`;
    _reativarState.breathCicloTotal = passo.ciclos;
    playBtn.style.display = 'flex';
    nextBtn.style.display = 'none';

  } else if (passo.tipo === 'sentidos') {
    document.getElementById('sentidos-container').style.display = 'block';
    _reativarState.sentidoAtual = 0;
    renderSentido();

  } else if (passo.tipo === 'final') {
    nextBtn.textContent = 'Concluir protocolo üéâ';
  }
}

function toggleTimerPasso() {
  const passo = _reativarState.passos[_reativarState.passoAtual];
  const playBtn = document.getElementById('passo-play-btn');

  if (!_reativarState.timerRodando) {
    // Inicia ou retoma
    _reativarState.timerRodando = true;
    playBtn.className = 'passo-btn passo-btn-play tocando';
    playBtn.textContent = '‚è∏ Pausar';

    if (passo.tipo === 'timer') {
      rodarTimerPasso();
    } else if (passo.tipo === 'breath') {
      if (!_reativarState.breathIniciado) {
        _reativarState.breathIniciado = true;
        _reativarState.breathCiclo = 0;
        executarFaseBreath('prepare', _reativarState.breathCicloTotal);
      } else {
        executarFaseBreath(_reativarState.breathFase, _reativarState.breathCicloTotal);
      }
    }
  } else {
    // Pausa
    _reativarState.timerRodando = false;
    playBtn.className = 'passo-btn passo-btn-play';
    playBtn.textContent = '‚ñ∂ Continuar';
    if (_reativarState.timerInterval) clearInterval(_reativarState.timerInterval);
    if (_reativarState.breathInterval) { clearTimeout(_reativarState.breathInterval); _reativarState.breathInterval = null; }
  }
}

function rodarTimerPasso() {
  _reativarState.timerInterval = setInterval(() => {
    if (!_reativarState.timerRodando) { clearInterval(_reativarState.timerInterval); return; }
    _reativarState.timerSeg--;
    atualizarDisplayTimer();
    if (_reativarState.timerSeg <= 0) {
      clearInterval(_reativarState.timerInterval);
      _reativarState.timerRodando = false;
      playBeep();
      // Timer conclu√≠do ‚Äî mostra bot√£o Feito
      document.getElementById('passo-play-btn').style.display = 'none';
      const nextBtn = document.getElementById('passo-next-btn');
      nextBtn.style.display = 'flex';
      nextBtn.textContent = 'Feito ‚úì';
      nextBtn.disabled = false;
    }
  }, 1000);
}

function atualizarDisplayTimer() {
  const seg = _reativarState.timerSeg;
  const total = _reativarState.timerTotal;
  const CIRC_PASSO = 2 * Math.PI * 52;
  const prog = 1 - (seg / total);
  document.getElementById('passo-ring-fill').style.strokeDashoffset = CIRC_PASSO * (1 - prog);
  if (_reativarState.timerLabel === 'minutos') {
    const m = Math.floor(seg/60), s = seg%60;
    document.getElementById('passo-time-display').textContent = pad(m)+':'+pad(s);
    document.getElementById('passo-time-label').textContent = 'restante';
  } else {
    document.getElementById('passo-time-display').textContent = seg;
    document.getElementById('passo-time-label').textContent = 'segundos';
  }
}

function iniciarTimerPasso(duracao, label) {
  // Mantido por compatibilidade ‚Äî agora o fluxo usa toggleTimerPasso/rodarTimerPasso
  _reativarState.timerSeg = duracao;
  _reativarState.timerTotal = duracao;
  _reativarState.timerLabel = label;
  atualizarDisplayTimer();
}

function iniciarRespiracao(totalCiclos) {
  _reativarState.breathCiclo = 0;
  _reativarState.breathTotal = totalCiclos;
  _reativarState.breathIniciado = false;
  executarFaseBreath('prepare', totalCiclos);
}

function executarFaseBreath(fase, totalCiclos) {
  if (!_reativarState.timerRodando) return; // pausado ‚Äî n√£o avan√ßa
  const circle = document.getElementById('breath-circle');
  const instr = document.getElementById('breath-instruction');
  _reativarState.breathFase = fase;

  if (fase === 'prepare') {
    circle.className = 'breath-circle';
    circle.textContent = 'Prepare-se';
    instr.textContent = `Ciclo 1 de ${totalCiclos} ‚Äî Inspire pelo nariz`;
    _reativarState.breathInterval = setTimeout(() => executarFaseBreath('inhale', totalCiclos), 1500);
  } else if (fase === 'inhale') {
    circle.className = 'breath-circle inhale';
    circle.textContent = 'Inspire... 4s';
    instr.textContent = 'üå¨Ô∏è Inspire lentamente pelo nariz';
    _reativarState.breathInterval = setTimeout(() => executarFaseBreath('hold', totalCiclos), 4000);
  } else if (fase === 'hold') {
    circle.className = 'breath-circle hold';
    circle.textContent = 'Segure... 7s';
    instr.textContent = '‚è∏ Segure o ar';
    _reativarState.breathInterval = setTimeout(() => executarFaseBreath('exhale', totalCiclos), 7000);
  } else if (fase === 'exhale') {
    circle.className = 'breath-circle exhale';
    circle.textContent = 'Expire... 8s';
    instr.textContent = 'üí® Expire lentamente pela boca';
    _reativarState.breathInterval = setTimeout(() => {
      _reativarState.breathCiclo++;
      if (_reativarState.breathCiclo < totalCiclos) {
        circle.className = 'breath-circle';
        circle.textContent = `Ciclo ${_reativarState.breathCiclo+1}`;
        instr.textContent = `Ciclo ${_reativarState.breathCiclo+1} de ${totalCiclos}`;
        _reativarState.breathFase = 'inhale';
        _reativarState.breathInterval = setTimeout(() => executarFaseBreath('inhale', totalCiclos), 1000);
      } else {
        circle.className = 'breath-circle';
        circle.textContent = '‚úì Conclu√≠do';
        instr.textContent = '‚úÖ Respira√ß√£o conclu√≠da!';
        _reativarState.timerRodando = false;
        document.getElementById('passo-play-btn').style.display = 'none';
        const nextBtn = document.getElementById('passo-next-btn');
        nextBtn.style.display = 'flex';
        nextBtn.textContent = 'Feito ‚úì';
        nextBtn.disabled = false;
        playBeep();
      }
    }, 8000);
  }
}

function renderSentido() {
  const s = SENTIDOS[_reativarState.sentidoAtual];
  document.getElementById('sentido-atual-label').textContent = s.label;
  document.getElementById('sentido-exemplos').textContent = s.exemplo;
  const restantes = SENTIDOS.length - _reativarState.sentidoAtual;
  document.getElementById('passo-next-btn').textContent = restantes > 1 ? `Pr√≥ximo sentido (${restantes-1} restante${restantes-1>1?'s':''})` : 'Concluir ‚úì';
}

function proximoPasso() {
  const passo = _reativarState.passos[_reativarState.passoAtual];

  // Se √© passo de sentidos, avan√ßa sentido por sentido
  if (passo && passo.tipo === 'sentidos') {
    if (_reativarState.sentidoAtual < SENTIDOS.length - 1) {
      _reativarState.sentidoAtual++;
      renderSentido();
      return;
    }
  }

  // Se √© o passo final
  if (passo && passo.tipo === 'final') {
    finalizarProtocolo();
    return;
  }

  if (_reativarState.timerInterval) clearInterval(_reativarState.timerInterval);
  if (_reativarState.breathInterval) clearTimeout(_reativarState.breathInterval);
  _reativarState.timerRodando = false;
  _reativarState.breathIniciado = false;
  _reativarState.passoAtual++;
  if (_reativarState.passoAtual >= _reativarState.passos.length) {
    mostrarFimProtocolo();
  } else {
    renderPasso();
  }
}

function pularPasso() {
  if (_reativarState.timerInterval) clearInterval(_reativarState.timerInterval);
  if (_reativarState.breathInterval) clearTimeout(_reativarState.breathInterval);
  _reativarState.timerRodando = false;
  _reativarState.breathIniciado = false;
  _reativarState.passoAtual++;
  if (_reativarState.passoAtual >= _reativarState.passos.length) {
    mostrarFimProtocolo();
  } else {
    renderPasso();
  }
}

function mostrarFimProtocolo() {
  document.getElementById('protocolo-wrap').classList.remove('show');
  document.getElementById('protocolo-fim').classList.add('show');
}

function finalizarProtocolo() {
  pararTimersReativar();
  // Vai para o modo caverna
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
  document.getElementById('page-caverna').classList.add('active');
  document.querySelectorAll('.nav-btn')[4].classList.add('active');
  showToast('üèîÔ∏è Modo Caverna ativado! Foco de 10 min!');
  // Aplica pomodoro de 10 min pra reativa√ß√£o
  if (!state.pom.rodando) {
    document.getElementById('pom-foco-input').value = 10;
    document.getElementById('pom-pausa-input').value = 5;
    aplicarConfigPom();
  }
}

// ========== FIM REATIVAR FOCO ==========

init();
carregarConfigPom();
verificarLembreteSexta();
setTimeout(verificarLembreteBackup, 2000);


</script>
</body>
</html>
